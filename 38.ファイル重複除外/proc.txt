/****** Object:  UserDefinedFunction [dbo].[VIEW_IMW]    Script Date: 05/23/2013 16:02:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[VIEW_IMW]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
BEGIN
execute dbo.sp_executesql @statement = N'CREATE FUNCTION [dbo].[VIEW_IMW] (  @authUserCode nvarchar(50),
                            @locale nvarchar(50),
                            @companyCode nvarchar(50),
                            @orgzSetCode nvarchar(50),
                            @orgzCode nvarchar(50),
                            @flowId nvarchar(50)
                         )
RETURNS TABLE
AS
RETURN 
(
     SELECT TMP.user_data_id,
            '''' as matter_number,
            TMP.matter_name as matter_name,
            '''' as system_matter_id,
            TMP.node_id,
            '''' as node_name,
            ''temporary'' as status,
            ''TEMPORARY'' as process_type,
            ''àÍéûï€ë∂'' as process_type_name,
            TMP.update_user_code,
            TMP.update_date,
            TMP.flow_id,
            TMP.flow_version_id,
            TMP.apply_base_date,
            ''0'' as pull_back_flg,
            '''' as pull_back_node_id
       FROM imw_t_temporary_save TMP
      WHERE auth_user_code = @authUserCode
        AND flow_id = @flowId

    UNION ALL

     SELECT ACT.user_data_id,
            ACT.matter_number,
            ACT.matter_name,
            ACT.system_matter_id,
            (case when MSYO.system_matter_id IS NOT NULL then MSYO.node_id
                 when ZUMI.system_matter_id IS NOT NULL then ZUMI.node_id
                 else ''''
                 end) as node_id,
            (case when MSYO.system_matter_id IS NOT NULL then MSYO.node_name
                 when ZUMI.system_matter_id IS NOT NULL then ZUMI.node_name
                 else ''''
                 end) as node_name,
            (case when MSYO.system_matter_id IS NOT NULL then MSYO.status
                 when ZUMI.system_matter_id IS NOT NULL then ZUMI.status
                 else ''''
                 end) as status,
            (case when MSYO.system_matter_id IS NOT NULL and ZUMI.system_matter_id IS NOT NULL then ''UNPROCESS_PROCESSED'' 
                 when MSYO.system_matter_id IS NOT NULL then ''UNPROCESS'' 
                 when ZUMI.system_matter_id IS NOT NULL then ''PROCESSED'' 
                 else ''''
                 end) as process_type,
            (case when MSYO.system_matter_id IS NOT NULL and ZUMI.system_matter_id IS NOT NULL then ''ñ¢èàóù/èàóùçœÇ›'' 
                 when MSYO.system_matter_id IS NOT NULL then ''ñ¢èàóù'' 
                 when ZUMI.system_matter_id IS NOT NULL then ''èàóùçœ'' 
                 else ''''
                 end) as process_type_name,
            ACT.update_user_code,
            ACT.update_date,
            ACT.flow_id,
            ACT.flow_version_id,
            ACT.apply_base_date,
            ISNULL(ZUMI.pull_back_flg, ''0'') as pull_back_flg,
            (case when ISNULL(ZUMI.pull_back_flg, ''0'') = ''1'' then ZUMI.pull_back_node_id else '''' end) as pull_back_node_id
       FROM (
              SELECT * 
               FROM imw_t_actv_matter 
              WHERE flow_id = @flowId) ACT
        LEFT OUTER JOIN
            (
             SELECT USR.system_matter_id,
                    TSK.node_id,
                    TSK.node_name,
                    TSK.status
               FROM
                    (   
                     SELECT 
                            EXE.system_matter_id,
                            EXE.node_id,
                            EXE.auth_user_code,
                            EXE.auth_user_name
                       FROM
                            (SELECT *
                               FROM imw_t_actv_executable_user exuser
                              WHERE locale_id = @locale
                                AND auth_user_code = @authUserCode
                            ) EXE -- ÉÜÅ[ÉUÇ∆àƒåè
                        JOIN
                            (SELECT *
                               FROM imw_t_actv_user_orgz exorgz
                              WHERE locale_id = @locale
                                AND auth_company_code = @companyCode
                                AND auth_orgz_set_code = @orgzSetCode
                                AND auth_orgz_code = @orgzCode
                                AND auth_user_code = @authUserCode
                            ) ORG -- èäëÆÇ∆àƒåè
                                 ON ORG.system_matter_id = EXE.system_matter_id
                                AND ORG.node_id = EXE.node_id
                                AND ORG.auth_user_code = EXE.auth_user_code
                                AND ORG.locale_id = EXE.locale_id
                    ) USR
                    JOIN
                     imw_t_actv_task TSK
                         ON TSK.system_matter_id = USR.system_matter_id
                        AND TSK.node_id = USR.node_id
             ) MSYO -- ñ¢èàóù
                ON MSYO.system_matter_id = ACT.system_matter_id
        LEFT OUTER JOIN
            (
             SELECT MKY.system_matter_id,
                    TSK.node_id as node_id,
                    TSK.node_name as node_name,
                    TSK.status,
                    MKY.pull_back_flg,
                    MKY.pull_back_node_id
               FROM
                    (
                     SELECT MKEY.system_matter_id,
                            PULL.pull_back_flg,
                            PULL.pull_back_node_id
                       FROM
                            (
                             SELECT distinct USR.system_matter_id
                               FROM
                                    (
                                     SELECT *
                                       FROM imw_t_cpl_user 
                                      WHERE locale_id = @locale
                                            AND auth_company_code = @companyCode
                                            AND auth_orgz_set_code = @orgzSetCode
                                            AND auth_orgz_code = @orgzCode
                                            AND execute_user_code = @authUserCode
                                    ) USR
                                INNER JOIN
                                    imw_t_cpl_task TSK
                                         ON TSK.system_matter_id = USR.system_matter_id
                                        AND TSK.task_id = USR.task_id  
                            ) MKEY
                            left outer join
                            (                       
                               
                             SELECT USR.system_matter_id, 
                                    TSK.node_id as pull_back_node_id,
                                    MAX(case when BEF.system_matter_id IS not null then 1 else 0 end) as pull_back_flg
                               FROM
                                    (
                                     SELECT *
                                       FROM imw_t_cpl_user 
                                      WHERE locale_id = @locale
                                            AND auth_company_code = @companyCode
                                            AND auth_orgz_set_code = @orgzSetCode
                                            AND auth_orgz_code = @orgzCode
                                            AND execute_user_code = @authUserCode
                                    ) USR
                                INNER JOIN
                                    imw_t_cpl_task TSK
                                         ON TSK.system_matter_id = USR.system_matter_id
                                        AND TSK.task_id = USR.task_id  
                                LEFT OUTER JOIN
                                    imw_t_before_task BEF
                                         ON BEF.system_matter_id = USR.system_matter_id
                                        AND BEF.before_task_id   = USR.task_id
                                GROUP BY USR.system_matter_id, TSK.node_id
                            ) PULL 
                                ON PULL.pull_back_flg = ''1'' and MKEY.system_matter_id = PULL.system_matter_id
                    ) MKY
                INNER JOIN
                    imw_t_actv_matter_locale LOC
                         ON LOC.system_matter_id = MKY.system_matter_id
                        AND LOC.locale_id = @locale
                INNER JOIN 
                    imw_t_actv_task TSK
                         ON TSK.system_matter_id = MKY.system_matter_id
            ) ZUMI -- èàóùçœÇ›
                ON ZUMI.system_matter_id = ACT.system_matter_id
     WHERE MSYO.system_matter_id IS NOT NULL OR ZUMI.system_matter_id IS NOT NULL

    UNION ALL

     SELECT CPL.user_data_id,
            CPL.matter_number,
            CPL.matter_name,
            CPL.system_matter_id,
            '''' as node_id, 
            '''' as node_name,
            TSK.status as status,
            ''COMPLETED'' as process_type,
            ''äÆóπ'' as process_type_name,
            TSK.execute_user_code as update_user_code,
            CPL.update_date as update_date,
            CPL.flow_id,
            CPL.flow_version_id,
            CPL.apply_base_date,
            ''0'' as pull_back_flg,
            '''' as pull_back_node_id
       FROM
            (
             SELECT USR.system_matter_id,
                    USR.execute_user_code,
                    USR.execute_user_name,
                    TSK.node_name,
                    TSK.status
               FROM
                    (
                     SELECT system_matter_id,
                            execute_user_code,
                            execute_user_name
                       FROM imw_t_cpl_matter_user 
                      WHERE locale_id = @locale
                            AND auth_company_code = @companyCode
                            AND auth_orgz_set_code = @orgzSetCode
                            AND auth_orgz_code = @orgzCode
                            AND execute_user_code = @authUserCode
                        
                      GROUP BY  system_matter_id,
                                execute_user_code,
                                execute_user_name
                    ) USR
                INNER JOIN
                    (
                     SELECT TSK.*
                       FROM imw_t_cpl_matter_task TSK
                        INNER JOIN
                            (
                             SELECT system_matter_id,
                                    MAX(update_date) update_date
                               FROM imw_t_cpl_matter_task 
                               GROUP BY system_matter_id
                            ) UPD
                                ON  UPD.system_matter_id = TSK.system_matter_id
                                AND UPD.update_date = TSK.update_date
                    ) TSK
                        ON  USR.system_matter_id = TSK.system_matter_id
            ) TSK
        INNER JOIN
            (SELECT * 
               FROM imw_t_cpl_matter 
              WHERE flow_id = @flowId) CPL
                ON  CPL.system_matter_id = TSK.system_matter_id
        INNER JOIN
            imw_t_cpl_matter_locale LOC
                ON  LOC.system_matter_id = TSK.system_matter_id
                AND LOC.locale_id = @locale
);
' 
END
GO
/****** Object:  UserDefinedFunction [dbo].[GET_USER_NAME]    Script Date: 05/23/2013 16:02:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[GET_USER_NAME]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
BEGIN
execute dbo.sp_executesql @statement = N'CREATE FUNCTION [dbo].[GET_USER_NAME] 
(
    @userCode nvarchar(100),
    @locale nvarchar(50)
)
RETURNS nvarchar(1000)
AS
BEGIN
    DECLARE @Result nvarchar(1000)
    SELECT @Result = user_name FROM IMM_USER WHERE locale_id = @locale 
           and start_date <= GETDATE() and end_date >= GETDATE() and user_cd = @userCode       
    RETURN @Result
END
' 
END
GO
/****** Object:  UserDefinedFunction [dbo].[GET_DEPARTMENT_NAME]    Script Date: 05/23/2013 16:02:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[GET_DEPARTMENT_NAME]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
BEGIN
execute dbo.sp_executesql @statement = N'CREATE FUNCTION [dbo].[GET_DEPARTMENT_NAME] 
(
    @companyCd nvarchar(100),
    @departmentSetCd nvarchar(100),
    @departmentCd nvarchar(100),
    @locale nvarchar(50)
)
RETURNS nvarchar(1000)
AS
BEGIN
    DECLARE @Result nvarchar(1000)
    SELECT @Result = department_name FROM IMM_DEPARTMENT WHERE locale_id = @locale 
           and start_date <= GETDATE() and end_date >= GETDATE() and company_cd = @companyCd     
           and [department_set_cd] = @departmentSetCd  and department_cd = @departmentCd  
    RETURN @Result
END
' 
END
GO
/****** Object:  UserDefinedFunction [dbo].[SDIF003_SDHM012]    Script Date: 05/23/2013 16:02:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SDIF003_SDHM012]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
BEGIN
execute dbo.sp_executesql @statement = N'
CREATE FUNCTION [dbo].[SDIF003_SDHM012]
(	
  @toYMD as varchar(8)

)
RETURNS TABLE 
AS
RETURN 
(
  	SELECT * 
		FROM INTRA_MART.dbo.SDHM012 A
		WHERE YUKO_STA_YMD <= @toYMD
		  AND A.YUKO_STA_YMD = (
			SELECT MAX(B.YUKO_STA_YMD) 
			FROM INTRA_MART.dbo.SDHM012 B
			WHERE B.YUKO_STA_YMD <= @toYMD
			  AND A.BANK_CD = B.BANK_CD
			  AND A.STEN_CD = B.STEN_CD
		  )
)

' 
END
GO
/****** Object:  StoredProcedure [dbo].[SDIF003_3_SELECT]    Script Date: 05/23/2013 16:02:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SDIF003_3_SELECT]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'
CREATE PROCEDURE [dbo].[SDIF003_3_SELECT]
    @ym char(6)
AS

    SET NOCOUNT ON;

WITH YUKO_HANYO_MASTER AS (
    -- óLå¯îƒópÉ}ÉXÉ^
    SELECT
      SDHM014.*
    FROM SDHM014
      INNER JOIN (
           SELECT
               KOMOKU_CD,
               SAIMOKU_CD01,
               SAIMOKU_CD02,
               SAIMOKU_CD03,
               SAIMOKU_CD04,
               SAIMOKU_CD05,
               SAIMOKU_CD06,
               SAIMOKU_CD07,
               SAIMOKU_CD08,
               SAIMOKU_CD09,
               SAIMOKU_CD10,
               MAX(YUKO_STA_YMD) YUKO_STA_YMD
           FROM SDHM014
           WHERE
               SDHM014.YUKO_STA_YMD <= ''19000101''
               AND SDHM014.YUKO_END_YMD > ''20130601''
           GROUP BY
               KOMOKU_CD,
               SAIMOKU_CD01,
               SAIMOKU_CD02,
               SAIMOKU_CD03,
               SAIMOKU_CD04,
               SAIMOKU_CD05,
               SAIMOKU_CD06,
               SAIMOKU_CD07,
               SAIMOKU_CD08,
               SAIMOKU_CD09,
               SAIMOKU_CD10
         ) SDHM014_MAX
        ON SDHM014.KOMOKU_CD = SDHM014_MAX.KOMOKU_CD
           AND SDHM014.SAIMOKU_CD01 = SDHM014_MAX.SAIMOKU_CD01
           AND SDHM014.SAIMOKU_CD02 = SDHM014_MAX.SAIMOKU_CD02
           AND SDHM014.SAIMOKU_CD03 = SDHM014_MAX.SAIMOKU_CD03
           AND SDHM014.SAIMOKU_CD04 = SDHM014_MAX.SAIMOKU_CD04
           AND SDHM014.SAIMOKU_CD05 = SDHM014_MAX.SAIMOKU_CD05
           AND SDHM014.SAIMOKU_CD06 = SDHM014_MAX.SAIMOKU_CD06
           AND SDHM014.SAIMOKU_CD07 = SDHM014_MAX.SAIMOKU_CD07
           AND SDHM014.SAIMOKU_CD08 = SDHM014_MAX.SAIMOKU_CD08
           AND SDHM014.SAIMOKU_CD09 = SDHM014_MAX.SAIMOKU_CD09
           AND SDHM014.SAIMOKU_CD10 = SDHM014_MAX.SAIMOKU_CD10
           AND SDHM014.YUKO_STA_YMD = SDHM014_MAX.YUKO_STA_YMD
), YUKO_TOKUISAKI AS (
    SELECT
        SDHM001.*
    FROM SDHM001
    INNER JOIN (
        SELECT
            TOKUISAKI_CD,
            MAX(YUKO_STA_YMD) YUKO_STA_YMD
        FROM SDHM001
        WHERE
            YUKO_STA_YMD < ''19000101''
            AND YUKO_END_YMD >= ''20130501''
        GROUP BY
            TOKUISAKI_CD
    ) LATEST
        ON LATEST.TOKUISAKI_CD = SDHM001.TOKUISAKI_CD
        AND LATEST.YUKO_STA_YMD = SDHM001.YUKO_STA_YMD
)

SELECT
    *
FROM (
    SELECT
        MEISAI.BMN_CD,    -- ïîñÂÉRÅ[Éh
        MEISAI.TOKUISAKI_CD,    -- ìæà”êÊÉRÅ[Éh
        COALESCE(MEISAI.INVOICE_NO, KURIKOSI_TIEN.INVOICE_NO) INVOICE_NO,    -- ÉCÉìÉ{ÉCÉXî‘çÜ
        MEISAI.URIAGE_DD,    -- îÑè„îNåéì˙
        MEISAI.NYUKIN_YMD,    -- ì¸ã‡îNåéì˙
        MEISAI.SITE,    -- ÉTÉCÉg
        MEISAI.TUKA_CD,    -- í â›ÉRÅ[Éh
        KURIKOSI_TIEN.KURIKOSI_GAKU_GAIKA,    -- ëOåéåJâzã‡äz(äOâ›)
        KURIKOSI_TIEN.KURIKOSI_GAKU,    -- ëOåéåJâzã‡äz
        CASE WHEN MEISAI.TUKA_CD = ''JPY''
            THEN NULL
            ELSE MEISAI.URIAGE_GAKU_GAIKA
        END URIAGE_GAKU_GAIKA,    -- ìñåéîÑè„ã‡äz(äOâ›)
        MEISAI.URIAGE_GAKU,    -- ìñåéîÑè„ã‡äz(â~â›)
        CASE WHEN MEISAI.TUKA_CD = ''JPY''
            THEN NULL
            ELSE MEISAI.NYUKIN_GAIKA
        END NYUKIN_GAIKA,    -- ìñåéì¸ã‡äz(äOâ›)
        MEISAI.NYUKIN,    -- ìñåéì¸ã‡äz(â~â›)
        CASE WHEN MEISAI.TUKA_CD = ''JPY''
            THEN NULL
            ELSE MEISAI.URIAGE_GAKU_GAIKA - MEISAI.NYUKIN_GAIKA + KURIKOSI_TIEN.KURIKOSI_GAKU_GAIKA
        END ZANDAKA_GAKU_GAIKA,    -- écçÇã‡äz(äOâ›)
        MEISAI.URIAGE_GAKU - MEISAI.NYUKIN + KURIKOSI_TIEN.KURIKOSI_GAKU ZANDAKA_GAKU,    -- écçÇã‡äz(â~â›)
        KURIKOSI_TIEN.TIEN_GAKU_GAIKA,    -- íxâÑã‡äz(äOâ›)
        KURIKOSI_TIEN.TIEN_GAKU,    -- íxâÑã‡äz(â~â›)
        ''D'' LIST_KBN    -- ÉäÉXÉgãÊï™
    FROM SDIT004 MEISAI
    FULL JOIN (
        SELECT
            INVOICE_NO,
            MAX(TUKA_CD) TUKA_CD,    -- í â›ÉRÅ[Éh
            CASE WHEN MAX(TUKA_CD) = ''JPY''
                THEN NULL
                ELSE SUM(URIAGE_GAKU_GAIKA - NYUKIN_GAIKA)
            END KURIKOSI_GAKU_GAIKA,    -- åJâzã‡äz(äOâ›)
            SUM(URIAGE_GAKU - NYUKIN) KURIKOSI_GAKU,    -- åJâzã‡äz(â~â›)
            CASE WHEN MAX(TUKA_CD) = ''JPY''
                THEN NULL
                ELSE SUM(
                    CASE WHEN NYUKIN_YOTEI_YMD < ''2013-05-01''
                        THEN URIAGE_GAKU_GAIKA - NYUKIN_GAIKA
                        ELSE 0
                    END
                )
            END TIEN_GAKU_GAIKA,    -- íxâÑã‡äz(äOâ›)
            SUM(
                CASE WHEN NYUKIN_YOTEI_YMD < ''2013-05-01''
                    THEN URIAGE_GAKU - NYUKIN
                    ELSE 0
                END
            ) TIEN_GAKU    -- íxâÑã‡äz(â~â›)
        FROM SDIT004
        WHERE
            SHUKEI_YM < ''2013-05-01''
            AND KOKUNAI_KAIGAI_KBN = ''2''
            AND KANSAI_FLG = ''0''
        GROUP BY
            INVOICE_NO
    ) KURIKOSI_TIEN
        ON KURIKOSI_TIEN.INVOICE_NO = MEISAI.INVOICE_NO
    WHERE
        MEISAI.KOKUNAI_KAIGAI_KBN = ''2''
        AND MEISAI.SHUKEI_YM = ''2013-05-01''

    UNION ALL
    /*** ìæà”êÊï çáåv(í â›ï ) ***/

    SELECT
        COALESCE(TOKUISAKI_TOTAL.BMN_CD, KURIKOSI_TIEN.BMN_CD) BMN_CD,    -- ïîñÂÉRÅ[Éh
        COALESCE(TOKUISAKI_TOTAL.TOKUISAKI_CD, KURIKOSI_TIEN.TOKUISAKI_CD) TOKUISAKI_CD,    -- ìæà”êÊÉRÅ[Éh
        '''' INVOICE_NO,    -- ÉCÉìÉ{ÉCÉXî‘çÜ
        '''' URIAGE_DD,    -- îÑè„îNåéì˙
        '''' NYUKIN_YMD,    -- ì¸ã‡îNåéì˙
        '''' SITE,    -- ÉTÉCÉg
        COALESCE(TOKUISAKI_TOTAL.TUKA_CD, KURIKOSI_TIEN.TUKA_CD) TUKA_CD,    -- í â›ÉRÅ[Éh
        SUM(KURIKOSI_TIEN.KURIKOSI_GAKU_GAIKA) KURIKOSI_GAKU_GAIKA,    -- ëOåéåJâzã‡äz(äOâ›)
        SUM(KURIKOSI_TIEN.KURIKOSI_GAKU) KURIKOSI_GAKU,    -- ëOåéåJâzã‡äz(â~â›)
        CASE WHEN COALESCE(TOKUISAKI_TOTAL.TUKA_CD, KURIKOSI_TIEN.TUKA_CD) = ''JPY''
            THEN NULL
            ELSE SUM(TOKUISAKI_TOTAL.URIAGE_GAKU_GAIKA)
        END URIAGE_GAKU_GAIKA,    -- ìñåéîÑè„ã‡äz(äOâ›)
        SUM(TOKUISAKI_TOTAL.URIAGE_GAKU) URIAGE_GAKU,    -- ìñåéîÑè„ã‡äz(â~â›)
        CASE WHEN COALESCE(TOKUISAKI_TOTAL.TUKA_CD, KURIKOSI_TIEN.TUKA_CD) = ''JPY''
            THEN NULL
            ELSE SUM(TOKUISAKI_TOTAL.NYUKIN_GAIKA)
        END NYUKIN_GAIKA,    -- ìñåéì¸ã‡äz(äOâ›)
        SUM(TOKUISAKI_TOTAL.NYUKIN) NYUKIN,    -- ìñåéì¸ã‡äz(â~â›)
        CASE WHEN COALESCE(TOKUISAKI_TOTAL.TUKA_CD, KURIKOSI_TIEN.TUKA_CD) = ''JPY''
            THEN NULL
            ELSE SUM(TOKUISAKI_TOTAL.URIAGE_GAKU_GAIKA - TOKUISAKI_TOTAL.NYUKIN_GAIKA + KURIKOSI_TIEN.KURIKOSI_GAKU_GAIKA)
        END ZANDAKA_GAKU_GAIKA,    -- écçÇã‡äz(äOâ›)
        SUM(TOKUISAKI_TOTAL.URIAGE_GAKU - TOKUISAKI_TOTAL.NYUKIN + KURIKOSI_TIEN.KURIKOSI_GAKU) ZANDAKA_GAKU,    -- écçÇã‡äz(â~â›)
        SUM(KURIKOSI_TIEN.TIEN_GAKU_GAIKA) TIEN_GAKU_GAIKA,    -- íxâÑã‡äz(äOâ›)
        SUM(KURIKOSI_TIEN.TIEN_GAKU) TIEN_GAKU,    -- íxâÑã‡äz(â~â›)
        ''S1'' LIST_KBN    -- ÉäÉXÉgãÊï™
    FROM SDIT004 TOKUISAKI_TOTAL
    FULL JOIN (
        SELECT
            BMN_CD,    -- ïîñÂÉRÅ[Éh
            TOKUISAKI_CD,    -- ìæà”êÊÉRÅ[Éh
            TUKA_CD,    -- í â›ÉRÅ[Éh
            CASE WHEN TUKA_CD = ''JPY''
                THEN NULL
                ELSE SUM(URIAGE_GAKU_GAIKA - NYUKIN_GAIKA)
            END KURIKOSI_GAKU_GAIKA,    -- åJâzã‡äz(äOâ›)
            SUM(URIAGE_GAKU - NYUKIN) KURIKOSI_GAKU,    -- åJâzã‡äz(â~â›)
            CASE WHEN MAX(TUKA_CD) = ''JPY''
                THEN NULL
                ELSE SUM(
                    CASE WHEN NYUKIN_YOTEI_YMD < ''2013-05-01''
                        THEN URIAGE_GAKU_GAIKA - NYUKIN_GAIKA
                        ELSE 0
                    END
                )
            END TIEN_GAKU_GAIKA,    -- íxâÑã‡äz(äOâ›)
            SUM(
                CASE WHEN NYUKIN_YOTEI_YMD < ''2013-05-01''
                    THEN URIAGE_GAKU - NYUKIN
                    ELSE 0
                END
            ) TIEN_GAKU    -- íxâÑã‡äz(â~â›)
        FROM SDIT004
        WHERE
            SHUKEI_YM < ''2013-05-01''
            AND KOKUNAI_KAIGAI_KBN = ''2''
            AND KANSAI_FLG = ''0''
        GROUP BY
            BMN_CD,
            TOKUISAKI_CD,
            TUKA_CD
    ) KURIKOSI_TIEN
        ON KURIKOSI_TIEN.BMN_CD = TOKUISAKI_TOTAL.BMN_CD
        AND KURIKOSI_TIEN.TOKUISAKI_CD = TOKUISAKI_TOTAL.TOKUISAKI_CD
        AND KURIKOSI_TIEN.TUKA_CD = TOKUISAKI_TOTAL.TUKA_CD
    GROUP BY
        COALESCE(TOKUISAKI_TOTAL.BMN_CD, KURIKOSI_TIEN.BMN_CD),
        COALESCE(TOKUISAKI_TOTAL.TOKUISAKI_CD, KURIKOSI_TIEN.TOKUISAKI_CD),
        COALESCE(TOKUISAKI_TOTAL.TUKA_CD, KURIKOSI_TIEN.TUKA_CD)

    UNION ALL
    /** ìæà”êÊï çáåv **/
    SELECT
        COALESCE(TOKUISAKI_TOTAL.BMN_CD, KURIKOSI_TIEN.BMN_CD) BMN_CD,    -- ïîñÂÉRÅ[Éh
        COALESCE(TOKUISAKI_TOTAL.TOKUISAKI_CD, KURIKOSI_TIEN.TOKUISAKI_CD) TOKUISAKI_CD,    -- ìæà”êÊÉRÅ[Éh
        '''' INVOICE_NO,    -- ÉCÉìÉ{ÉCÉXî‘çÜ
        '''' URIAGE_DD,    -- îÑè„îNåéì˙
        '''' NYUKIN_YMD,    -- ì¸ã‡îNåéì˙
        '''' SITE,    -- ÉTÉCÉg
        '''' TUKA_CD,    -- í â›ÉRÅ[Éh
        NULL KURIKOSI_GAKU_GAIKA,    -- ëOåéåJâzã‡äz(äOâ›)
        SUM(KURIKOSI_TIEN.KURIKOSI_GAKU) KURIKOSI_GAKU,    -- ëOåéåJâzã‡äz(â~â›)
        NULL URIAGE_GAKU_GAIKA,    -- ìñåéîÑè„ã‡äz(äOâ›)
        SUM(TOKUISAKI_TOTAL.URIAGE_GAKU) URIAGE_GAKU,    -- ìñåéîÑè„ã‡äz
        NULL NYUKIN_GAIKA,    -- ìñåéì¸ã‡äz(äOâ›)
        SUM(TOKUISAKI_TOTAL.NYUKIN) NYUKIN,    -- ìñåéì¸ã‡äz
        NULL ZANDAKA_GAKU_GAIKA,    -- écçÇã‡äz(äOâ›)
        SUM(TOKUISAKI_TOTAL.URIAGE_GAKU - TOKUISAKI_TOTAL.NYUKIN + KURIKOSI_TIEN.KURIKOSI_GAKU) ZANDAKA_GAKU,    -- écçÇã‡äz
        NULL TIEN_GAKU_GAIKA,    -- íxâÑã‡äz(äOâ›)
        SUM(KURIKOSI_TIEN.TIEN_GAKU) TIEN_GAKU,    -- íxâÑã‡äz
        ''S1'' LIST_KBN    -- ÉäÉXÉgãÊï™
    FROM SDIT004 TOKUISAKI_TOTAL
    FULL JOIN (
        SELECT
            BMN_CD,
            TOKUISAKI_CD,
            SUM(URIAGE_GAKU - NYUKIN) KURIKOSI_GAKU,    -- åJâzã‡äz
            SUM(
                CASE WHEN NYUKIN_YOTEI_YMD < ''2013-05-01''
                    THEN URIAGE_GAKU - NYUKIN
                    ELSE 0
                END
            ) TIEN_GAKU    -- íxâÑã‡äz
        FROM SDIT004
        WHERE
            SHUKEI_YM < ''2013-05-01''
            AND KOKUNAI_KAIGAI_KBN = ''2''
            AND KANSAI_FLG = ''0''
        GROUP BY
            BMN_CD,
            TOKUISAKI_CD
    ) KURIKOSI_TIEN
        ON KURIKOSI_TIEN.BMN_CD = TOKUISAKI_TOTAL.BMN_CD
        AND KURIKOSI_TIEN.TOKUISAKI_CD = TOKUISAKI_TOTAL.TOKUISAKI_CD
    WHERE
        TOKUISAKI_TOTAL.KOKUNAI_KAIGAI_KBN = ''2''
        AND TOKUISAKI_TOTAL.SHUKEI_YM = ''2013-05-01''
    GROUP BY
        COALESCE(TOKUISAKI_TOTAL.BMN_CD, KURIKOSI_TIEN.BMN_CD),
        COALESCE(TOKUISAKI_TOTAL.TOKUISAKI_CD, KURIKOSI_TIEN.TOKUISAKI_CD)

    UNION ALL

    /** ëççáåv(í â›ï ) **/
    SELECT
        COALESCE(ALL_TOTAL.BMN_CD, KURIKOSI_TIEN.BMN_CD) BMN_CD,    -- ïîñÂÉRÅ[Éh
        '''' TOKUISAKI_CD,    -- ìæà”êÊÉRÅ[Éh
        '''' INVOICE_NO,    -- ÉCÉìÉ{ÉCÉXî‘çÜ
        '''' URIAGE_DD,    -- îÑè„îNåéì˙
        '''' NYUKIN_YMD,    -- ì¸ã‡îNåéì˙
        '''' SITE,    -- ÉTÉCÉg
        COALESCE(ALL_TOTAL.TUKA_CD, KURIKOSI_TIEN.TUKA_CD) TUKA_CD,    -- í â›ÉRÅ[Éh
        SUM(KURIKOSI_TIEN.KURIKOSI_GAKU_GAIKA) KURIKOSI_GAKU_GAIKA,    -- ëOåéåJâzã‡äz(äOâ›)
        SUM(KURIKOSI_TIEN.KURIKOSI_GAKU) KURIKOSI_GAKU,    -- ëOåéåJâzã‡äz(â~â›)
        CASE WHEN COALESCE(ALL_TOTAL.TUKA_CD, KURIKOSI_TIEN.TUKA_CD) = ''JPY''
            THEN NULL
            ELSE SUM(ALL_TOTAL.URIAGE_GAKU_GAIKA)
        END URIAGE_GAKU_GAIKA,    -- ìñåéîÑè„ã‡äz(äOâ›)
        SUM(ALL_TOTAL.URIAGE_GAKU) URIAGE_GAKU,    -- ìñåéîÑè„ã‡äz(â~â›)
        CASE WHEN COALESCE(ALL_TOTAL.TUKA_CD, KURIKOSI_TIEN.TUKA_CD) = ''JPY''
            THEN NULL
            ELSE SUM(ALL_TOTAL.NYUKIN_GAIKA)
        END NYUKIN_GAIKA,    -- ìñåéì¸ã‡äz(äOâ›)
        SUM(ALL_TOTAL.NYUKIN) NYUKIN,    -- ìñåéì¸ã‡äz(â~â›)
        CASE WHEN COALESCE(ALL_TOTAL.TUKA_CD, KURIKOSI_TIEN.TUKA_CD) = ''JPY''
            THEN NULL
            ELSE SUM(ALL_TOTAL.URIAGE_GAKU_GAIKA - ALL_TOTAL.NYUKIN_GAIKA + KURIKOSI_TIEN.KURIKOSI_GAKU_GAIKA)
        END ZANDAKA_GAKU_GAIKA,    -- écçÇã‡äz(äOâ›)
        SUM(ALL_TOTAL.URIAGE_GAKU - ALL_TOTAL.NYUKIN + KURIKOSI_TIEN.KURIKOSI_GAKU) ZANDAKA_GAKU,    -- écçÇã‡äz(â~â›)
        SUM(KURIKOSI_TIEN.TIEN_GAKU_GAIKA) TIEN_GAKU_GAIKA,    -- íxâÑã‡äz(äOâ›)
        SUM(KURIKOSI_TIEN.TIEN_GAKU) TIEN_GAKU,    -- íxâÑã‡äz(â~â›)
        ''T'' LIST_KBN    -- ÉäÉXÉgãÊï™
    FROM SDIT004 ALL_TOTAL
    FULL JOIN (
        SELECT
            BMN_CD,
            TUKA_CD,
            CASE WHEN TUKA_CD = ''JPY''
                THEN NULL
                ELSE SUM(URIAGE_GAKU_GAIKA - NYUKIN_GAIKA)
            END KURIKOSI_GAKU_GAIKA,    -- åJâzã‡äz(äOâ›)
            SUM(URIAGE_GAKU - NYUKIN) KURIKOSI_GAKU,    -- åJâzã‡äz
            CASE WHEN TUKA_CD = ''JPY''
                THEN NULL
                ELSE SUM(
                  CASE WHEN NYUKIN_YOTEI_YMD < ''2013-05-01''
                      THEN URIAGE_GAKU_GAIKA - NYUKIN_GAIKA
                      ELSE 0
                  END
                )
            END TIEN_GAKU_GAIKA,    -- íxâÑã‡äz(äOâ›)
            SUM(
                CASE WHEN NYUKIN_YOTEI_YMD < ''2013-05-01''
                    THEN URIAGE_GAKU - NYUKIN
                    ELSE 0
                END
            ) TIEN_GAKU    -- íxâÑã‡äz
        FROM SDIT004
        WHERE
            SHUKEI_YM < ''2013-05-01''
            AND KOKUNAI_KAIGAI_KBN = ''2''
            AND KANSAI_FLG = ''0''
        GROUP BY
            BMN_CD,
            TUKA_CD
    ) KURIKOSI_TIEN
        ON KURIKOSI_TIEN.BMN_CD = ALL_TOTAL.BMN_CD
        AND KURIKOSI_TIEN.TUKA_CD = ALL_TOTAL.TUKA_CD
    WHERE
        ALL_TOTAL.KOKUNAI_KAIGAI_KBN = ''2''
        AND ALL_TOTAL.SHUKEI_YM = ''2013-05-01''
    GROUP BY
        COALESCE(ALL_TOTAL.BMN_CD, KURIKOSI_TIEN.BMN_CD),
        COALESCE(ALL_TOTAL.TUKA_CD, KURIKOSI_TIEN.TUKA_CD)

    UNION ALL

    /** ëççáåv **/
    SELECT
        COALESCE(ALL_TOTAL.BMN_CD, KURIKOSI_TIEN.BMN_CD) BMN_CD,    -- ïîñÂÉRÅ[Éh
        '''' TOKUISAKI_CD,    -- ìæà”êÊÉRÅ[Éh
        '''' INVOICE_NO,    -- ÉCÉìÉ{ÉCÉXî‘çÜ
        '''' URIAGE_DD,    -- îÑè„îNåéì˙
        '''' NYUKIN_YMD,    -- ì¸ã‡îNåéì˙
        '''' SITE,    -- ÉTÉCÉg
        '''' TUKA_CD,    -- í â›ÉRÅ[Éh
        NULL KURIKOSI_GAKU_GAIKA,    -- ëOåéåJâzã‡äz(äOâ›)
        SUM(KURIKOSI_TIEN.KURIKOSI_GAKU) KURIKOSI_GAKU,    -- ëOåéåJâzã‡äz(â~â›)
        NULL URIAGE_GAKU_GAIKA,    -- ìñåéîÑè„ã‡äz(äOâ›)
        SUM(ALL_TOTAL.URIAGE_GAKU) URIAGE_GAKU,    -- ìñåéîÑè„ã‡äz(â~â›)
        NULL NYUKIN_GAIKA,    -- ìñåéì¸ã‡äz(äOâ›)
        SUM(ALL_TOTAL.NYUKIN) NYUKIN,    -- ìñåéì¸ã‡äz(â~â›)
        NULL ZANDAKA_GAKU_GAIKA,    -- écçÇã‡äz(äOâ›)
        SUM(ALL_TOTAL.URIAGE_GAKU - ALL_TOTAL.NYUKIN + KURIKOSI_TIEN.KURIKOSI_GAKU) ZANDAKA_GAKU,    -- écçÇã‡äz(â~â›)
        NULL TIEN_GAKU_GAIKA,    -- íxâÑã‡äz(äOâ›)
        SUM(KURIKOSI_TIEN.TIEN_GAKU) TIEN_GAKU,    -- íxâÑã‡äz
        ''T'' LIST_KBN    -- ÉäÉXÉgãÊï™
    FROM SDIT004 ALL_TOTAL
    FULL JOIN (
        SELECT
            BMN_CD,
            SUM(URIAGE_GAKU - NYUKIN) KURIKOSI_GAKU,    -- åJâzã‡äz
            SUM(
                CASE WHEN NYUKIN_YOTEI_YMD < ''2013-05-01''
                    THEN URIAGE_GAKU - NYUKIN
                    ELSE 0
                END
            ) TIEN_GAKU    -- íxâÑã‡äz
        FROM SDIT004
        WHERE
            SHUKEI_YM < ''2013-05-01''
            AND KOKUNAI_KAIGAI_KBN = ''2''
            AND KANSAI_FLG = ''0''
        GROUP BY
            BMN_CD
    ) KURIKOSI_TIEN
        ON KURIKOSI_TIEN.BMN_CD = ALL_TOTAL.BMN_CD
    WHERE
        ALL_TOTAL.KOKUNAI_KAIGAI_KBN = ''2''
        AND ALL_TOTAL.SHUKEI_YM = ''2013-05-01''
    GROUP BY
        COALESCE(ALL_TOTAL.BMN_CD, KURIKOSI_TIEN.BMN_CD)
) DAICHO
LEFT OUTER JOIN YUKO_HANYO_MASTER BMN_MASTER
    ON BMN_MASTER.KOMOKU_CD = ''SDZ024''
    AND BMN_MASTER.SAIMOKU_CD01 = ''10''
    AND BMN_MASTER.SAIMOKU_CD02 = DAICHO.BMN_CD
LEFT OUTER JOIN YUKO_TOKUISAKI TOKUISAKI_MASTER
    ON TOKUISAKI_MASTER.TOKUISAKI_CD = DAICHO.TOKUISAKI_CD
ORDER BY
    DAICHO.BMN_CD,
    COALESCE(DAICHO.TOKUISAKI_CD, ''ZZZZZZZZZZ''),
    COALESCE(DAICHO.INVOICE_NO, ''ZZZZZZZZZZZZZZZ'')

' 
END
GO
/****** Object:  UserDefinedFunction [dbo].[SDFF005_HINMOKU]    Script Date: 05/23/2013 16:02:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SDFF005_HINMOKU]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
BEGIN
execute dbo.sp_executesql @statement = N'/**
 * ó\éZä«óù
 * 
 * ó\éZópïiñ⁄ÉrÉÖÅ[
 * ëŒè€ÉeÅ[ÉuÉãÅFïiñ⁄É}ÉXÉ^ÅAïiñ⁄éÌï É}ÉXÉ^ÇåãçáÇµÇƒïiñ⁄ä÷òAÇÃèÓïÒÇï‘Ç∑ÉrÉÖÅ[
 */
CREATE FUNCTION [dbo].[SDFF005_HINMOKU] (
	@toYMD as varchar(8)
)
RETURNS TABLE AS RETURN
	--DECLARE @targetDaate as varchar(8) = ''20200101''
	SELECT *
	FROM (
		SELECT *
		FROM SDHM003 A --ïiñ⁄M
		WHERE A.YUKO_STA_YMD <= @toYMD
		  AND A.YUKO_STA_YMD = (
			SELECT MAX(B.YUKO_STA_YMD) 
			FROM SDHM003 B
			WHERE B.YUKO_STA_YMD <= @toYMD
			  AND A.KAISHA_CD = B.KAISHA_CD
			  AND A.BMN_CD = B.BMN_CD
			  AND A.SHOHIN_NO = B.SHOHIN_NO
		  )
	) H
	INNER JOIN (
		SELECT 
			 CHR_KOMOKU01
			,CHR_KOMOKU09
			,CHR_KOMOKU10
			,CHR_KOMOKU11
			,CHR_KOMOKU12
			,CHR_KOMOKU13
			,CHR_KOMOKU14
			,CHR_KOMOKU15
		FROM SDHM014 A --ïiñ⁄äKëwM
		WHERE A.KOMOKU_CD = ''SDZ057''
		  AND A.YUKO_STA_YMD <= @toYMD
		  AND A.YUKO_STA_YMD = (
			SELECT MAX(B.YUKO_STA_YMD) 
			FROM SDHM014 B
			WHERE B.KOMOKU_CD = ''SDZ057''
			  AND B.YUKO_STA_YMD <= @toYMD
			  AND A.KOMOKU_CD = B.KOMOKU_CD
			  AND A.CHR_KOMOKU01 = B.CHR_KOMOKU01
		  )
	) K
	ON H.ITEM_KAISO = K.CHR_KOMOKU01
' 
END
GO
/****** Object:  UserDefinedFunction [dbo].[SDFF003_SDHM001]    Script Date: 05/23/2013 16:02:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SDFF003_SDHM001]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
BEGIN
execute dbo.sp_executesql @statement = N'/**
 * ó\éZä«óù
 * 
 * óLå¯É}ÉXÉ^ÉâÉbÉpÉtÉ@ÉìÉNÉVÉáÉì
 * ëŒè€ÉeÅ[ÉuÉãÅFSDHM001 ìæà”êÊÉ}ÉXÉ^
 */
CREATE FUNCTION [dbo].[SDFF003_SDHM001] (
	@toYMD as varchar(8)
)
RETURNS TABLE AS RETURN
	--DECLARE @toYMD as varchar(8) = ''20200101''
	SELECT *
	FROM SDHM001 A
	WHERE A.YUKO_STA_YMD <= @toYMD
	  AND A.YUKO_STA_YMD = (
		SELECT MAX(B.YUKO_STA_YMD) 
		FROM SDHM001 B
		WHERE B.YUKO_STA_YMD <= @toYMD
		  AND A.KAISHA_CD = B.KAISHA_CD
		  AND A.TOKUISAKI_CD = B.TOKUISAKI_CD
	  )
' 
END
GO
/****** Object:  UserDefinedFunction [dbo].[SDFF002_SDHM014SDF002]    Script Date: 05/23/2013 16:02:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SDFF002_SDHM014SDF002]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
BEGIN
execute dbo.sp_executesql @statement = N'/**
 * ó\éZä«óù
 * 
 * óLå¯É}ÉXÉ^ÉâÉbÉpÉtÉ@ÉìÉNÉVÉáÉì
 * ëŒè€ÉeÅ[ÉuÉãÅFSDHM014 SDF002 ó\éZãÊï™ÇØâ»ñ⁄ïœä∑É}ÉXÉ^
 */
CREATE FUNCTION [dbo].[SDFF002_SDHM014SDF002] (
	@toYMD as varchar(8)
)
RETURNS TABLE AS RETURN
	--for test
	--DECLARE @toYMD as varchar(8) = ''20200101''
	--
	
	SELECT * 
	FROM SDHM014 A
	WHERE KOMOKU_CD = ''SDF002''
	  AND YUKO_STA_YMD <= @toYMD
	  AND A.YUKO_STA_YMD = (
		SELECT MAX(B.YUKO_STA_YMD) 
		FROM SDHM014 B
		WHERE B.YUKO_STA_YMD <= @toYMD
		  AND A.KOMOKU_CD = B.KOMOKU_CD
		  AND A.SAIMOKU_CD01 = B.SAIMOKU_CD01
		  AND A.SAIMOKU_CD02 = B.SAIMOKU_CD02
		  AND A.SAIMOKU_CD03 = B.SAIMOKU_CD03
	  )
;
' 
END
GO
/****** Object:  UserDefinedFunction [dbo].[SDFF001_SDHM013]    Script Date: 05/23/2013 16:02:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SDFF001_SDHM013]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
BEGIN
execute dbo.sp_executesql @statement = N'/**
 * ó\éZä«óù
 * 
 * óLå¯É}ÉXÉ^ÉâÉbÉpÉtÉ@ÉìÉNÉVÉáÉì
 * ëŒè€ÉeÅ[ÉuÉãÅFSDHM013ä®íËÉRÅ[ÉhÉ}ÉXÉ^
 */
CREATE FUNCTION [dbo].[SDFF001_SDHM013] (
	@toYMD as varchar(8)
)
RETURNS TABLE AS RETURN
	--for test
	--DECLARE @toYMD as varchar(8) = ''20200101''
	--
	
	SELECT * 
	FROM SDHM013 A
	WHERE YUKO_STA_YMD <= @toYMD
	  AND A.YUKO_STA_YMD = (
		SELECT MAX(B.YUKO_STA_YMD) 
		FROM SDHM013 B
		WHERE B.YUKO_STA_YMD <= @toYMD
		  AND A.KAISHA_CD = B.KAISHA_CD
		  AND A.KAMOKU_CD = B.KAMOKU_CD
	  )
	  ;
' 
END
GO
/****** Object:  StoredProcedure [dbo].[SDIF003]    Script Date: 05/23/2013 16:02:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SDIF003]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'
CREATE PROCEDURE [dbo].[SDIF003]
--     @ym char(6),
--     @user_id varchar(256)
AS

    -- TODO:îNåé(âº)
    DECLARE @ym char(6) = ''201305'';

    --
    -- ïœêîêÈåæ
    --
    DECLARE @start_year int;        -- ëŒè€îN(from)
    DECLARE @start_month int;       -- ëŒè€åé(from)
    DECLARE @start_date char(8);    -- ëŒè€îNåéì˙(from)
    DECLARE @end_year int;          -- ëŒè€îN(to)
    DECLARE @end_month int;         -- ëŒè€åé(to)
    DECLARE @end_date char(8);      -- ëŒè€îNåéì˙(to)

    --
    -- ëŒè€ì˙ïtÇÃéZèo
    --
    SET @start_year = CAST(substring(@ym, 0, 5) as int);
    SET @start_month = CAST(substring(@ym, 5, 7) as int);

    IF @start_month = 12
        BEGIN
            SET @end_year = @start_year + 1;
            SET @end_month = 1;
        END
    ELSE
        BEGIN
            SET @end_year = @start_year;
            SET @end_month = @start_month + 1;
        END

    SET @start_date = cast(@start_year as char(4));
    SET @end_date = cast(@end_year as char(4));

    IF @start_month < 10
        BEGIN
            SET @start_date = cast(@start_date as char(4)) + ''0'' + cast(@start_month as char(1));
        END
    ELSE
        BEGIN
            SET @start_date = cast(@start_date as char(4)) + cast(@start_month as char(2));
        END

    IF @end_month < 10
        BEGIN
            SET @end_date = cast(@end_date as char(4)) + ''0'' + cast(@end_month as char(1));
        END
    ELSE
        BEGIN
            SET @end_date = cast(@end_date as char(4)) + cast(@end_month as char(2));
        END

    SET @start_date = cast(@start_date as char(6)) + ''01'';
    SET @end_date = cast(@end_date as char(6)) + ''01'';

SET NOCOUNT ON;

  BEGIN TRANSACTION;

  BEGIN TRY;

DELETE FROM SDIT004
WHERE
    SHUKEI_YM = @ym  -- TODO:èWåvîNåé

SELECT
    @ym SHUKEI_YM,    -- èWåvîNåé
    BMN_MASTER.OYA_BMN_CD,    -- êeïîñÂÉRÅ[Éh
    BMN_MASTER.BMN_CD,    -- ïîñÂÉRÅ[Éh
    SEIKYU_DENPYO.EIGYO_TANTO_ID,    -- âcã∆íSìñé“ID
    SEIKYU_DENPYO.TOKUISAKI_CD,    -- ìæà”êÊÉRÅ[Éh
    YUKO_TOKUISAKI.TOKUISAKI_CTRY_CD CTRY_CD,    -- çëÉRÅ[Éh
    CASE WHEN YUKO_TOKUISAKI.TOKUISAKI_CTRY_CD = ''JP''
        THEN ''1'' ELSE ''2''
    END KOKUNAI_KAIGAI_KBN,    -- çëì‡äCäOãÊï™
    CASE WHEN YUKO_TOKUISAKI.TOKUISAKI_CTRY_CD = ''JP''
        THEN SEIKYU_DENPYO_MEISAI.JUCHU_DENPYO_NO
        ELSE SEIKYU_DENPYO.INVOICE_NO
    END SHUKEI_TAISHO_NO,    -- èWåvëŒè€î‘çÜ
    CASE WHEN YUKO_TOKUISAKI.TOKUISAKI_CTRY_CD = ''JP''
        THEN NULL
        ELSE SEIKYU_DENPYO.INVOICE_NO
    END INVOICE_NO,    -- ÉCÉìÉ{ÉCÉXNO
    CASE WHEN YUKO_TOKUISAKI.TOKUISAKI_CTRY_CD = ''JP''
        THEN SEIKYU_DENPYO_MEISAI.JUCHU_DENPYO_NO
        ELSE NULL
    END JUCHU_NO,    -- éÛíçî‘çÜ
    SEIKYU_DENPYO.URIAGE_TUKA_CD,    -- îÑè„í â›ÉRÅ[Éh
    SEIKYU_DENPYO.URIAGE_KEIJO_YMD,    -- îÑè„åvè„ì˙
    SEIKYU_DENPYO.NYUKIN_YOTEI_YMD,    -- ì¸ã‡ó\íËì˙
    CASE YUKO_TOKUISAKI.SIHARAI_DD_KBN
        WHEN ''0'' THEN ''0''
        WHEN ''1'' THEN ''30''
        WHEN ''2'' THEN ''60''
        WHEN ''3'' THEN ''90''
        WHEN ''4'' THEN ''120''
        WHEN ''5'' THEN ''150''
        ELSE ''180''
    END SITE,    -- ÉTÉCÉg
    SEIKYU_DENPYO.SEIKYU_SIMEBI,    -- í˜ì˙
    30 - YUKO_TOKUISAKI.SEIKYU_SIMEBI
        + (CASE YUKO_TOKUISAKI.SIHARAI_DD_KBN
              WHEN ''0'' THEN ''0''
              WHEN ''1'' THEN ''30''
              WHEN ''2'' THEN ''60''
              WHEN ''3'' THEN ''90''
              WHEN ''4'' THEN ''120''
              WHEN ''5'' THEN ''150''
              ELSE ''180''
          END) KESSAI_DD,    -- åàçœì˙
    SEIKYU_DENPYO.URIAGE_KANSAN_RATE,    -- îÑè„ä∑éZÉåÅ[Ég
    CASE WHEN YUKO_TOKUISAKI.TOKUISAKI_CTRY_CD = ''JP''
        THEN YUKO_TOKUISAKI.TEGATA_SITE
        ELSE YUKO_TOKUISAKI.USANCE
    END TEGATA_NISSU_USANCE,    -- éËå`ì˙êî(ÉÜÅ[ÉUÉìÉX)
    -- TODO:ë„à¯
    SEIKYU_DENPYO.URIAGE_GAKU_GOKEI_ENKA - HENPIN.SEIKYU_GAKU_GOKEI_ENKA - NEBIKI.NEBIKI_GAKU_ENKA + NEMASI.NEMASI_GAKU_ENKA URIAGE_GAKU,    -- îÑè„ã‡äz
    SEIKYU_DENPYO.URIAGE_GAKU_GOKEI_GAIKA - HENPIN.SEIKYU_GAKU_GOKEI_GAIKA - NEBIKI.NEBIKI_GAKU_GAIKA + NEMASI.NEMASI_GAKU_GAIKA URIAGE_GAKU_GAIKA,    -- îÑè„ã‡äz(äOâ›)
    NYUKIN.N_GAKU_ENKA NYUKIN,    -- ì¸ã‡
    NYUKIN.N_GAKU_GAIKA NYUKIN_GAIKA,    -- ì¸ã‡äOâ›
    -- TODO:éËêîóø
    -- TODO:ì‡éËêîóø
    TATEKAE_KURO.SEIKYU_GAKU_GOKEI_ENKA - TATEKAE_AKA.SEIKYU_GAKU_GOKEI_ENKA TATEKAE_KIN,    -- óßë÷ã‡
    NYUKIN.NYUKIN_YMD,    -- ì¸ã‡ì˙
    YUKO_TOKUISAKI.KESSAI_JOKEN,    -- åàçœèåè
    SDCT007.KESSAI_FLG KANSAI_FLG,    -- äÆçœÉtÉâÉO
    GETDATE() CREATE_DATE,    -- êVãKìoò^ì˙
    ''1'' CREATE_PG_ID,  -- TODO:êVãKìoò^ÉvÉçÉOÉâÉÄID
    ''1'' CREATE_USER_CODE,    -- TODO:êVãKìoò^ÉÜÅ[ÉUID
    GETDATE() UPDATE_DATE,    -- çXêVì˙
    ''1'' UPDATE_PG_ID,    -- TODO:çXêVÉvÉçÉOÉâÉÄID
    ''1'' UPDATE_USER_CODE    -- TODO:çXêVÉÜÅ[ÉUID
FROM
/** êøãÅì`ï[ **/
SDCT001 SEIKYU_DENPYO
INNER JOIN (
    SELECT
        SDCT001.SEIKYU_DENPYO_NO,
        MAX(CAST(SDCT001.SEIKYU_DENPYO_NO_HAN AS int)) AS SEIKYU_DENPYO_NO_HAN
    FROM SDCT001
    WHERE
        SDCT001.URIAGE_KEIJO_YMD >= @start_date
        AND SDCT001.URIAGE_KEIJO_YMD < @end_date
        AND SDCT001.SEIKYU_DENPYO_TYPE = ''Z3F2''
    GROUP BY
        SDCT001.SEIKYU_DENPYO_NO
) DENPYO_LATEST
    ON SEIKYU_DENPYO.SEIKYU_DENPYO_NO = DENPYO_LATEST.SEIKYU_DENPYO_NO
    AND SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN = DENPYO_LATEST.SEIKYU_DENPYO_NO_HAN
    AND SEIKYU_DENPYO.SEIKYU_DENPYO_ST >= ''A''  -- TODO:êøãÅì`ï[ÉXÉeÅ[É^ÉX(è≥îF)
INNER JOIN (
    SELECT
        SDCT002.SEIKYU_DENPYO_NO,
        SDCT002.SEIKYU_DENPYO_NO_HAN,
        MAX(SDCT002.JUCHU_DENPYO_NO) JUCHU_DENPYO_NO
    FROM SDCT002
    GROUP BY
        SDCT002.SEIKYU_DENPYO_NO,
        SDCT002.SEIKYU_DENPYO_NO_HAN
) SEIKYU_DENPYO_MEISAI
    ON SEIKYU_DENPYO_MEISAI.SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
    AND SEIKYU_DENPYO_MEISAI.SEIKYU_DENPYO_NO_HAN = SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN
/** ìæà”êÊ **/
INNER JOIN (
    SELECT
        SDHM001.*
    FROM SDHM001
    INNER JOIN (
        SELECT
            TOKUISAKI_CD,
            MAX(YUKO_STA_YMD) YUKO_STA_YMD
        FROM SDHM001
        WHERE
            SDHM001.TOKUISAKI_SYUBETU = ''1''
            AND SDHM001.YUKO_STA_YMD < @end_date
            AND SDHM001.YUKO_END_YMD >= @end_date
        GROUP BY
            SDHM001.TOKUISAKI_CD
    ) TOKUISAKI_LATEST
        ON TOKUISAKI_LATEST.TOKUISAKI_CD = SDHM001.TOKUISAKI_CD
        AND TOKUISAKI_LATEST.YUKO_STA_YMD = SDHM001.YUKO_STA_YMD
) YUKO_TOKUISAKI
    ON YUKO_TOKUISAKI.TOKUISAKI_CD = SEIKYU_DENPYO.TOKUISAKI_CD
/** ïîñÂ **/
INNER JOIN (
    SELECT
        SDHM014.SAIMOKU_CD01 KAISYA_CD,
        SDHM014.SAIMOKU_CD02 BMN_CD,
        CASE WHEN SDHM014.CHR_KOMOKU04 = ''04''
            THEN SDHM014.CHR_KOMOKU05
            ELSE SDHM014.SAIMOKU_CD02
        END OYA_BMN_CD
    FROM SDHM014
    INNER JOIN (
        SELECT
            SDHM014.KOMOKU_CD,
            SDHM014.SAIMOKU_CD01,
            SDHM014.SAIMOKU_CD02,
            MAX(SDHM014.YUKO_STA_YMD) YUKO_STA_YMD
        FROM SDHM014
        WHERE
            SDHM014.KOMOKU_CD = ''SDZ024''
            AND SDHM014.YUKO_STA_YMD < @end_date
            AND SDHM014.YUKO_END_YMD >= @end_date
        GROUP BY
            SDHM014.KOMOKU_CD,
            SDHM014.SAIMOKU_CD01,
            SDHM014.SAIMOKU_CD02
    ) YUKO
        ON YUKO.KOMOKU_CD = SDHM014.KOMOKU_CD
        AND YUKO.SAIMOKU_CD01 = SDHM014.SAIMOKU_CD01
        AND YUKO.SAIMOKU_CD02 = SDHM014.SAIMOKU_CD02
) BMN_MASTER
    ON BMN_MASTER.BMN_CD = YUKO_TOKUISAKI.BMN_CD
/** ï‘ïi **/
LEFT OUTER JOIN (
    SELECT
        SDCT001.AKA_KURO_SOUSAI_DENPYO_NO,
        SDCT001.SEIKYU_GAKU_GOKEI_ENKA,
        SDCT001.SEIKYU_GAKU_GOKEI_GAIKA
    FROM SDCT001
    INNER JOIN (
        SELECT
            SDCT001.SEIKYU_DENPYO_NO,
            MAX(SDCT001.SEIKYU_DENPYO_NO_HAN) SEIKYU_DENPYO_NO_HAN
        FROM SDCT001
        WHERE
            SDCT001.SEIKYU_DENPYO_TYPE = ''Z3RE''
        GROUP BY
            SDCT001.SEIKYU_DENPYO_NO
    ) SEIKYU__DENPYO_LATEST
        ON SEIKYU__DENPYO_LATEST.SEIKYU_DENPYO_NO = SDCT001.SEIKYU_DENPYO_NO
        AND SEIKYU__DENPYO_LATEST.SEIKYU_DENPYO_NO_HAN = SDCT001.SEIKYU_DENPYO_NO_HAN
) HENPIN
    ON HENPIN.AKA_KURO_SOUSAI_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
/** óßë÷ã‡(çï) **/
LEFT OUTER JOIN (
    SELECT
        SDCT004.SANSHO_SEIKYU_DENPYO_NO,
        SDCT004.SEIKYU_GAKU_GOKEI_ENKA,
        SDCT004.SEIKYU_GAKU_GOKEI_GAIKA
    FROM SDCT004
    INNER JOIN (
        SELECT
            SDCT004.URIAGE_HOSOKU_DENPYO_NO,
            MAX(SDCT004.URIAGE_HOSOKU_DENPYO_HAN) URIAGE_HOSOKU_DENPYO_HAN
        FROM SDCT004
        WHERE
            SDCT004.URIAGE_HOSOKU_DENPYO_TYPE = ''5''
        GROUP BY
            SDCT004.URIAGE_HOSOKU_DENPYO_NO
    ) TATEKAE_KURO_LATEST
        ON TATEKAE_KURO_LATEST.URIAGE_HOSOKU_DENPYO_NO = SDCT004.URIAGE_HOSOKU_DENPYO_NO
        AND TATEKAE_KURO_LATEST.URIAGE_HOSOKU_DENPYO_HAN = SDCT004.URIAGE_HOSOKU_DENPYO_HAN
) TATEKAE_KURO
    ON TATEKAE_KURO.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
/** óßë÷ã‡(ê‘) **/
LEFT OUTER JOIN (
    SELECT
        SDCT004.SANSHO_SEIKYU_DENPYO_NO,
        SDCT004.SEIKYU_GAKU_GOKEI_ENKA,
        SDCT004.SEIKYU_GAKU_GOKEI_GAIKA
    FROM SDCT004
    INNER JOIN (
        SELECT
            SDCT004.URIAGE_HOSOKU_DENPYO_NO,
            MAX(SDCT004.URIAGE_HOSOKU_DENPYO_HAN) URIAGE_HOSOKU_DENPYO_HAN
        FROM SDCT004
        WHERE
            SDCT004.URIAGE_HOSOKU_DENPYO_TYPE = ''6''
        GROUP BY
            SDCT004.URIAGE_HOSOKU_DENPYO_NO
    ) TATEKAE_AKA_LATEST
        ON TATEKAE_AKA_LATEST.URIAGE_HOSOKU_DENPYO_NO = SDCT004.URIAGE_HOSOKU_DENPYO_NO
        AND TATEKAE_AKA_LATEST.URIAGE_HOSOKU_DENPYO_HAN = SDCT004.URIAGE_HOSOKU_DENPYO_HAN
) TATEKAE_AKA
    ON TATEKAE_AKA.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
/** ílà¯ **/
LEFT OUTER JOIN (
    SELECT
        SDCT004.SANSHO_SEIKYU_DENPYO_NO,
        SDCT004.NEBIKI_GAKU_SOU_GOKEI NEBIKI_GAKU_ENKA,
        SDCT004.NEBIKI_GAKU_SOU_GOKEI / SDCT004.URIAGE_KANSAN_RATE NEBIKI_GAKU_GAIKA
    FROM SDCT004
    INNER JOIN (
        SELECT
            SDCT004.URIAGE_HOSOKU_DENPYO_NO,
            MAX(SDCT004.URIAGE_HOSOKU_DENPYO_HAN) URIAGE_HOSOKU_DENPYO_HAN
        FROM SDCT004
        WHERE
            SDCT004.URIAGE_HOSOKU_DENPYO_TYPE = ''1''
        GROUP BY
            SDCT004.URIAGE_HOSOKU_DENPYO_NO
    ) NEBIKI_LATEST
        ON NEBIKI_LATEST.URIAGE_HOSOKU_DENPYO_NO = SDCT004.URIAGE_HOSOKU_DENPYO_NO
        AND NEBIKI_LATEST.URIAGE_HOSOKU_DENPYO_HAN = SDCT004.URIAGE_HOSOKU_DENPYO_HAN
) NEBIKI
    ON NEBIKI.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
/** ílëù **/
LEFT OUTER JOIN (
    SELECT
        SDCT004.SANSHO_SEIKYU_DENPYO_NO,
        SDCT004.NEBIKI_GAKU_SOU_GOKEI NEMASI_GAKU_ENKA,
        SDCT004.NEBIKI_GAKU_SOU_GOKEI / SDCT004.URIAGE_KANSAN_RATE NEMASI_GAKU_GAIKA
    FROM SDCT004
    INNER JOIN (
        SELECT
            SDCT004.URIAGE_HOSOKU_DENPYO_NO,
            MAX(SDCT004.URIAGE_HOSOKU_DENPYO_HAN) URIAGE_HOSOKU_DENPYO_HAN
        FROM SDCT004
        WHERE
            SDCT004.URIAGE_HOSOKU_DENPYO_TYPE = ''2''
        GROUP BY
            SDCT004.URIAGE_HOSOKU_DENPYO_NO
    ) NEMASI_LATEST
        ON NEMASI_LATEST.URIAGE_HOSOKU_DENPYO_NO = SDCT004.URIAGE_HOSOKU_DENPYO_NO
        AND NEMASI_LATEST.URIAGE_HOSOKU_DENPYO_HAN = SDCT004.URIAGE_HOSOKU_DENPYO_HAN
) NEMASI
    ON NEMASI.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
/** ì¸ã‡ **/
LEFT OUTER JOIN (
    SELECT
        SDCT006.SEIKYU_DENPYO_NO,
        MAX(SDCT006.NYUKIN_YMD) NYUKIN_YMD,
        SUM(SDCT006.N_GAKU_GAIKA) N_GAKU_GAIKA,
        SUM(SDCT006.N_GAKU_ENKA) N_GAKU_ENKA
    FROM SDCT006
    WHERE
        SDCT006.DEL_KBN = ''0''
    GROUP BY
        SDCT006.SEIKYU_DENPYO_NO
) NYUKIN
    ON NYUKIN.SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
/** äÆçœÉtÉâÉO **/
LEFT OUTER JOIN SDCT007
    ON SDCT007.KANJO_KBN = ''1''
    AND SDCT007.ZANDAKA_KANRI_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO


    END TRY

    BEGIN CATCH

        ROLLBACK TRANSACTION;
        RAISERROR ('''', 9, 1) WITH SETERROR, LOG;
        return (9);

    END CATCH

    COMMIT TRANSACTION;

' 
END
GO
/****** Object:  StoredProcedure [dbo].[SDIF002]    Script Date: 05/23/2013 16:02:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SDIF002]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'
CREATE PROCEDURE [dbo].[SDIF002]
    @ym char(6),
    @user_id varchar(256)
AS

    --
    -- ïœêîêÈåæ
    --
    DECLARE @start_year int;        -- ëŒè€îN(from)
    DECLARE @start_month int;       -- ëŒè€åé(from)
    DECLARE @start_date char(8);    -- ëŒè€îNåéì˙(from)
    DECLARE @end_year int;          -- ëŒè€îN(to)
    DECLARE @end_month int;         -- ëŒè€åé(to)
    DECLARE @end_date char(8);      -- ëŒè€îNåéì˙(to)
    DECLARE @nendo int;             -- îNìx
    DECLARE @tuki char(2);          -- åé
    DECLARE @kamiki_simoki_kbn char(1);    -- è„ä˙ÅEâ∫ä˙ãÊï™

    --
    -- ëŒè€ì˙ïtÇÃéZèo
    --
    SET @start_year = CAST(substring(@ym, 0, 5) as int);
    SET @start_month = CAST(substring(@ym, 5, 7) as int);

    IF @start_month = 12
        BEGIN
            SET @end_year = @start_year + 1;
            SET @end_month = 1;
        END
    ELSE
        BEGIN
            SET @end_year = @start_year;
            SET @end_month = @start_month + 1;
        END

    SET @start_date = cast(@start_year as char(4));
    SET @end_date = cast(@end_year as char(4));

    IF @start_month < 10
        BEGIN
            SET @tuki = ''0'' + cast(@start_month as char(1));
            SET @start_date = cast(@start_date as char(4)) + @tuki;
        END
    ELSE
        BEGIN
            SET @tuki = cast(@start_month as char(2));
            SET @start_date = cast(@start_date as char(4)) + @tuki;
        END

    IF @end_month < 10
        BEGIN
            SET @end_date = cast(@end_date as char(4)) + ''0'' + cast(@end_month as char(1));
        END
    ELSE
        BEGIN
            SET @end_date = cast(@end_date as char(4)) + cast(@end_month as char(2));
        END

    IF @start_month < 4
        BEGIN
            SET @nendo = @start_year - 1;
        END
    ELSE
        BEGIN
            SET @nendo = @start_year;
        END

    IF @start_month < 4
        BEGIN
             SET @kamiki_simoki_kbn = ''1'';
        END
    ELSE IF @start_month >= 10
        BEGIN
             SET @kamiki_simoki_kbn = ''1'';
        END
    ELSE
        BEGIN
             SET @kamiki_simoki_kbn = ''2'';
        END

    SET @start_date = cast(@start_date as char(6)) + ''01'';
    SET @end_date = cast(@end_date as char(6)) + ''01'';

--SET NOCOUNT ON;

  BEGIN TRANSACTION;

  BEGIN TRY;

-- îÑè„èWåvÉeÅ[ÉuÉãÇàÍíUçÌèú
-- DELETE FROM SDIT001
-- WHERE
--   SDIT001.YM = @ym

WITH TAISHO_YOSAN AS (
    SELECT
      URIAGE_MEISAI_SURYO.KAISHA_CD,
      URIAGE_MEISAI_SURYO.BMN_CD,
      URIAGE_MEISAI_SURYO.KANJO_KAMOKU_CD,
      URIAGE_MEISAI_SURYO.ITEM_CD,
      URIAGE_MEISAI_SURYO.ITEM_SANSHO_TOKUISAKI_CD,
      URIAGE_MEISAI_SURYO.SYS_ID,
      URIAGE_MEISAI_SURYO.TOKUISAKI_CD,
      URIAGE_MEISAI_SURYO.SIMUKETI_CD,
      URIAGE_MEISAI_SURYO.TANTO_CD,
      URIAGE_MEISAI_SURYO.NENDO,
      URIAGE_MEISAI_SURYO.YOSAN_KBN,
      URIAGE_MEISAI_SURYO.HAN_NO,
      URIAGE_MEISAI_SURYO.TUKA_CD,
      URIAGE_MEISAI_SURYO.URIAGE_CD,
      URIAGE_MEISAI_SURYO.ITEM_KBN,
      URIAGE_MEISAI_SURYO.SEHIN_BUNRUI,
      URIAGE_MEISAI_SURYO.URIAGE_TUKA_CD,
      URIAGE_MEISAI_SURYO.SIIRE_TUKA_CD,
      URIAGE_MEISAI_SURYO.COMMISSION_TANKA,
      URIAGE_MEISAI_SURYO.INCOTERMS1,
      URIAGE_MEISAI_SURYO.KESSAI_JOKEN_KBN,
      URIAGE_MEISAI_SURYO.TEGATA_NISSU,
      URIAGE_MEISAI_SURYO.TUKI,
      CONVERT(
          VARCHAR,
          CASE
          WHEN CONVERT(INT, URIAGE_MEISAI_SURYO.TUKI) < 4 THEN CONVERT(INT, URIAGE_MEISAI_SURYO.NENDO) + 1
          ELSE URIAGE_MEISAI_SURYO.NENDO
          END
      ) + URIAGE_MEISAI_SURYO.TUKI AS NENGETU,
      CONVERT(
          VARCHAR,
          CASE
          WHEN CONVERT(INT, URIAGE_MEISAI_SURYO.TUKI) < 4 THEN CONVERT(INT, URIAGE_MEISAI_SURYO.NENDO) + 1
          ELSE URIAGE_MEISAI_SURYO.NENDO
          END
      ) + URIAGE_MEISAI_SURYO.TUKI + ''01'' AS KIJUN_YMD,
      URIAGE_MEISAI_URI_TANKA.GAKU_SU AS URI_TANKA,
      URIAGE_MEISAI_GEN_TANKA.GAKU_SU AS GEN_TANKA,
      URIAGE_MEISAI_SURYO.GAKU_SU AS URIAGE_SURYO,
      URIAGE_MEISAI_SURYO.GAKU_SU * URIAGE_MEISAI_URI_TANKA.GAKU_SU AS URIAGE_KINGAKU,
      URIAGE_MEISAI_SURYO.GAKU_SU * URIAGE_MEISAI_GEN_TANKA.GAKU_SU AS GENKA,
      URIAGE_MEISAI_SEISAN_DAISU.GAKU_SU AS SEISAN_DAISU
    FROM (
           SELECT
             TBL1.KAISHA_CD,
             TBL1.BMN_CD,
             TBL1.KANJO_KAMOKU_CD,
             TBL1.ITEM_CD,
             TBL1.TOKUISAKI_CD,
             TBL1.SIMUKETI_CD,
             TBL1.TANTO_CD,
             TBL1.NENDO,
             TBL1.YOSAN_KBN,
             TBL1.GAKU_SU_KBN,
             MAX (TBL1.HAN_NO) AS HAN_NO
           FROM
             SDFT002 AS TBL1 -- îÑè„ñæç◊ÉfÅ[É^ÉeÅ[ÉuÉã
           WHERE
               TBL1.YOSAN_KBN = (
                 SELECT
                   CASE MIN (
                       CASE SUB1.YOSAN_KBN
                       WHEN 2 THEN 1 -- 2:èCê≥ó\éZ Å® 1
                       WHEN 1 THEN 2 -- 1:ìñèâó\éZ Å® 2
                       ELSE 3 -- 3:íÜí∑ä˙ó\éZ Å® 3
                       END
                   )
                   WHEN 1 THEN 2 -- 1 Å® 2:èCê≥ó\éZ
                   WHEN 2 THEN 1 -- 2 Å® 1:ìñèâó\éZ
                   ELSE 3  -- 3 Å® 3:íÜí∑ä˙ó\éZ
                   END
                 FROM
                   SDFT002 SUB1 -- îÑè„ñæç◊ÉfÅ[É^ÉeÅ[ÉuÉã
                 WHERE
                   SUB1.KAISHA_CD = TBL1.KAISHA_CD
                   AND SUB1.BMN_CD = TBL1.BMN_CD
                   AND SUB1.KANJO_KAMOKU_CD = TBL1.KANJO_KAMOKU_CD
                   AND SUB1.ITEM_CD = TBL1.ITEM_CD
                   AND SUB1.TOKUISAKI_CD = TBL1.TOKUISAKI_CD
                   AND SUB1.SIMUKETI_CD = TBL1.SIMUKETI_CD
                   AND SUB1.TANTO_CD = TBL1.TANTO_CD
                   AND SUB1.NENDO = TBL1.NENDO
               )
           GROUP BY
             TBL1.KAISHA_CD,
             TBL1.BMN_CD,
             TBL1.KANJO_KAMOKU_CD,
             TBL1.ITEM_CD,
             TBL1.TOKUISAKI_CD,
             TBL1.SIMUKETI_CD,
             TBL1.TANTO_CD,
             TBL1.NENDO,
             TBL1.YOSAN_KBN,
             TBL1.GAKU_SU_KBN
         ) AS TAISHO_YOSAN
      INNER JOIN (
                 -- 1åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''01'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_JAN AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''3''
        UNION ALL -- 2åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''02'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_FEB AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''3''
        UNION ALL -- 3åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''03'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_MAR AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''3''
        UNION ALL -- 4åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''04'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_APR AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''3''
        UNION ALL -- 5åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''05'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_MAY AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''3''
        UNION ALL -- 6åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''06'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_JUN AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''3''
        UNION ALL -- 7åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''07'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_JUL AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''3''
        UNION ALL -- 8åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''08'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_AUG AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''3''
        UNION ALL -- 9åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''09'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_SEP AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''3''
        UNION ALL -- 10åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''10'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_OCT AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''3''
        UNION ALL -- 11åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''11'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_NOV AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''3''
        UNION ALL -- 12åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''12'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_DEC AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''3''
                 ) AS URIAGE_MEISAI_SURYO
        ON URIAGE_MEISAI_SURYO.KAISHA_CD = TAISHO_YOSAN.KAISHA_CD
           AND URIAGE_MEISAI_SURYO.BMN_CD = TAISHO_YOSAN.BMN_CD
           AND URIAGE_MEISAI_SURYO.ITEM_CD = TAISHO_YOSAN.ITEM_CD
           AND URIAGE_MEISAI_SURYO.TOKUISAKI_CD = TAISHO_YOSAN.TOKUISAKI_CD
           AND URIAGE_MEISAI_SURYO.SIMUKETI_CD = TAISHO_YOSAN.SIMUKETI_CD
           AND URIAGE_MEISAI_SURYO.TANTO_CD = TAISHO_YOSAN.TANTO_CD
           AND URIAGE_MEISAI_SURYO.NENDO = TAISHO_YOSAN.NENDO
           AND URIAGE_MEISAI_SURYO.YOSAN_KBN = TAISHO_YOSAN.YOSAN_KBN
           AND URIAGE_MEISAI_SURYO.HAN_NO = TAISHO_YOSAN.HAN_NO
      LEFT OUTER JOIN (
                 -- 1åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''01'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_JAN AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''1''
        UNION ALL -- 2åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''02'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_FEB AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''1''
        UNION ALL -- 3åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''03'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_MAR AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''1''
        UNION ALL -- 4åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''04'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_APR AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''1''
        UNION ALL -- 5åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''05'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_MAY AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''1''
        UNION ALL -- 6åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''06'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_JUN AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''1''
        UNION ALL -- 7åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''07'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_JUL AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''1''
        UNION ALL -- 8åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''08'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_AUG AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''1''
        UNION ALL -- 9åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''09'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_SEP AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''1''
        UNION ALL -- 10åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''10'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_OCT AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''1''
        UNION ALL -- 11åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''11'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_NOV AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''1''
        UNION ALL -- 12åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''12'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_DEC AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''1''
                      ) AS URIAGE_MEISAI_URI_TANKA
        ON URIAGE_MEISAI_URI_TANKA.KAISHA_CD = URIAGE_MEISAI_SURYO.KAISHA_CD
           AND URIAGE_MEISAI_URI_TANKA.BMN_CD = URIAGE_MEISAI_SURYO.BMN_CD
           AND URIAGE_MEISAI_URI_TANKA.ITEM_CD = URIAGE_MEISAI_SURYO.ITEM_CD
           AND URIAGE_MEISAI_URI_TANKA.TOKUISAKI_CD = URIAGE_MEISAI_SURYO.TOKUISAKI_CD
           AND URIAGE_MEISAI_URI_TANKA.SIMUKETI_CD = URIAGE_MEISAI_SURYO.SIMUKETI_CD
           AND URIAGE_MEISAI_URI_TANKA.TANTO_CD = URIAGE_MEISAI_SURYO.TANTO_CD
           AND URIAGE_MEISAI_URI_TANKA.NENDO = URIAGE_MEISAI_SURYO.NENDO
           AND URIAGE_MEISAI_URI_TANKA.HAN_NO = URIAGE_MEISAI_SURYO.HAN_NO
           AND URIAGE_MEISAI_URI_TANKA.TUKI = URIAGE_MEISAI_SURYO.TUKI

      LEFT OUTER JOIN (
                  -- 1åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''01'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_JAN AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''4''
        UNION ALL -- 2åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''02'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_FEB AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''4''
        UNION ALL -- 3åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''03'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_MAR AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''4''
        UNION ALL -- 4åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''04'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_APR AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''4''
        UNION ALL -- 5åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''05'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_MAY AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''4''
        UNION ALL -- 6åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''06'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_JUN AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''4''
        UNION ALL -- 7åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''07'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_JUL AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''4''
        UNION ALL -- 8åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''08'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_AUG AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''4''
        UNION ALL -- 9åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''09'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_SEP AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''4''
        UNION ALL -- 10åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''10'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_OCT AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''4''
        UNION ALL -- 11åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''11'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_NOV AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''4''
        UNION ALL -- 12åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''12'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_DEC AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''4''
                      ) URIAGE_MEISAI_SEISAN_DAISU
        ON URIAGE_MEISAI_SEISAN_DAISU.KAISHA_CD = URIAGE_MEISAI_SURYO.KAISHA_CD
           AND URIAGE_MEISAI_SEISAN_DAISU.BMN_CD = URIAGE_MEISAI_SURYO.BMN_CD
           AND URIAGE_MEISAI_SEISAN_DAISU.ITEM_CD = URIAGE_MEISAI_SURYO.ITEM_CD
           AND URIAGE_MEISAI_SEISAN_DAISU.TOKUISAKI_CD = URIAGE_MEISAI_SURYO.TOKUISAKI_CD
           AND URIAGE_MEISAI_SEISAN_DAISU.SIMUKETI_CD = URIAGE_MEISAI_SURYO.SIMUKETI_CD
           AND URIAGE_MEISAI_SEISAN_DAISU.TANTO_CD = URIAGE_MEISAI_SURYO.TANTO_CD
           AND URIAGE_MEISAI_SEISAN_DAISU.NENDO = URIAGE_MEISAI_SURYO.NENDO
           AND URIAGE_MEISAI_SEISAN_DAISU.HAN_NO = URIAGE_MEISAI_SURYO.HAN_NO
           AND URIAGE_MEISAI_SEISAN_DAISU.TUKI = URIAGE_MEISAI_SURYO.TUKI
      LEFT OUTER JOIN (
                  -- 1åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''01'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_JAN AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''2''
        UNION ALL -- 2åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''02'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_FEB AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''2''
        UNION ALL -- 3åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''03'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_MAR AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''2''
        UNION ALL -- 4åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''04'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_APR AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''2''
        UNION ALL -- 5åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''05'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_MAY AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''2''
        UNION ALL -- 6åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''06'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_JUN AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''2''
        UNION ALL -- 7åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''07'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_JUL AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''2''
        UNION ALL -- 8åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''08'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_AUG AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''2''
        UNION ALL -- 9åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''09'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_SEP AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''2''
        UNION ALL -- 10åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''10'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_OCT AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''2''
        UNION ALL -- 11åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''11'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_NOV AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''2''
        UNION ALL -- 12åéï™
        SELECT KAISHA_CD, BMN_CD, KANJO_KAMOKU_CD, ITEM_CD, ITEM_SANSHO_TOKUISAKI_CD, SYS_ID, TOKUISAKI_CD, SIMUKETI_CD, TANTO_CD, NENDO, ''12'' AS TUKI, YOSAN_KBN, HAN_NO, TUKA_CD, URIAGE_CD, ITEM_KBN, SEHIN_BUNRUI, URIAGE_TUKA_CD, SIIRE_TUKA_CD, GAKU_SU_KBN, GAKU_SU_DEC AS GAKU_SU, COMMISSION_TANKA, INCOTERMS1, KESSAI_JOKEN_KBN, TEGATA_NISSU FROM SDFT002 WHERE GAKU_SU_KBN = ''2''
                      ) URIAGE_MEISAI_GEN_TANKA
        ON URIAGE_MEISAI_GEN_TANKA.KAISHA_CD = URIAGE_MEISAI_SURYO.KAISHA_CD
           AND URIAGE_MEISAI_GEN_TANKA.BMN_CD = URIAGE_MEISAI_SURYO.BMN_CD
           AND URIAGE_MEISAI_GEN_TANKA.ITEM_CD = URIAGE_MEISAI_SURYO.ITEM_CD
           AND URIAGE_MEISAI_GEN_TANKA.TOKUISAKI_CD = URIAGE_MEISAI_SURYO.TOKUISAKI_CD
           AND URIAGE_MEISAI_GEN_TANKA.SIMUKETI_CD = URIAGE_MEISAI_SURYO.SIMUKETI_CD
           AND URIAGE_MEISAI_GEN_TANKA.TANTO_CD = URIAGE_MEISAI_SURYO.TANTO_CD
           AND URIAGE_MEISAI_GEN_TANKA.NENDO = URIAGE_MEISAI_SURYO.NENDO
           AND URIAGE_MEISAI_GEN_TANKA.HAN_NO = URIAGE_MEISAI_SURYO.HAN_NO
           AND URIAGE_MEISAI_GEN_TANKA.TUKI = URIAGE_MEISAI_SURYO.TUKI
)

INSERT INTO SDIT001
(
    OYA_BMN_CD,
    BMN_CD,
    TANTO_CD,
    TOKUISAKI_GRP_CD,
    TOKUISAKI_CD,
    SEIZO_KATASIKI,
    HANBAI_KOSHO,
    AREA_CD,
    CTRY_CD,
    SEISAN_KBN,
    YOSAN_TUKA_CD,
    KAMOKU_KBN,
    BRAND_KBN,
    URIAGE_SHUKEI_KBN,
    ITEM_BUNRUI,
    ITEM_KBN,
    ITEM_ZOKUSEI1,
    ITEM_ZOKUSEI2,
    JIGYOSHO_EIGYOSHO_CD,
    YM,
    NENDO,
    KAMIKI_SIMOKI_KBN,
    SU_KAUNTO_KBN,
    URIAGE_SU,
    URIAGE_SU_YOSAN,
    URIAGE_SU_JUCHU,
    URIAGE_SU_MIKOMI,
    URIAGE_GAKU,
    URIAGE_GAKU_GAIKA,
    URIAGE_GAKU_YOSAN,
    URIAGE_GAKU_YOSAN_GAIKA,
    URIAGE_GAKU_JUCHU,
    URIAGE_GAKU_JUCHU_GAIKA,
    URIAGE_GAKU_MIKOMI,
    URIAGE_GAKU_MIKOMI_GAIKA,
    URIAGE_MODOSI_SU,
    URIAGE_MODOSI_GAKU,
    URIAGE_MODOSI_GAKU_GAIKA,
    WARIBIKI_GAKU,
    WARIBIKI_GAKU_JUCHU,
    WARIBIKI_GAKU_MIKOMI,
    WARIBIKI_GAKU_GAIKA,
    WARIBIKI_GAKU_JUCHU_GAIKA,
    WARIBIKI_GAKU_MIKOMI_GAIKA,
    ZEI,
    GENKA,
    GENKA_YOSAN,
    GENKA_MIKOMI,
    GENKA_JUCHU,
    GENKA_GAIKA,
    GENKA_YOSAN_GAIKA,
    GENKA_JUCHU_GAIKA,
    GENKA_MIKOMI_GAIKA,
    TANKA,
    TANKA_YOSAN,
    TANKA_JUCHU,
    TANKA_MIKOMI,
    TANKA_GAIKA,
    TANKA_YOSAN_GAIKA,
    TANKA_JUCHU_GAIKA,
    TANKA_MIKOMI_GAIKA,
    KAWASE_RATE,
    KAWASE_RATE_YOSAN,
    KAWASE_RATE_JUCHU,
    KAWASE_RATE_MIKOMI,
    KAWASE_RATE_GENKA,
    INCOTERMS,
    KESSAI_JOKEN_KBN,
    TEGATA_NISSU,
    URIAGE_TUKA_CD,
    COMMISSION_TANKA,
    COMMISSION_TANKA_YOSAN,
    COMMISSION_TANKA_JUCHU,
    COMMISSION_TANKA_MIKOMI,
    COMMISSION_TANKA_GAIKA,
    COMMISSION_TANKA_YOSAN_GAIKA,
    COMMISSION_TANKA_JUCHU_GAIKA,
    COMMISSION_TANKA_MIKOMI_GAIKA,
    SIIRE_GAKU_TAIWAN,
    SIIRE_GAKU_TAIWAN_GAIKA,
    SIIRE_TUKA_CD,
    UNCHIN,
    UNCHIN_GAIKA,
    HOKEN_RYO,
    HOKEN_RYO_GAIKA,
    KOJI_MENTE_DAI,
    SHOKAI_FEE,
    TANKA_SHUSEI,
    TOKUBETU_WARIBIKI,
    SONOTA,
    SONOTA_GAIKA,
    CREATE_DATE,
    CREATE_PG_ID,
    CREATE_USER_CODE,
    UPDATE_DATE,
    UPDATE_PG_ID,
    UPDATE_USER_CODE
)
SELECT
    DENPYO.OYA_BMN_CD,    -- êeïîñÂÉRÅ[Éh
    DENPYO.BMN_CD,    -- ïîñÂÉRÅ[Éh
    EIGYO_TANTO_ID,    -- íSìñé“ÉRÅ[Éh
    TOKUISAKI_SHUKEI_GRP,    -- ìæà”êÊÉOÉãÅ[ÉvÉRÅ[Éh
    TOKUISAKI_CD,    -- ìæà”êÊÉRÅ[Éh
    SEIZO_KATASIKI,    -- êªë¢å^éÆ
    HANBAI_KOSHO,    -- îÃîÑåƒèÃ
    AREA_CD,    -- ínàÊÉRÅ[Éh
    TOKUISAKI_CTRY_CD,    -- çëÉRÅ[Éh
    SEISAN_KBN,    -- ê∂éYãÊï™
    YOSAN_TUKA_CD,    -- ó\éZí â›ÉRÅ[Éh
    KAMOKU_KBN,    -- â»ñ⁄ãÊï™
    BRAND_KBN,    -- ÉuÉâÉìÉhãÊï™
    ''1'' URIAGE_SHUKEI_KBN,    -- TODO:îÑè„èWåvãÊï™
    ITEM_BUNRUI,    -- ïiñ⁄ï™óﬁ
    ITEM_KBN,    -- ïiñ⁄ãÊï™
    ITEM_ZOKUSEI1,    -- ïiñ⁄ëÆê´1
    ITEM_ZOKUSEI2,    -- ïiñ⁄ëÆê´2
    JIGYOSHO_EIGYOSHO_CD,    -- éñã∆èä/âcã∆èäÉRÅ[Éh
    @ym YM,    -- îNåé
    @nendo NENDO,    -- îNìx
    @kamiki_simoki_kbn KAMIKI_SIMOKI_KBN,    -- è„ä˙ÅEâ∫ä˙ãÊï™
    ''1'' SU_KAUNTO_KBN,    -- TODO:êîó ÉJÉEÉìÉgãÊï™(êªïiãÊï™)
    SUM(URIAGE_SU) URIAGE_SU,    -- îÑè„êîó 
    SUM(URIAGE_SU_YOSAN) URIAGE_SU_YOSAN,    -- îÑè„êîó (ó\éZ)
    SUM(URIAGE_SU_JUCHU) URIAGE_SU_JUCHU,    -- îÑè„êîó (éÛíç)
    SUM(URIAGE_SU_MITSUMORI) URIAGE_SU_MIKOMI,    -- îÑè„êîó (å©çû)
    SUM(URIAGE_GAKU_ENKA) URIAGE_GAKU,    -- îÑè„äz
    SUM(URIAGE_GAKU_GAIKA) URIAGE_GAKU_GAIKA,    -- îÑè„äz(äOâ›)
    SUM(URIAGE_GAKU_YOSAN_ENKA) URIAGE_GAKU_YOSAN,    -- îÑè„äz(ó\éZ)
    SUM(URIAGE_GAKU_YOSAN_GAIKA) URIAGE_GAKU_YOSAN_GAIKA,    -- îÑè„äz(ó\éZ)(äOâ›)
    SUM(URIAGE_GAKU_JUCHU_ENKA) URIAGE_GAKU_JUCHU,    -- îÑè„äz(éÛíç)
    SUM(URIAGE_GAKU_JUCHU_GAIKA) URIAGE_GAKU_JUCHU_GAIKA,    -- îÑè„äz(éÛíç)(äOâ›)
    SUM(URIAGE_GAKU_MITSUMORI_ENKA) URIAGE_GAKU_MIKOMI,    -- îÑè„ã‡äz(å©çû)
    SUM(URIAGE_GAKU_MITSUMORI_GAIKA) URIAGE_GAKU_MIKOMI_GAIKA,    -- îÑè„ã‡äz(å©çû)(äOâ›)
    SUM(URIAGE_MODOSI_SU) URIAGE_MODOSI_SU,    -- îÑè„ñﬂÇµêîó 
    SUM(URIAGE_MODOSI_GAKU_ENKA) URIAGE_MODOSI_GAKU,    -- îÑè„ñﬂÇµã‡äz
    SUM(URIAGE_MODOSI_GAKU_GAIKA) URIAGE_MODOSI_GAKU_GAIKA,    -- îÑè„ñﬂÇµã‡äz(äOâ›)
    SUM(NEBIKI_GAKU) NEBIKI_GAKU,    -- äÑà¯ã‡äz
    SUM(NEBIKI_GAKU_JUCHU) NEBIKI_GAKU_JUCHU,    -- äÑà¯ã‡äz(éÛíç)
    SUM(NEBIKI_GAKU_MITSUMORI) WARIBIKI_GAKU_MIKOMI,    -- ílà¯ã‡äz(å©çû)
    SUM(NEBIKI_GAKU_GAIKA) NEBIKI_GAKU_GAIKA,    -- äÑà¯ã‡äz(äOâ›)
    SUM(NEBIKI_GAKU_JUCHU_GAIKA) NEBIKI_GAKU_JUCHU_GAIKA,    -- äÑà¯ã‡äz(éÛíç)(äOâ›)
    SUM(NEBIKI_GAKU_MITSUMORI_GAIKA) WARIBIKI_GAKU_MIKOMI_GAIKA,    -- ílà¯ã‡äz(å©çû)(äOâ›)
    SUM(URIAGE_GAKU_ZEI) URIAGE_GAKU_ZEI,    -- è¡îÔê≈
    SUM(GENKA) GENKA,    -- å¥âø
    SUM(GENKA_YOSAN) GENKA_YOSAN,    -- å¥âø(ó\éZ)
    0 GENKA_MIKOMI,    -- TODO:å¥âø(å©çû)
    SUM(GENKA_JUCHU) GENKA_JUCHU,    -- å¥âø(éÛíç)
    SUM(GENKA_GAIKA) GENKA_GAIKA,    -- å¥âø(äOâ›)
    SUM(GENKA_YOSAN_GAIKA) GENKA_YOSAN_GAIKA,    -- å¥âø(ó\éZ)(äOâ›)
    SUM(GENKA_JUCHU_GAIKA) GENKA_JUCHU_GAIKA,    -- å¥âø(éÛíç)(äOâ›)
    0 GENKA_MIKOMI_GAIKA,    -- TODO:å¥âø(å©çû)(äOâ›)

    SUM(TANKA) TANKA,    -- íPâø
    SUM(TANKA_YOSAN) TANKA_YOSAN,    -- íPâø(ó\éZ)
    SUM(TANKA_JUCHU) TANKA_JUCHU,    -- íPâø(éÛíç)
    0 TANKA_MIKOMI,    -- TODO:íPâø(å©çû)
    SUM(TANKA_GAIKA) TANKA_GAIKA,    -- íPâø(äOâ›)
    SUM(TANKA_YOSAN_GAIKA) TANKA_YOSAN_GAIKA,    -- íPâø(ó\éZ)(äOâ›)
    SUM(TANKA_JUCHU_GAIKA) TANKA_JUCHU_GAIKA,    -- íPâø(éÛíç)(äOâ›)
    0 TANKA_MIKOMI_GAIKA,    -- TODO:íPâø(å©çû)(äOâ›)

    AVG(URIAGE_KANSAN_RATE) URIAGE_KANSAN_RATE,    -- à◊ë÷ÉåÅ[Ég
    AVG(URIAGE_KANSAN_RATE_JUCHU) URIAGE_KANSAN_RATE_JUCHU,    -- à◊ë÷ÉåÅ[Ég(éÛíç)
    AVG(URIAGE_KANSAN_RATE_YOSAN) URIAGE_KANSAN_RATE_YOSAN,    -- à◊ë÷ÉåÅ[Ég(ó\éZ)
    AVG(URIAGE_KANSAN_RATE_MITSUMORI) KAWASE_RATE_MIKOMI,    -- à◊ë÷ÉåÅ[Ég(å©çû)
    0 KAWASE_RATE_GENKA,    -- TODO:à◊ë÷ÉåÅ[Ég(å¥âø)

    MAX(TATENE_KBN) TATENE_KBN,    -- åöílãÊï™
    MAX(KESSAI_JOKEN) KESSAI_JOKEN,    -- åàçœèåèãÊï™
    MAX(TEGATA_NISSU) TEGATA_NISSU,    -- éËå`ì˙êî
    URIAGE_TUKA_CD,    -- îÑè„í â›ÉRÅ[Éh
    SUM(COMMISSION_TANKA) COMMISSION_TANKA,    -- ÉRÉ~ÉbÉVÉáÉìíPâø
    SUM(COMMISSION_TANKA_YOSAN) COMMISSION_TANKA_YOSAN,    -- ÉRÉ~ÉbÉVÉáÉìíPâø(ó\éZ)
    SUM(COMMISSION_TANKA_JUCHU) COMMISSION_TANKA_JUCHU,    -- ÉRÉ~ÉbÉVÉáÉìíPâø(éÛíç)
    SUM(COMMISSION_TANKA_MITSUMORI) COMMISSION_TANKA_MIKOMI,    -- ÉRÉ~ÉbÉVÉáÉìíPâø(å©çû)
    SUM(COMMISSION_TANKA_GAIKA) COMMISSION_TANKA_GAIKA,    -- ÉRÉ~ÉbÉVÉáÉìíPâø(äOâ›)
    SUM(COMMISSION_TANKA_JUCHU_GAIKA) COMMISSION_TANKA_JUCHU_GAIKA,    -- ÉRÉ~ÉbÉVÉáÉìíPâø(éÛíç)(äOâ›)
    SUM(COMMISSION_TANKA_YOSAN_GAIKA) COMMISSION_TANKA_YOSAN_GAIKA,    -- ÉRÉ~ÉbÉVÉáÉìíPâø(ó\éZ)(äOâ›)
    SUM(COMMISSION_TANKA_MITSUMORI_GAIKA) COMMISSION_TANKA_MIKOMI_GAIKA,    -- ÉRÉ~ÉbÉVÉáÉìíPâø(å©çû)(äOâ›)

    SUM(SIIRE_GAKU_TAIWAN_ENKA) SIIRE_GAKU_TAIWAN,    -- édì¸ã‡äz(ë‰òp)
    SUM(SIIRE_GAKU_TAIWAN_GAIKA) SIIRE_GAKU_TAIWAN_GAIKA,    -- édì¸ã‡äz(ë‰òp)(äOâ›)
    SIIRE_TUKA_CD,    -- édì¸í â›ÉRÅ[Éh

    SUM(KAIJYO_UNCHIN_URIAGE_EN) KAIJYO_UNCHIN_URIAGE,    -- â^í¿
    SUM(KAIJYO_UNCHIN_URIAGE_GAIKA) KAIJYO_UNCHIN_URIAGE_GAIKA,    -- â^í¿(äOâ›)
    SUM(KAIJYO_HOKEN_URIAGE_EN) KAIJYO_HOKEN_URIAGE,    -- ï€åØóø
    SUM(KAIJYO_HOKEN_URIAGE_GAIKA) KAIJYO_HOKEN_URIAGE_GAIKA,    -- ï€åØóø(äOâ›)

    0 KOJI_MENTE_DAI,    -- TODO:çHéñÅEÉÅÉìÉeë„
    0 SHOKAI_FEE,    -- TODO:è–âÓéËêîóø
    0 TANKA_SHUSEI,    -- TODO:íPâøèCê≥
    SUM(TOKUBETSU_NEBIKI) TOKUBETSU_NEBIKI,    -- ì¡ï äÑà¯

    0 SONOTA,    -- TODO:ÇªÇÃëº
    0 SONOTA_GAIKA,    -- TODO:ÇªÇÃëº(äOâ›)

    GETDATE() CREATE_DATE,    -- êVãKìoò^ì˙
    ''batch_user'' CREATE_PG_ID,    -- êVãKìoò^ÉvÉçÉOÉâÉÄID
    @user_id CREATE_USER_CODE,    -- êVãKÉÜÅ[ÉUÉvÉçÉOÉâÉÄID
    GETDATE() UPDATE_DATE,    -- çXêVì˙
    ''batch_user'' UPDATE_PG_ID,    -- çXêVÉvÉçÉOÉâÉÄID
    @user_id UPDATE_USER_CODE    -- çXêVÉÜÅ[ÉUÉvÉçÉOÉâÉÄID
FROM
(
    SELECT
        COALESCE(SEIKYU_DENPYO.OYA_BMN_CD, JUCHU_DENPYO.OYA_BMN_CD, YOSAN.OYA_BMN_CD, MITSUMORI.OYA_BMN_CD) OYA_BMN_CD,    -- êeïîñÂÉRÅ[Éh
        COALESCE(SEIKYU_DENPYO.BMN_CD, JUCHU_DENPYO.BMN_CD, YOSAN.BMN_CD, MITSUMORI.BMN_CD) BMN_CD,    -- ïîñÂÉRÅ[Éh
        COALESCE(SEIKYU_DENPYO.EIGYO_TANTO_ID, JUCHU_DENPYO.EIGYO_TANTO_ID, YOSAN.EIGYO_TANTO_ID, MITSUMORI.EIGYO_TANTO_ID) EIGYO_TANTO_ID,    -- íSìñé“ÉRÅ[Éh
        COALESCE(SEIKYU_DENPYO.TOKUISAKI_SHUKEI_GRP, JUCHU_DENPYO.TOKUISAKI_SHUKEI_GRP, YOSAN.TOKUISAKI_SHUKEI_GRP, MITSUMORI.TOKUISAKI_SHUKEI_GRP) TOKUISAKI_SHUKEI_GRP,    -- ìæà”êÊÉOÉãÅ[ÉvÉRÅ[Éh
        COALESCE(SEIKYU_DENPYO.TOKUISAKI_CD, JUCHU_DENPYO.TOKUISAKI_CD, YOSAN.TOKUISAKI_CD, MITSUMORI.TOKUISAKI_CD) TOKUISAKI_CD,    -- ìæà”êÊÉRÅ[Éh
        COALESCE(SEIKYU_DENPYO.SEIZO_KATASIKI, JUCHU_DENPYO.SEIZO_KATASIKI, YOSAN.SEIZO_KATASIKI, MITSUMORI.SEIZO_KATASIKI) SEIZO_KATASIKI,    -- êªë¢å^éÆ
        COALESCE(SEIKYU_DENPYO.HANBAI_KOSHO, JUCHU_DENPYO.HANBAI_KOSHO, YOSAN.HANBAI_KOSHO, MITSUMORI.HANBAI_KOSHO) HANBAI_KOSHO,    -- îÃîÑåƒèÃ
        COALESCE(SEIKYU_DENPYO.AREA_CD, JUCHU_DENPYO.AREA_CD, YOSAN.AREA_CD, MITSUMORI.AREA_CD) AREA_CD,    -- ínàÊÉRÅ[Éh
        COALESCE(SEIKYU_DENPYO.TOKUISAKI_CTRY_CD, JUCHU_DENPYO.TOKUISAKI_CTRY_CD, YOSAN.TOKUISAKI_CTRY_CD, MITSUMORI.TOKUISAKI_CTRY_CD) TOKUISAKI_CTRY_CD,    -- çëÉRÅ[Éh
        COALESCE(SEIKYU_DENPYO.SEISAN_KBN, JUCHU_DENPYO.SEISAN_KBN, YOSAN.SEISAN_KBN, MITSUMORI.SEISAN_KBN) SEISAN_KBN,    -- ê∂éYãÊï™
        YOSAN.TUKA_CD YOSAN_TUKA_CD,    -- ó\éZí â›ÉRÅ[Éh
        COALESCE(SEIKYU_DENPYO.KAMOKU_KBN, JUCHU_DENPYO.KAMOKU_KBN, YOSAN.KAMOKU_KBN, MITSUMORI.KAMOKU_KBN) KAMOKU_KBN,    -- â»ñ⁄ãÊï™
        COALESCE(SEIKYU_DENPYO.BRAND_KBN, JUCHU_DENPYO.BRAND_KBN, YOSAN.BRAND_KBN, MITSUMORI.BRAND_KBN) BRAND_KBN,    -- ÉuÉâÉìÉhãÊï™
        -- TODO:îÑè„èWåvãÊï™
        COALESCE(SEIKYU_DENPYO.ITEM_BUNRUI, JUCHU_DENPYO.ITEM_BUNRUI, YOSAN.ITEM_BUNRUI, MITSUMORI.ITEM_BUNRUI) ITEM_BUNRUI,     -- ïiñ⁄ï™óﬁ
        COALESCE(SEIKYU_DENPYO.ITEM_KBN, JUCHU_DENPYO.ITEM_KBN, YOSAN.ITEM_KBN, MITSUMORI.ITEM_KBN) ITEM_KBN,    -- ïiñ⁄ãÊï™
        COALESCE(SEIKYU_DENPYO.ITEM_ZOKUSEI1, JUCHU_DENPYO.ITEM_ZOKUSEI1, YOSAN.ITEM_ZOKUSEI1, MITSUMORI.ITEM_ZOKUSEI1) ITEM_ZOKUSEI1,    -- ïiñ⁄ëÆê´1
        COALESCE(SEIKYU_DENPYO.ITEM_ZOKUSEI2, JUCHU_DENPYO.ITEM_ZOKUSEI2, YOSAN.ITEM_ZOKUSEI2, MITSUMORI.ITEM_ZOKUSEI2) ITEM_ZOKUSEI2,    -- ïiñ⁄ëÆê´2
        COALESCE(SEIKYU_DENPYO.JIGYOSHO_EIGYOSHO_CD, JUCHU_DENPYO.JIGYOSHO_EIGYOSHO_CD, YOSAN.JIGYOSHO_EIGYOSHO_CD, MITSUMORI.JIGYOSHO_EIGYOSHO_CD) JIGYOSHO_EIGYOSHO_CD,    -- éñã∆èä/âcã∆èäÉRÅ[Éh

        SEIKYU_DENPYO.URIAGE_SU,    -- îÑè„êîó 
        YOSAN.URIAGE_SU URIAGE_SU_YOSAN,    -- îÑè„êîó (ó\éZ)
        JUCHU_DENPYO.URIAGE_SU URIAGE_SU_JUCHU,  -- îÑè„êîó (éÛíç)
        MITSUMORI.URIAGE_SU URIAGE_SU_MITSUMORI,    -- îÑè„êîó (å©çû)

        SEIKYU_DENPYO.URIAGE_GAKU_ENKA,    -- îÑè„äz
        SEIKYU_DENPYO.URIAGE_GAKU_GAIKA,   -- îÑè„äz(äOâ›)
        YOSAN.URIAGE_GAKU URIAGE_GAKU_YOSAN_ENKA,    -- îÑè„äz(ó\éZ)
        YOSAN.URIAGE_GAKU_GAIKA URIAGE_GAKU_YOSAN_GAIKA,    -- îÑè„äz(ó\éZ)(äOâ›)
        JUCHU_DENPYO.URIAGE_GAKU_ENKA URIAGE_GAKU_JUCHU_ENKA,  -- îÑè„äz(éÛíç)
        JUCHU_DENPYO.URIAGE_GAKU_GAIKA URIAGE_GAKU_JUCHU_GAIKA,    -- îÑè„äz(éÛíç)(äOâ›)
        MITSUMORI.URIAGE_GAKU_ENKA URIAGE_GAKU_MITSUMORI_ENKA,    -- îÑè„ã‡äz(å©çû)
        MITSUMORI.URIAGE_GAKU_GAIKA URIAGE_GAKU_MITSUMORI_GAIKA,    -- îÑè„ã‡äz(å©çû)(äOâ›)

        SEIKYU_DENPYO.URIAGE_MODOSI_SU,    -- îÑè„ñﬂÇµêîó 
        SEIKYU_DENPYO.URIAGE_MODOSI_GAKU_ENKA,    -- îÑè„ñﬂÇµã‡äz
        SEIKYU_DENPYO.URIAGE_MODOSI_GAKU_GAIKA,    --- îÑè„ñﬂÇµã‡äz(äOâ›)

        SEIKYU_DENPYO.NEBIKI_GAKU_ENKA NEBIKI_GAKU,    -- äÑà¯ã‡äz
        JUCHU_DENPYO.NEBIKI_GAKU_ENKA NEBIKI_GAKU_JUCHU,    -- äÑà¯ã‡äz(éÛíç)
        MITSUMORI.NEBIKI_GAKU_ENKA NEBIKI_GAKU_MITSUMORI,    -- äÑà¯ã‡äz(å©çû)
        SEIKYU_DENPYO.NEBIKI_GAKU_GAIKA,    -- äÑà¯ã‡äz(äOâ›)
        JUCHU_DENPYO.NEBIKI_GAKU_GAIKA NEBIKI_GAKU_JUCHU_GAIKA,    -- äÑà¯ã‡äz(éÛíç)(äOâ›)
        MITSUMORI.NEBIKI_GAKU_GAIKA NEBIKI_GAKU_MITSUMORI_GAIKA,    -- äÑà¯ã‡äz(å©çû)(äOâ›)

        COALESCE(SEIKYU_DENPYO.URIAGE_GAKU_ZEI, JUCHU_DENPYO.URIAGE_GAKU_ZEI) URIAGE_GAKU_ZEI,  -- è¡îÔê≈

        SEIKYU_DENPYO.GENKA,    -- å¥âø
        YOSAN.GENKA GENKA_YOSAN,    -- å¥âø(ó\éZ)
        -- TODO:å¥âø(å©çû)
        JUCHU_DENPYO.GENKA GENKA_JUCHU,    -- å¥âø(éÛíç)
        SEIKYU_DENPYO.GENKA_GAIKA,    -- å¥âø(äOâ›)
        YOSAN.GENKA_GAIKA GENKA_YOSAN_GAIKA,    -- å¥âø(ó\éZ)(äOâ›)
        JUCHU_DENPYO.GENKA_GAIKA GENKA_JUCHU_GAIKA,    -- å¥âø(éÛíç)(äOâ›)
        -- TODO:å¥âø(å©çû)(äOâ›)

        SEIKYU_DENPYO.URIAGE_TANKA TANKA,  -- íPâø
        YOSAN.URIAGE_TANKA TANKA_YOSAN,    -- íPâø(ó\éZ)
        JUCHU_DENPYO.URIAGE_TANKA TANKA_JUCHU,    -- íPâø(éÛíç)
        -- TODO:íPâø(å©çû)
        SEIKYU_DENPYO.URIAGE_TANKA_GAIKA TANKA_GAIKA,    -- íPâø(äOâ›)
        YOSAN.URIAGE_TANKA_GAIKA TANKA_YOSAN_GAIKA,    -- íPâø(ó\éZ)(äOâ›)
        JUCHU_DENPYO.URIAGE_TANKA_GAIKA TANKA_JUCHU_GAIKA,    -- íPâø(éÛíç)(äOâ›)
        -- TODO:íPâø(å©çû)(äOâ›)

        SEIKYU_DENPYO.URIAGE_KANSAN_RATE,    -- à◊ë÷ÉåÅ[Ég
        JUCHU_DENPYO.URIAGE_KANSAN_RATE URIAGE_KANSAN_RATE_JUCHU,    -- à◊ë÷ÉåÅ[Ég(éÛíç)
        YOSAN.TTM URIAGE_KANSAN_RATE_YOSAN,    -- à◊ë÷ÉåÅ[Ég(ó\éZ)
        MITSUMORI.URIAGE_KANSAN_RATE URIAGE_KANSAN_RATE_MITSUMORI,-- à◊ë÷ÉåÅ[Ég(å©çû)

        COALESCE(SEIKYU_DENPYO.TATENE_KBN, JUCHU_DENPYO.TATENE_KBN, YOSAN.TATENE_KBN, MITSUMORI.TATENE_KBN) TATENE_KBN,    -- åöílãÊï™
        COALESCE(SEIKYU_DENPYO.KESSAI_JOKEN, JUCHU_DENPYO.KESSAI_JOKEN, YOSAN.KESSAI_JOKEN, MITSUMORI.KESSAI_JOKEN) KESSAI_JOKEN,    -- åàçœèåèãÊï™
        COALESCE(SEIKYU_DENPYO.TEGATA_NISSU, JUCHU_DENPYO.TEGATA_NISSU, YOSAN.TEGATA_NISSU, MITSUMORI.TEGATA_NISSU) TEGATA_NISSU,    -- éËå`ì˙êî
        COALESCE(SEIKYU_DENPYO.URIAGE_TUKA_CD, JUCHU_DENPYO.URIAGE_TUKA_CD, YOSAN.URIAGE_TUKA_CD, MITSUMORI.URIAGE_TUKA_CD) URIAGE_TUKA_CD,    -- îÑè„í â›ÉRÅ[Éh

        SEIKYU_DENPYO.COMMISSION_GAKU_ENKA COMMISSION_TANKA,    -- ÉRÉ~ÉbÉVÉáÉìíPâø
        YOSAN.COMMISSION_TANKA COMMISSION_TANKA_YOSAN,    -- ÉRÉ~ÉbÉVÉáÉìíPâø(ó\éZ)
        JUCHU_DENPYO.COMMISSION_GAKU_ENKA COMMISSION_TANKA_JUCHU,    -- ÉRÉ~ÉbÉVÉáÉìíPâø(éÛíç)
        MITSUMORI.COMMISSION_GAKU_ENKA COMMISSION_TANKA_MITSUMORI,    -- ÉRÉ~ÉbÉVÉáÉìíPâø(å©çû)
        SEIKYU_DENPYO.COMMISSION_GAKU_GAIKA COMMISSION_TANKA_GAIKA,    -- ÉRÉ~ÉbÉVÉáÉìíPâø(äOâ›)
        JUCHU_DENPYO.COMMISSION_GAKU_GAIKA COMMISSION_TANKA_JUCHU_GAIKA,    -- ÉRÉ~ÉbÉVÉáÉìíPâø(éÛíç)(äOâ›)
        YOSAN.COMMISSION_TANKA_GAIKA COMMISSION_TANKA_YOSAN_GAIKA,    -- ÉRÉ~ÉbÉVÉáÉìíPâø(ó\éZ)(äOâ›)
        MITSUMORI.COMMISSION_GAKU_GAIKA COMMISSION_TANKA_MITSUMORI_GAIKA,     -- ÉRÉ~ÉbÉVÉáÉìíPâø(å©çû)(äOâ›)

        SEIKYU_DENPYO.SIIRE_GAKU_TAIWAN_ENKA,    -- édì¸ã‡äz(ë‰òp)
        SEIKYU_DENPYO.SIIRE_GAKU_TAIWAN_GAIKA,    -- édì¸ã‡äz(ë‰òp)(äOâ›)

        MITSUMORI.SIIRE_TUKA_CD,    -- édì¸í â›ÉRÅ[Éh

        SEIKYU_DENPYO.KAIJYO_UNCHIN_URIAGE_EN,    -- â^í¿
        SEIKYU_DENPYO.KAIJYO_UNCHIN_URIAGE_GAIKA,    -- â^í¿(äOâ›)
        SEIKYU_DENPYO.KAIJYO_HOKEN_URIAGE_EN,    -- ï€åØóø
        SEIKYU_DENPYO.KAIJYO_HOKEN_URIAGE_GAIKA,    -- ï€åØóø(äOâ›)

        -- TODO:çHéñÅEÉÅÉìÉeë„
        -- TODO:è–âÓéËêîóø
        -- TODO:íPâøèCê≥

        SEIKYU_DENPYO.TOKUBETSU_NEBIKI    -- ì¡ï äÑà¯
    FROM (
        /** êøãÅì`ï[ **/
        SELECT
            CASE WHEN BMN_MASTER.CHR_KOMOKU04 = ''04''
                THEN BMN_MASTER.CHR_KOMOKU05
                ELSE BMN_MASTER.SAIMOKU_CD02
            END OYA_BMN_CD,
            TANTO_MASTER.BMN_CD,
            SEIKYU_DENPYO.EIGYO_TANTO_ID,
            TOKUISAKI_MASTER.TOKUISAKI_SHUKEI_GRP,
            SEIKYU_DENPYO.TOKUISAKI_CD,
            TOKUISAKI_MASTER.TOKUISAKI_CTRY_CD,
            CTRY_MASTER.CHR_KOMOKU03 AREA_CD,
            HINMOKU_MASTER.ITEM_ZOKUSEI3 SEISAN_KBN,
            HINMOKU_MASTER.KAMOKU_KBN,
            -- TODO:îÑè„èWåvãÊï™
            SEIKYU_DENPYO_MEISAI.BRAND_KBN,
            SEIKYU_DENPYO_MEISAI.ITEM_BUNRUI,
            SEIKYU_DENPYO_MEISAI.ITEM_KBN,
            SEIKYU_DENPYO_MEISAI.ITEM_ZOKUSEI1,
            SEIKYU_DENPYO_MEISAI.ITEM_ZOKUSEI2,
            SEIKYU_DENPYO.URIAGE_TUKA_CD,
            HINMOKU_MASTER.SEIZO_KATASIKI,
            HINMOKU_MASTER.HANBAI_KOSHO,
            TANTO_MASTER.TANTO_JIGYOSHO_CD JIGYOSHO_EIGYOSHO_CD,
            SEIKYU_DENPYO_MEISAI.URIAGE_SU - HENPIN.URIAGE_SU URIAGE_SU,
            SEIKYU_DENPYO_MEISAI.URIAGE_GAKU_ENKA - HENPIN.URIAGE_GAKU_ENKA - (NEBIKI.NEBIKI_GAKU_ENKA - NEMASI.NEMASI_GAKU_ENKA) URIAGE_GAKU_ENKA,
            SEIKYU_DENPYO_MEISAI.URIAGE_GAKU_GAIKA - HENPIN.URIAGE_GAKU_GAIKA - (NEBIKI.NEBIKI_GAKU_GAIKA - NEMASI.NEMASI_GAKU_GAIKA) URIAGE_GAKU_GAIKA,
            HENPIN.URIAGE_SU URIAGE_MODOSI_SU,
            HENPIN.URIAGE_GAKU_ENKA URIAGE_MODOSI_GAKU_ENKA,
            HENPIN.URIAGE_GAKU_GAIKA URIAGE_MODOSI_GAKU_GAIKA,
            NEBIKI.NEBIKI_GAKU_ENKA - NEMASI.NEMASI_GAKU_ENKA NEBIKI_GAKU_ENKA,
            NEBIKI.NEBIKI_GAKU_GAIKA - NEMASI.NEMASI_GAKU_GAIKA NEBIKI_GAKU_GAIKA,
            SEIKYU_DENPYO_MEISAI.URIAGE_GAKU_ZEI,
            SEIKYU_DENPYO_MEISAI.SIIRE_TANKA GENKA,
            SEIKYU_DENPYO_MEISAI.SIIRE_TANKA / SEIKYU_DENPYO.URIAGE_KANSAN_RATE GENKA_GAIKA,
            SEIKYU_DENPYO_MEISAI.URIAGE_TANKA,
            SEIKYU_DENPYO_MEISAI.URIAGE_TANKA / SEIKYU_DENPYO.URIAGE_KANSAN_RATE URIAGE_TANKA_GAIKA,
            SEIKYU_DENPYO.URIAGE_KANSAN_RATE,
            SEIKYU_DENPYO_MEISAI.COMMISSION_GAKU_ENKA,
            SEIKYU_DENPYO_MEISAI.COMMISSION_GAKU_GAIKA,
            SEIKYU_DENPYO_MEISAI.KAIJYO_UNCHIN_URIAGE_EN,
            SEIKYU_DENPYO_MEISAI.KAIJYO_UNCHIN_URIAGE_EN / SEIKYU_DENPYO.URIAGE_KANSAN_RATE KAIJYO_UNCHIN_URIAGE_GAIKA,
            SEIKYU_DENPYO_MEISAI.KAIJYO_HOKEN_URIAGE_EN,
            SEIKYU_DENPYO_MEISAI.KAIJYO_HOKEN_URIAGE_EN / SEIKYU_DENPYO.URIAGE_KANSAN_RATE KAIJYO_HOKEN_URIAGE_GAIKA,
            NEBIKI.NEBIKI_GAKU_ENKA - NEMASI.NEMASI_GAKU_ENKA TOKUBETSU_NEBIKI,
            SHUKKA_DENPYO.TATENE_KBN,
            SHUKKA_DENPYO.KESSAI_JOKEN,
            SHUKKA_DENPYO.TEGATA_NISSU,
            SHUKKA_DENPYO.SIIRE_GAKU_TAIWAN_ENKA,
            SHUKKA_DENPYO.SIIRE_GAKU_TAIWAN_GAIKA
        FROM SDCT001 SEIKYU_DENPYO
        INNER JOIN (
            SELECT
                SDCT001.SEIKYU_DENPYO_NO,
                MAX(CAST(SDCT001.SEIKYU_DENPYO_NO_HAN AS int)) AS SEIKYU_DENPYO_NO_HAN
            FROM SDCT001
            WHERE
                SDCT001.URIAGE_KEIJO_YMD >= @start_date
                AND SDCT001.URIAGE_KEIJO_YMD < @end_date
                AND SDCT001.SEIKYU_DENPYO_TYPE = ''Z3F2''
            GROUP BY
                SDCT001.SEIKYU_DENPYO_NO
        ) DENPYO_LATEST
            ON SEIKYU_DENPYO.SEIKYU_DENPYO_NO = DENPYO_LATEST.SEIKYU_DENPYO_NO
            AND SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN = DENPYO_LATEST.SEIKYU_DENPYO_NO_HAN
            AND SEIKYU_DENPYO.SEIKYU_DENPYO_ST >= ''A''  -- TODO:êøãÅì`ï[ÉXÉeÅ[É^ÉX(è≥îF)
        INNER JOIN (
            SELECT
                SDCT002.SEIKYU_DENPYO_NO,
                SDCT002.SEIKYU_DENPYO_NO_HAN,
                SDCT002.ITEM_SANSHO_TOKUISAKI_CD,
                SDCT002.ITEM_CD,
                SDCT002.ITEM_BUNRUI,
                SDCT002.ITEM_KBN,
                SDCT002.ITEM_ZOKUSEI1,
                SDCT002.ITEM_ZOKUSEI2,
                SDCT002.ITEM_ZOKUSEI3,
                SDCT002.BRAND_KBN,
                SDCT002.URIAGE_SU,
                SDCT002.URIAGE_GAKU_ENKA,
                SDCT002.URIAGE_GAKU_GAIKA,
                SDCT002.URIAGE_GAKU_ZEI,
                SDCT002.SIIRE_TANKA,
                SDCT002.URIAGE_TANKA,
                SDCT002.COMMISSION_GAKU_ENKA,
                SDCT002.COMMISSION_GAKU_GAIKA,
                SDCT002.KAIJYO_UNCHIN_URIAGE_EN,
                SDCT002.KAIJYO_HOKEN_URIAGE_EN
            FROM SDCT002
        ) SEIKYU_DENPYO_MEISAI
            ON SEIKYU_DENPYO.SEIKYU_DENPYO_NO = SEIKYU_DENPYO_MEISAI.SEIKYU_DENPYO_NO
            AND SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN = SEIKYU_DENPYO_MEISAI.SEIKYU_DENPYO_NO_HAN
        /** èoâ◊ì`ï[ **/
        INNER JOIN (
            SELECT
                HEAD.SHUKKA_DENPYO_NO,
                MEISAI.ITEM_CD,
                HEAD.INCOTERMS1 TATENE_KBN,
                HEAD.KESSAI_JOKEN,
                MEISAI.TEGATA_NISSU,
                CASE WHEN MEISAI.ITEM_ZOKUSEI3 = ''02''
                    THEN MEISAI.SIIRE_GAKU_ENKA
                    ELSE 0
                END SIIRE_GAKU_TAIWAN_ENKA,
                CASE WHEN MEISAI.ITEM_ZOKUSEI3 = ''02''
                    THEN MEISAI.SIIRE_GAKU_GAIKA
                    ELSE 0
                END SIIRE_GAKU_TAIWAN_GAIKA
            FROM SDCT001 HEAD
            INNER JOIN (
                SELECT
                    SDCT001.SEIKYU_DENPYO_NO,
                    MAX(CAST(SDCT001.SEIKYU_DENPYO_NO_HAN AS int)) AS SEIKYU_DENPYO_NO_HAN
                FROM SDCT001
                WHERE
                    SDCT001.SEIKYU_DENPYO_TYPE = ''Z3F2''
                GROUP BY
                    SDCT001.SEIKYU_DENPYO_NO
            ) DENPYO_LATEST
                ON HEAD.SEIKYU_DENPYO_NO = DENPYO_LATEST.SEIKYU_DENPYO_NO
                AND HEAD.SEIKYU_DENPYO_NO_HAN = DENPYO_LATEST.SEIKYU_DENPYO_NO_HAN
                AND HEAD.SEIKYU_DENPYO_ST >= ''A''  -- TODO:êøãÅì`ï[ÉXÉeÅ[É^ÉX(è≥îF)
            INNER JOIN SDBT002 MEISAI
                ON HEAD.SHUKKA_DENPYO_NO = MEISAI.SHUKKA_DENPYO_NO
                AND HEAD.SHUKKA_DENPYO_NO_HAN = MEISAI.SHUKKA_DENPYO_NO_HAN
        ) SHUKKA_DENPYO
            ON SHUKKA_DENPYO.SHUKKA_DENPYO_NO = SEIKYU_DENPYO.SHUKKA_DENPYO_NO
        /** ï‘ïi **/
        LEFT OUTER JOIN (
            SELECT
                HEAD.SEIKYU_DENPYO_NO,
                MEISAI.ITEM_CD,
                MEISAI.URIAGE_SU,
                MEISAI.URIAGE_GAKU_ENKA,
                MEISAI.URIAGE_GAKU_GAIKA
            FROM SDCT001 HEAD
            INNER JOIN (
                SELECT
                    SDCT001.SEIKYU_DENPYO_NO,
                    MAX(CAST(SDCT001.SEIKYU_DENPYO_NO_HAN AS int)) AS SEIKYU_DENPYO_NO_HAN
                FROM SDCT001
                WHERE
                    SDCT001.SEIKYU_DENPYO_TYPE = ''Z3F2''
                GROUP BY
                    SDCT001.SEIKYU_DENPYO_NO
            ) DENPYO_LATEST
                ON HEAD.SEIKYU_DENPYO_NO = DENPYO_LATEST.SEIKYU_DENPYO_NO
                AND HEAD.SEIKYU_DENPYO_NO_HAN = DENPYO_LATEST.SEIKYU_DENPYO_NO_HAN
                AND HEAD.SEIKYU_DENPYO_ST >= ''A''  -- TODO:êøãÅì`ï[ÉXÉeÅ[É^ÉX(è≥îF)
            INNER JOIN SDCT002 MEISAI
                ON HEAD.SHUKKA_DENPYO_NO = MEISAI.SHUKKA_DENPYO_NO
                AND HEAD.SHUKKA_DENPYO_NO_HAN = MEISAI.SHUKKA_DENPYO_NO_HAN
        ) HENPIN
            ON HENPIN.SEIKYU_DENPYO_NO = SEIKYU_DENPYO.AKA_KURO_SOUSAI_DENPYO_NO
            AND HENPIN.ITEM_CD = SEIKYU_DENPYO_MEISAI.ITEM_CD
        /** ílà¯ **/
        LEFT OUTER JOIN (
            SELECT
                HEAD.SANSHO_SEIKYU_DENPYO_NO,
                MEISAI.ITEM_CD,
                MEISAI.NEBIKI_GAKU NEBIKI_GAKU_ENKA,
                CASE WHEN HEAD.URIAGE_KANSAN_RATE = 0
                    THEN 0
                    ELSE MEISAI.NEBIKI_GAKU / HEAD.URIAGE_KANSAN_RATE
                END NEBIKI_GAKU_GAIKA
            FROM SDCT004 HEAD
            INNER JOIN (
                SELECT
                    SDCT004.URIAGE_HOSOKU_DENPYO_NO,
                    MAX(CAST(SDCT004.URIAGE_HOSOKU_DENPYO_HAN AS int)) URIAGE_HOSOKU_DENPYO_HAN
                FROM SDCT004
                WHERE
                    SDCT004.URIAGE_HOSOKU_DENPYO_TYPE = ''1''
                GROUP BY
                    SDCT004.URIAGE_HOSOKU_DENPYO_NO
            ) LATEST
                ON HEAD.URIAGE_HOSOKU_DENPYO_NO = LATEST.URIAGE_HOSOKU_DENPYO_NO
                AND HEAD.URIAGE_HOSOKU_DENPYO_HAN = LATEST.URIAGE_HOSOKU_DENPYO_HAN
                AND HEAD.URIAGE_HOSOKU_DENPYO_ST >= ''A''  -- TODO:îÑè„ï‚ë´ì`ï[ÉXÉeÅ[É^ÉX(è≥îF)
            INNER JOIN SDCT005 MEISAI
                ON HEAD.URIAGE_HOSOKU_DENPYO_NO = MEISAI.URIAGE_HOSOKU_DENPYO_NO
                AND HEAD.URIAGE_HOSOKU_DENPYO_HAN = MEISAI.URIAGE_HOSOKU_DENPYO_HAN
        ) NEBIKI
            ON NEBIKI.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO_MEISAI.SEIKYU_DENPYO_NO
            AND NEBIKI.ITEM_CD = SEIKYU_DENPYO_MEISAI.ITEM_CD
        /** ílëù **/
        LEFT OUTER JOIN (
            SELECT
                HEAD.SANSHO_SEIKYU_DENPYO_NO,
                MEISAI.ITEM_CD,
                MEISAI.NEBIKI_GAKU NEMASI_GAKU_ENKA,
                CASE WHEN HEAD.URIAGE_KANSAN_RATE = 0
                    THEN 0
                    ELSE MEISAI.NEBIKI_GAKU / HEAD.URIAGE_KANSAN_RATE
                END NEMASI_GAKU_GAIKA
            FROM SDCT004 HEAD
            INNER JOIN (
                SELECT
                    SDCT004.URIAGE_HOSOKU_DENPYO_NO,
                    MAX(CAST(SDCT004.URIAGE_HOSOKU_DENPYO_HAN AS int)) URIAGE_HOSOKU_DENPYO_HAN
                FROM SDCT004
                WHERE
                    SDCT004.URIAGE_HOSOKU_DENPYO_TYPE = ''2''
                GROUP BY
                    SDCT004.URIAGE_HOSOKU_DENPYO_NO
            ) LATEST
                ON HEAD.URIAGE_HOSOKU_DENPYO_NO = LATEST.URIAGE_HOSOKU_DENPYO_NO
                AND HEAD.URIAGE_HOSOKU_DENPYO_HAN = LATEST.URIAGE_HOSOKU_DENPYO_HAN
                AND HEAD.URIAGE_HOSOKU_DENPYO_ST >= ''A''  -- TODO:îÑè„ï‚ë´ì`ï[ÉXÉeÅ[É^ÉX(è≥îF)
            INNER JOIN SDCT005 MEISAI
                ON HEAD.URIAGE_HOSOKU_DENPYO_NO = MEISAI.URIAGE_HOSOKU_DENPYO_NO
                AND HEAD.URIAGE_HOSOKU_DENPYO_HAN = MEISAI.URIAGE_HOSOKU_DENPYO_HAN
        ) NEMASI
            ON NEMASI.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO_MEISAI.SEIKYU_DENPYO_NO
            AND NEMASI.ITEM_CD = SEIKYU_DENPYO_MEISAI.ITEM_CD
        /** âcã∆íSìñé“ **/
        INNER JOIN SDHM001 TANTO_MASTER
            ON TANTO_MASTER.TOKUISAKI_SYUBETU = ''2''
            AND TANTO_MASTER.TOKUISAKI_CD = SEIKYU_DENPYO.EIGYO_TANTO_ID
            AND TANTO_MASTER.YUKO_STA_YMD <= SEIKYU_DENPYO.DENPYO_KIJUN_YMD
            AND TANTO_MASTER.YUKO_END_YMD >= SEIKYU_DENPYO.DENPYO_KIJUN_YMD
        /** ïiñ⁄É}ÉXÉ^ **/
        INNER JOIN SDHM003 HINMOKU_MASTER
            ON HINMOKU_MASTER.SYS_ID = SEIKYU_DENPYO.SYS_ID
            AND HINMOKU_MASTER.TOKUISAKI_CD = SEIKYU_DENPYO_MEISAI.ITEM_SANSHO_TOKUISAKI_CD
            AND HINMOKU_MASTER.ITEM_CD = SEIKYU_DENPYO_MEISAI.ITEM_CD
        /** ìæà”êÊ **/
        INNER JOIN SDHM001 TOKUISAKI_MASTER
            ON TOKUISAKI_MASTER.TOKUISAKI_SYUBETU = ''1''
            AND TOKUISAKI_MASTER.TOKUISAKI_CD = SEIKYU_DENPYO.TOKUISAKI_CD
            AND TOKUISAKI_MASTER.YUKO_STA_YMD <= SEIKYU_DENPYO.DENPYO_KIJUN_YMD
            AND TOKUISAKI_MASTER.YUKO_END_YMD >= SEIKYU_DENPYO.DENPYO_KIJUN_YMD
        /** ïîñÂÉ}ÉXÉ^ **/
        INNER JOIN SDHM014 BMN_MASTER
            ON BMN_MASTER.KOMOKU_CD = ''SDZ024''
            AND BMN_MASTER.SAIMOKU_CD01 = ''10''
            AND BMN_MASTER.SAIMOKU_CD02 = TANTO_MASTER.BMN_CD
            AND BMN_MASTER.YUKO_STA_YMD <= SEIKYU_DENPYO.DENPYO_KIJUN_YMD
            AND BMN_MASTER.YUKO_END_YMD >= SEIKYU_DENPYO.DENPYO_KIJUN_YMD
        /** çëñºÉ}ÉXÉ^ **/
        INNER JOIN SDHM014 CTRY_MASTER
            ON CTRY_MASTER.KOMOKU_CD = ''SDZ002''
            AND CTRY_MASTER.SAIMOKU_CD01 = TOKUISAKI_MASTER.TOKUISAKI_CTRY_CD
            AND CTRY_MASTER.SAIMOKU_CD02 = ''00''
            AND CTRY_MASTER.YUKO_STA_YMD <= SEIKYU_DENPYO.DENPYO_KIJUN_YMD
            AND CTRY_MASTER.YUKO_END_YMD >= SEIKYU_DENPYO.DENPYO_KIJUN_YMD
    ) SEIKYU_DENPYO

    FULL JOIN

    /** éÛíçì`ï[ **/
    (
        SELECT
            CASE WHEN BMN_MASTER.CHR_KOMOKU04 = ''04''
                THEN BMN_MASTER.CHR_KOMOKU05
                ELSE BMN_MASTER.SAIMOKU_CD02
            END OYA_BMN_CD,
            TANTO_MASTER.BMN_CD,
            JUCHU_DENPYO.EIGYO_TANTO_ID,
            TOKUISAKI_MASTER.TOKUISAKI_SHUKEI_GRP,
            JUCHU_DENPYO.TOKUISAKI_CD,
            TOKUISAKI_MASTER.TOKUISAKI_CTRY_CD,
            CTRY_MASTER.CHR_KOMOKU03 AREA_CD,
            HINMOKU_MASTER.ITEM_ZOKUSEI3 SEISAN_KBN,
            HINMOKU_MASTER.KAMOKU_KBN,
            -- TODO:îÑè„èWåvãÊï™
            JUCHU_DENPYO_MEISAI.BRAND_KBN,
            JUCHU_DENPYO_MEISAI.ITEM_BUNRUI,
            JUCHU_DENPYO_MEISAI.ITEM_KBN,
            JUCHU_DENPYO_MEISAI.ITEM_ZOKUSEI1,
            JUCHU_DENPYO_MEISAI.ITEM_ZOKUSEI2,
            HINMOKU_MASTER.SEIZO_KATASIKI,
            HINMOKU_MASTER.HANBAI_KOSHO,
            TANTO_MASTER.TANTO_JIGYOSHO_CD JIGYOSHO_EIGYOSHO_CD,
            JUCHU_DENPYO_MEISAI.URIAGE_SU,
            JUCHU_DENPYO.URIAGE_KANSAN_RATE,
            JUCHU_DENPYO_MEISAI.URIAGE_GAKU_ENKA,
            JUCHU_DENPYO_MEISAI.URIAGE_GAKU_GAIKA,
            CASE WHEN JUCHU_DENPYO.URIAGE_TUKA_CD = ''JPY''
                THEN JUCHU_DENPYO_MEISAI.NEBIKI_GAKU
                ELSE JUCHU_DENPYO_MEISAI.NEBIKI_GAKU / JUCHU_DENPYO.URIAGE_KANSAN_RATE
            END NEBIKI_GAKU_ENKA,
            CASE WHEN JUCHU_DENPYO.URIAGE_TUKA_CD = ''JPY''
                THEN JUCHU_DENPYO_MEISAI.NEBIKI_GAKU / JUCHU_DENPYO.URIAGE_KANSAN_RATE
                ELSE JUCHU_DENPYO_MEISAI.NEBIKI_GAKU
            END NEBIKI_GAKU_GAIKA,
            JUCHU_DENPYO_MEISAI.URIAGE_GAKU_ZEI,
            CASE WHEN JUCHU_DENPYO.URIAGE_TUKA_CD = ''JPY''
                THEN JUCHU_DENPYO_MEISAI.URIAGE_TANKA
                ELSE JUCHU_DENPYO_MEISAI.URIAGE_TANKA / JUCHU_DENPYO.URIAGE_KANSAN_RATE
            END URIAGE_TANKA,
            CASE WHEN JUCHU_DENPYO.URIAGE_TUKA_CD = ''JPY''
                THEN JUCHU_DENPYO_MEISAI.URIAGE_TANKA / JUCHU_DENPYO.URIAGE_KANSAN_RATE
                ELSE JUCHU_DENPYO_MEISAI.URIAGE_TANKA
            END URIAGE_TANKA_GAIKA,
            JUCHU_DENPYO_MEISAI.GENKA,
            JUCHU_DENPYO_MEISAI.GENKA / JUCHU_DENPYO.URIAGE_KANSAN_RATE GENKA_GAIKA,
            JUCHU_DENPYO.INCOTERMS1 TATENE_KBN,
            JUCHU_DENPYO.KESSAI_JOKEN,
            JUCHU_DENPYO_MEISAI.TEGATA_NISSU,
            JUCHU_DENPYO.URIAGE_TUKA_CD,
            JUCHU_DENPYO_MEISAI.COMMISSION_GAKU_ENKA,
            JUCHU_DENPYO_MEISAI.COMMISSION_GAKU_GAIKA
        FROM SDAT009 JUCHU_DENPYO
        INNER JOIN (
            SELECT
                SDAT009.JUCHU_DENPYO_NO,
                MAX(CAST(SDAT009.JUCHU_DENPYO_NO_HAN AS int)) JUCHU_DENPYO_NO_HAN
            FROM SDAT009
            WHERE
                SDAT009.URIAGE_KEIJO_YMD >= @start_date
                AND SDAT009.URIAGE_KEIJO_YMD < @end_date
                AND SDAT009.JUCHU_DENPYO_TYPE = ''Z3OR''
            GROUP BY
                SDAT009.JUCHU_DENPYO_NO
        ) JUCHU_DENPYO_LATEST
            ON JUCHU_DENPYO_LATEST.JUCHU_DENPYO_NO = JUCHU_DENPYO.JUCHU_DENPYO_NO
            AND JUCHU_DENPYO_LATEST.JUCHU_DENPYO_NO_HAN = JUCHU_DENPYO.JUCHU_DENPYO_NO_HAN
            AND JUCHU_DENPYO.JUCHU_DENPYO_ST >= ''A''  -- TODO:éÛíçì`ï[ÉXÉeÅ[É^ÉX(è≥îF)
        INNER JOIN SDAT010 JUCHU_DENPYO_MEISAI
            ON JUCHU_DENPYO_MEISAI.JUCHU_DENPYO_NO = JUCHU_DENPYO.JUCHU_DENPYO_NO
            AND JUCHU_DENPYO_MEISAI.JUCHU_DENPYO_NO_HAN = JUCHU_DENPYO.JUCHU_DENPYO_NO_HAN
        /** âcã∆íSìñé“ **/
        INNER JOIN SDHM001 TANTO_MASTER
            ON TANTO_MASTER.TOKUISAKI_SYUBETU = ''2''
            AND TANTO_MASTER.TOKUISAKI_CD = JUCHU_DENPYO.EIGYO_TANTO_ID
            AND TANTO_MASTER.YUKO_STA_YMD <= JUCHU_DENPYO.DENPYO_KIJUN_YMD
            AND TANTO_MASTER.YUKO_END_YMD >= JUCHU_DENPYO.DENPYO_KIJUN_YMD
        /** ïiñ⁄É}ÉXÉ^ **/
        INNER JOIN SDHM003 HINMOKU_MASTER
            ON HINMOKU_MASTER.SYS_ID = JUCHU_DENPYO.SYS_ID
            AND HINMOKU_MASTER.TOKUISAKI_CD = JUCHU_DENPYO_MEISAI.ITEM_SANSHO_TOKUISAKI_CD
            AND HINMOKU_MASTER.ITEM_CD = JUCHU_DENPYO_MEISAI.ITEM_CD
            AND HINMOKU_MASTER.YUKO_STA_YMD <= JUCHU_DENPYO.DENPYO_KIJUN_YMD
            AND HINMOKU_MASTER.YUKO_END_YMD >= JUCHU_DENPYO.DENPYO_KIJUN_YMD
        /** ìæà”êÊ **/
        INNER JOIN SDHM001 TOKUISAKI_MASTER
            ON TOKUISAKI_MASTER.TOKUISAKI_SYUBETU = ''1''
            AND TOKUISAKI_MASTER.TOKUISAKI_CD = JUCHU_DENPYO.TOKUISAKI_CD
            AND TOKUISAKI_MASTER.YUKO_STA_YMD <= JUCHU_DENPYO.DENPYO_KIJUN_YMD
            AND TOKUISAKI_MASTER.YUKO_END_YMD >= JUCHU_DENPYO.DENPYO_KIJUN_YMD
        /** ïîñÂÉ}ÉXÉ^ **/
        INNER JOIN SDHM014 BMN_MASTER
            ON BMN_MASTER.KOMOKU_CD = ''SDZ024''
            AND BMN_MASTER.SAIMOKU_CD01 = ''10''
            AND BMN_MASTER.SAIMOKU_CD02 = TANTO_MASTER.BMN_CD
            AND BMN_MASTER.YUKO_STA_YMD <= JUCHU_DENPYO.DENPYO_KIJUN_YMD
            AND BMN_MASTER.YUKO_END_YMD >= JUCHU_DENPYO.DENPYO_KIJUN_YMD
        /** çëñºÉ}ÉXÉ^ **/
        INNER JOIN SDHM014 CTRY_MASTER
            ON CTRY_MASTER.KOMOKU_CD = ''SDZ002''
            AND CTRY_MASTER.SAIMOKU_CD01 = TOKUISAKI_MASTER.TOKUISAKI_CTRY_CD
            AND CTRY_MASTER.SAIMOKU_CD02 = ''00''
            AND CTRY_MASTER.YUKO_STA_YMD <= JUCHU_DENPYO.DENPYO_KIJUN_YMD
            AND CTRY_MASTER.YUKO_END_YMD >= JUCHU_DENPYO.DENPYO_KIJUN_YMD
    ) JUCHU_DENPYO
        ON JUCHU_DENPYO.BMN_CD = SEIKYU_DENPYO.BMN_CD
        AND JUCHU_DENPYO.EIGYO_TANTO_ID = SEIKYU_DENPYO.EIGYO_TANTO_ID
        AND JUCHU_DENPYO.TOKUISAKI_CD = SEIKYU_DENPYO.TOKUISAKI_CD
        AND JUCHU_DENPYO.SEISAN_KBN = SEIKYU_DENPYO.SEISAN_KBN
        AND JUCHU_DENPYO.KAMOKU_KBN = SEIKYU_DENPYO.KAMOKU_KBN
        -- TODO:îÑè„èWåvãÊï™
        AND JUCHU_DENPYO.BRAND_KBN = SEIKYU_DENPYO.BRAND_KBN
        AND JUCHU_DENPYO.ITEM_BUNRUI = SEIKYU_DENPYO.ITEM_BUNRUI
        AND JUCHU_DENPYO.ITEM_KBN = SEIKYU_DENPYO.ITEM_KBN
        AND JUCHU_DENPYO.ITEM_ZOKUSEI1 = SEIKYU_DENPYO.ITEM_ZOKUSEI1
        AND JUCHU_DENPYO.ITEM_ZOKUSEI2 = SEIKYU_DENPYO.ITEM_ZOKUSEI2
        AND JUCHU_DENPYO.TATENE_KBN = SEIKYU_DENPYO.TATENE_KBN
        AND JUCHU_DENPYO.KESSAI_JOKEN = SEIKYU_DENPYO.KESSAI_JOKEN
        AND JUCHU_DENPYO.URIAGE_TUKA_CD = SEIKYU_DENPYO.URIAGE_TUKA_CD

    FULL JOIN

    /** ó\éZ **/
    (
        SELECT
            CASE WHEN BMN_MASTER.CHR_KOMOKU04 = ''04''
                THEN BMN_MASTER.CHR_KOMOKU05
                ELSE BMN_MASTER.SAIMOKU_CD02
            END OYA_BMN_CD,
            TAISHO_YOSAN.BMN_CD,
            TAISHO_YOSAN.TANTO_CD EIGYO_TANTO_ID,
            TAISHO_YOSAN.TOKUISAKI_CD,
            TOKUISAKI_MASTER.TOKUISAKI_SHUKEI_GRP,
            TOKUISAKI_MASTER.TOKUISAKI_CTRY_CD,
            CTRY_MASTER.CHR_KOMOKU03 AREA_CD,
            HINMOKU_MASTER.ITEM_ZOKUSEI3 SEISAN_KBN,
            HINMOKU_MASTER.KAMOKU_KBN,
            -- TODO:îÑè„èWåvãÊï™
            HINMOKU_MASTER.BRAND_KBN,
            HINMOKU_MASTER.ITEM_BUNRUI,
            TAISHO_YOSAN.ITEM_KBN,
            HINMOKU_MASTER.ITEM_ZOKUSEI1,
            HINMOKU_MASTER.ITEM_ZOKUSEI2,
            YOSAN_RATE.TTM,
            HINMOKU_MASTER.SEIZO_KATASIKI,
            HINMOKU_MASTER.HANBAI_KOSHO,
            TAISHO_YOSAN.URIAGE_SURYO URIAGE_SU,
            CASE WHEN TAISHO_YOSAN.URIAGE_TUKA_CD = ''JPY''
                THEN TAISHO_YOSAN.URIAGE_KINGAKU
                ELSE TAISHO_YOSAN.URIAGE_KINGAKU * YOSAN_RATE.TTM
            END URIAGE_GAKU,
            CASE WHEN TAISHO_YOSAN.URIAGE_TUKA_CD = ''JPY''
                THEN TAISHO_YOSAN.URIAGE_KINGAKU / YOSAN_RATE.TTM
                ELSE TAISHO_YOSAN.URIAGE_KINGAKU
            END URIAGE_GAKU_GAIKA,
            TAISHO_YOSAN.GENKA,
            TAISHO_YOSAN.GENKA / YOSAN_RATE.TTM GENKA_GAIKA,
            TAISHO_YOSAN.INCOTERMS1 TATENE_KBN,
            TAISHO_YOSAN.KESSAI_JOKEN_KBN KESSAI_JOKEN,
            TAISHO_YOSAN.TEGATA_NISSU,
            TAISHO_YOSAN.URIAGE_TUKA_CD,
            TAISHO_YOSAN.COMMISSION_TANKA,
            TAISHO_YOSAN.COMMISSION_TANKA / YOSAN_RATE.TTM COMMISSION_TANKA_GAIKA,
            TAISHO_YOSAN.TUKA_CD,
            TANTO_MASTER.TANTO_JIGYOSHO_CD JIGYOSHO_EIGYOSHO_CD,
            CASE WHEN TAISHO_YOSAN.URIAGE_TUKA_CD = ''JPY''
                THEN TAISHO_YOSAN.URI_TANKA
                ELSE TAISHO_YOSAN.URI_TANKA * YOSAN_RATE.TTM
            END URIAGE_TANKA,
            CASE WHEN TAISHO_YOSAN.URIAGE_TUKA_CD = ''JPY''
                THEN TAISHO_YOSAN.URI_TANKA / YOSAN_RATE.TTM
                ELSE TAISHO_YOSAN.URI_TANKA
            END URIAGE_TANKA_GAIKA
        FROM TAISHO_YOSAN
        /** ó\éZÉåÅ[ÉgÉ}ÉXÉ^ **/
        INNER JOIN SDFM002 YOSAN_RATE
            ON YOSAN_RATE.NENDO = TAISHO_YOSAN.NENDO
            AND YOSAN_RATE.YOSAN_KBN = TAISHO_YOSAN.YOSAN_KBN
            AND YOSAN_RATE.KAMIKI_SIMOKI_KBN =
              CASE WHEN CONVERT(INT, TAISHO_YOSAN.TUKI) BETWEEN 4 AND 9
                   THEN ''1''
                   ELSE ''2''
              END
            AND YOSAN_RATE.TUKA_CD = TAISHO_YOSAN.TUKA_CD
        /** âcã∆íSìñé“ **/
        INNER JOIN SDHM001 TANTO_MASTER
            ON TANTO_MASTER.TOKUISAKI_SYUBETU = ''2''
            AND TANTO_MASTER.TOKUISAKI_CD = TAISHO_YOSAN.TANTO_CD
            AND TANTO_MASTER.YUKO_STA_YMD <= TAISHO_YOSAN.KIJUN_YMD
            AND TANTO_MASTER.YUKO_END_YMD >= TAISHO_YOSAN.KIJUN_YMD
        /** ïiñ⁄É}ÉXÉ^ **/
        INNER JOIN SDHM003 HINMOKU_MASTER
            ON HINMOKU_MASTER.SYS_ID = TAISHO_YOSAN.SYS_ID
            AND HINMOKU_MASTER.TOKUISAKI_CD = TAISHO_YOSAN.ITEM_SANSHO_TOKUISAKI_CD
            AND HINMOKU_MASTER.ITEM_CD = TAISHO_YOSAN.ITEM_CD
            AND HINMOKU_MASTER.YUKO_STA_YMD <= TAISHO_YOSAN.KIJUN_YMD
            AND HINMOKU_MASTER.YUKO_END_YMD >= TAISHO_YOSAN.KIJUN_YMD
        /** ìæà”êÊ **/
        INNER JOIN SDHM001 TOKUISAKI_MASTER
            ON TOKUISAKI_MASTER.TOKUISAKI_SYUBETU = ''1''
            AND TOKUISAKI_MASTER.TOKUISAKI_CD = TAISHO_YOSAN.TOKUISAKI_CD
            AND TOKUISAKI_MASTER.YUKO_STA_YMD <= TAISHO_YOSAN.KIJUN_YMD
            AND TOKUISAKI_MASTER.YUKO_END_YMD >= TAISHO_YOSAN.KIJUN_YMD
        /** ïîñÂÉ}ÉXÉ^ **/
        INNER JOIN SDHM014 BMN_MASTER
            ON BMN_MASTER.KOMOKU_CD = ''SDZ024''
            AND BMN_MASTER.SAIMOKU_CD01 = ''10''
            AND BMN_MASTER.SAIMOKU_CD02 = TAISHO_YOSAN.BMN_CD
            AND BMN_MASTER.YUKO_STA_YMD <= TAISHO_YOSAN.KIJUN_YMD
            AND BMN_MASTER.YUKO_END_YMD >= TAISHO_YOSAN.KIJUN_YMD
        /** çëñºÉ}ÉXÉ^ **/
        INNER JOIN SDHM014 CTRY_MASTER
            ON CTRY_MASTER.KOMOKU_CD = ''SDZ002''
            AND CTRY_MASTER.SAIMOKU_CD01 = TOKUISAKI_MASTER.TOKUISAKI_CTRY_CD
            AND CTRY_MASTER.SAIMOKU_CD02 = ''00''
            AND CTRY_MASTER.YUKO_STA_YMD <= TAISHO_YOSAN.KIJUN_YMD
            AND CTRY_MASTER.YUKO_END_YMD >= TAISHO_YOSAN.KIJUN_YMD
        WHERE
            TAISHO_YOSAN.NENDO = @nendo
            AND TAISHO_YOSAN.TUKI = @tuki
    ) YOSAN
        ON (
            YOSAN.BMN_CD = SEIKYU_DENPYO.BMN_CD
            AND YOSAN.EIGYO_TANTO_ID = SEIKYU_DENPYO.EIGYO_TANTO_ID
            AND YOSAN.TOKUISAKI_CD = SEIKYU_DENPYO.TOKUISAKI_CD
            AND YOSAN.SEISAN_KBN = SEIKYU_DENPYO.SEISAN_KBN
            AND YOSAN.KAMOKU_KBN = SEIKYU_DENPYO.KAMOKU_KBN
            -- TODO:îÑè„èWåvãÊï™
            AND YOSAN.BRAND_KBN = SEIKYU_DENPYO.BRAND_KBN
            AND YOSAN.ITEM_BUNRUI = SEIKYU_DENPYO.ITEM_BUNRUI
            AND YOSAN.ITEM_KBN = SEIKYU_DENPYO.ITEM_KBN
            AND YOSAN.ITEM_ZOKUSEI1 = SEIKYU_DENPYO.ITEM_ZOKUSEI1
            AND YOSAN.ITEM_ZOKUSEI2 = SEIKYU_DENPYO.ITEM_ZOKUSEI2
            AND YOSAN.TATENE_KBN = SEIKYU_DENPYO.TATENE_KBN
            AND YOSAN.KESSAI_JOKEN = SEIKYU_DENPYO.KESSAI_JOKEN
            AND YOSAN.URIAGE_TUKA_CD = SEIKYU_DENPYO.URIAGE_TUKA_CD
        ) OR (
            YOSAN.BMN_CD = JUCHU_DENPYO.BMN_CD
            AND YOSAN.EIGYO_TANTO_ID = JUCHU_DENPYO.EIGYO_TANTO_ID
            AND YOSAN.TOKUISAKI_CD = JUCHU_DENPYO.TOKUISAKI_CD
            AND YOSAN.SEISAN_KBN = JUCHU_DENPYO.SEISAN_KBN
            AND YOSAN.KAMOKU_KBN = JUCHU_DENPYO.KAMOKU_KBN
            -- TODO:îÑè„èWåvãÊï™
            AND YOSAN.BRAND_KBN = JUCHU_DENPYO.BRAND_KBN
            AND YOSAN.ITEM_BUNRUI = JUCHU_DENPYO.ITEM_BUNRUI
            AND YOSAN.ITEM_KBN = JUCHU_DENPYO.ITEM_KBN
            AND YOSAN.ITEM_ZOKUSEI1 = JUCHU_DENPYO.ITEM_ZOKUSEI1
            AND YOSAN.ITEM_ZOKUSEI2 = JUCHU_DENPYO.ITEM_ZOKUSEI2
            AND YOSAN.TATENE_KBN = JUCHU_DENPYO.TATENE_KBN
            AND YOSAN.KESSAI_JOKEN = JUCHU_DENPYO.KESSAI_JOKEN
            AND YOSAN.URIAGE_TUKA_CD = JUCHU_DENPYO.URIAGE_TUKA_CD
        )

    FULL JOIN
    /** å©êœì`ï[ **/
    (
        SELECT
            CASE WHEN BMN_MASTER.CHR_KOMOKU04 = ''04''
                THEN BMN_MASTER.CHR_KOMOKU05
                ELSE BMN_MASTER.SAIMOKU_CD02
            END OYA_BMN_CD,
            TANTO_MASTER.BMN_CD,    -- ïîñÂÉRÅ[Éh
            MITSUMORI_DENPYO.EIGYO_TANTO_ID,    -- íSìñé“ÉRÅ[Éh
            MITSUMORI_DENPYO.TOKUISAKI_CD,    -- ìæà”êÊÉRÅ[Éh
            HINMOKU_MASTER.ITEM_ZOKUSEI3 SEISAN_KBN,    -- ê∂éYãÊï™
            HINMOKU_MASTER.KAMOKU_KBN,    -- â»ñ⁄ãÊï™
            MITSUMORI_DENPYO_MEISAI.BRAND_KBN,    -- ÉuÉâÉìÉhãÊï™
            MITSUMORI_DENPYO_MEISAI.ITEM_BUNRUI,    -- ïiñ⁄ï™óﬁ
            MITSUMORI_DENPYO_MEISAI.ITEM_KBN,    -- ïiñ⁄ãÊï™
            MITSUMORI_DENPYO_MEISAI.ITEM_ZOKUSEI1,    -- ïiñ⁄ëÆê´1
            MITSUMORI_DENPYO_MEISAI.ITEM_ZOKUSEI2,    -- ïiñ⁄ëÆê´2
            MITSUMORI_DENPYO.INCOTERMS1 TATENE_KBN,    -- åöílãÊï™
            MITSUMORI_DENPYO.KESSAI_JOKEN,    -- åàçœèåè
            MITSUMORI_DENPYO.URIAGE_TUKA_CD,    -- îÑè„í â›ÉRÅ[Éh
            TOKUISAKI_MASTER.TOKUISAKI_SHUKEI_GRP,     -- ìæà”êÊÉOÉãÅ[ÉvÉRÅ[Éh
            TOKUISAKI_MASTER.TOKUISAKI_CTRY_CD,    -- ìæà”êÊçëÉRÅ[Éh
            HINMOKU_MASTER.SEIZO_KATASIKI,    -- êªë¢å^éÆ
            HINMOKU_MASTER.HANBAI_KOSHO,    -- îÃîÑåƒèÃ
            CTRY_MASTER.CHR_KOMOKU03 AREA_CD,    -- ínàÊÉRÅ[Éh
            TANTO_MASTER.TANTO_JIGYOSHO_CD JIGYOSHO_EIGYOSHO_CD,    -- éñã∆èä/âcã∆èäÉRÅ[Éh
            MITSUMORI_DENPYO_MEISAI.TEGATA_NISSU,    -- éËå`ì˙êî
            MITSUMORI_DENPYO_MEISAI.URIAGE_SU,    -- îÑè„êîó 
            MITSUMORI_DENPYO_MEISAI.URIAGE_GAKU_ENKA,    -- îÑè„ã‡äz(â~â›)
            MITSUMORI_DENPYO_MEISAI.URIAGE_GAKU_GAIKA,    -- îÑè„ã‡äz(äOâ›)
            CASE WHEN MITSUMORI_DENPYO.URIAGE_TUKA_CD = ''JPY''
                THEN MITSUMORI_DENPYO_MEISAI.NEBIKI_GAKU + MITSUMORI_DENPYO_MEISAI.NEBIKI_HAIBUN_GAKU
                ELSE (MITSUMORI_DENPYO_MEISAI.NEBIKI_GAKU + MITSUMORI_DENPYO_MEISAI.NEBIKI_HAIBUN_GAKU) * MITSUMORI_DENPYO.URIAGE_KANSAN_RATE
            END NEBIKI_GAKU_ENKA,    -- äÑà¯ã‡äz
            CASE WHEN MITSUMORI_DENPYO.URIAGE_TUKA_CD = ''JPY''
                THEN NULL
                ELSE MITSUMORI_DENPYO_MEISAI.NEBIKI_GAKU + MITSUMORI_DENPYO_MEISAI.NEBIKI_HAIBUN_GAKU
            END NEBIKI_GAKU_GAIKA,    -- äÑà¯ã‡äz(äOâ›)
            MITSUMORI_DENPYO.URIAGE_KANSAN_RATE,    -- à◊ë÷ÉåÅ[Ég
            MITSUMORI_DENPYO_MEISAI.COMMISSION_GAKU_ENKA,    -- ÉRÉ~ÉbÉVÉáÉìíPâø
            MITSUMORI_DENPYO_MEISAI.COMMISSION_GAKU_GAIKA,    -- ÉRÉ~ÉbÉVÉáÉìíPâø(äOâ›)
            MITSUMORI_DENPYO_MEISAI.SIIRE_TUKA_CD    -- édì¸í â›ÉRÅ[Éh
        FROM SDAT005 MITSUMORI_DENPYO
        INNER JOIN (
            SELECT
                SDAT005.MITSUMORI_DENPYO_NO,
                MAX(CAST(SDAT005.MITSUMORI_DENPYO_NO_HAN AS int)) MITSUMORI_DENPYO_NO_HAN
            FROM SDAT005
            WHERE
                SDAT005.URIAGE_KEIJO_YMD >= @start_date
                AND SDAT005.URIAGE_KEIJO_YMD < @end_date
                AND SDAT005.JUCHU_KAKUDO <= ''C''    -- TODO:éÛíçämìx(âº)
            GROUP BY
                SDAT005.MITSUMORI_DENPYO_NO
        ) MITSUMORI_DENPYO_LATEST
            ON MITSUMORI_DENPYO.MITSUMORI_DENPYO_NO = MITSUMORI_DENPYO_LATEST.MITSUMORI_DENPYO_NO
            AND MITSUMORI_DENPYO.MITSUMORI_DENPYO_NO_HAN = MITSUMORI_DENPYO_LATEST.MITSUMORI_DENPYO_NO_HAN
        INNER JOIN SDAT006 MITSUMORI_DENPYO_MEISAI
            ON MITSUMORI_DENPYO_MEISAI.MITSUMORI_DENPYO_NO = MITSUMORI_DENPYO.MITSUMORI_DENPYO_NO
            AND MITSUMORI_DENPYO_MEISAI.MITSUMORI_DENPYO_NO_HAN = MITSUMORI_DENPYO.MITSUMORI_DENPYO_NO_HAN
        /** âcã∆íSìñé“ **/
        INNER JOIN SDHM001 TANTO_MASTER
            ON TANTO_MASTER.TOKUISAKI_SYUBETU = ''2''
            AND TANTO_MASTER.TOKUISAKI_CD = MITSUMORI_DENPYO.EIGYO_TANTO_ID
            AND TANTO_MASTER.YUKO_STA_YMD <= MITSUMORI_DENPYO.DENPYO_KIJUN_YMD
            AND TANTO_MASTER.YUKO_END_YMD >= MITSUMORI_DENPYO.DENPYO_KIJUN_YMD
        /** ïiñ⁄É}ÉXÉ^ **/
        INNER JOIN SDHM003 HINMOKU_MASTER
            ON HINMOKU_MASTER.SYS_ID = MITSUMORI_DENPYO.SYS_ID
            AND HINMOKU_MASTER.TOKUISAKI_CD = MITSUMORI_DENPYO_MEISAI.ITEM_SANSHO_TOKUISAKI_CD
            AND HINMOKU_MASTER.ITEM_CD = MITSUMORI_DENPYO_MEISAI.ITEM_CD
            AND HINMOKU_MASTER.YUKO_STA_YMD <= MITSUMORI_DENPYO.DENPYO_KIJUN_YMD
            AND HINMOKU_MASTER.YUKO_END_YMD >= MITSUMORI_DENPYO.DENPYO_KIJUN_YMD
        /** ìæà”êÊ **/
        INNER JOIN SDHM001 TOKUISAKI_MASTER
            ON TOKUISAKI_MASTER.TOKUISAKI_SYUBETU = ''1''
            AND TOKUISAKI_MASTER.TOKUISAKI_CD = MITSUMORI_DENPYO.TOKUISAKI_CD
            AND TOKUISAKI_MASTER.YUKO_STA_YMD <= MITSUMORI_DENPYO.DENPYO_KIJUN_YMD
            AND TOKUISAKI_MASTER.YUKO_END_YMD >= MITSUMORI_DENPYO.DENPYO_KIJUN_YMD
        /** ïîñÂÉ}ÉXÉ^ **/
        INNER JOIN SDHM014 BMN_MASTER
            ON BMN_MASTER.KOMOKU_CD = ''SDZ024''
            AND BMN_MASTER.SAIMOKU_CD01 = ''10''
            AND BMN_MASTER.SAIMOKU_CD02 = TANTO_MASTER.BMN_CD
            AND BMN_MASTER.YUKO_STA_YMD <= MITSUMORI_DENPYO.DENPYO_KIJUN_YMD
            AND BMN_MASTER.YUKO_END_YMD >= MITSUMORI_DENPYO.DENPYO_KIJUN_YMD
        /** çëñºÉ}ÉXÉ^ **/
        INNER JOIN SDHM014 CTRY_MASTER
            ON CTRY_MASTER.KOMOKU_CD = ''SDZ002''
            AND CTRY_MASTER.SAIMOKU_CD01 = TOKUISAKI_MASTER.TOKUISAKI_CTRY_CD
            AND CTRY_MASTER.SAIMOKU_CD02 = ''00''
            AND CTRY_MASTER.YUKO_STA_YMD <= MITSUMORI_DENPYO.DENPYO_KIJUN_YMD
            AND CTRY_MASTER.YUKO_END_YMD >= MITSUMORI_DENPYO.DENPYO_KIJUN_YMD
    ) MITSUMORI
        ON
        (
            MITSUMORI.BMN_CD = SEIKYU_DENPYO.BMN_CD
            AND MITSUMORI.EIGYO_TANTO_ID = SEIKYU_DENPYO.EIGYO_TANTO_ID
            AND MITSUMORI.TOKUISAKI_CD = SEIKYU_DENPYO.TOKUISAKI_CD
            AND MITSUMORI.BRAND_KBN = SEIKYU_DENPYO.BRAND_KBN
            AND MITSUMORI.ITEM_BUNRUI = SEIKYU_DENPYO.ITEM_BUNRUI
            AND MITSUMORI.ITEM_KBN = SEIKYU_DENPYO.ITEM_KBN
            AND MITSUMORI.ITEM_ZOKUSEI1 = SEIKYU_DENPYO.ITEM_ZOKUSEI1
            AND MITSUMORI.ITEM_ZOKUSEI2 = SEIKYU_DENPYO.ITEM_ZOKUSEI2
            AND MITSUMORI.TATENE_KBN = SEIKYU_DENPYO.TATENE_KBN
            AND MITSUMORI.KESSAI_JOKEN = SEIKYU_DENPYO.KESSAI_JOKEN
            AND MITSUMORI.URIAGE_TUKA_CD = SEIKYU_DENPYO.URIAGE_TUKA_CD
        ) OR (
            MITSUMORI.BMN_CD = JUCHU_DENPYO.BMN_CD
            AND MITSUMORI.EIGYO_TANTO_ID = JUCHU_DENPYO.EIGYO_TANTO_ID
            AND MITSUMORI.TOKUISAKI_CD = JUCHU_DENPYO.TOKUISAKI_CD
            AND MITSUMORI.BRAND_KBN = JUCHU_DENPYO.BRAND_KBN
            AND MITSUMORI.ITEM_BUNRUI = JUCHU_DENPYO.ITEM_BUNRUI
            AND MITSUMORI.ITEM_KBN = JUCHU_DENPYO.ITEM_KBN
            AND MITSUMORI.ITEM_ZOKUSEI1 = JUCHU_DENPYO.ITEM_ZOKUSEI1
            AND MITSUMORI.ITEM_ZOKUSEI2 = JUCHU_DENPYO.ITEM_ZOKUSEI2
            AND MITSUMORI.TATENE_KBN = JUCHU_DENPYO.TATENE_KBN
            AND MITSUMORI.KESSAI_JOKEN = JUCHU_DENPYO.KESSAI_JOKEN
            AND MITSUMORI.URIAGE_TUKA_CD = JUCHU_DENPYO.URIAGE_TUKA_CD
        ) OR (
            MITSUMORI.BMN_CD = YOSAN.BMN_CD
            AND MITSUMORI.EIGYO_TANTO_ID = YOSAN.EIGYO_TANTO_ID
            AND MITSUMORI.TOKUISAKI_CD = YOSAN.TOKUISAKI_CD
            AND MITSUMORI.BRAND_KBN = YOSAN.BRAND_KBN
            AND MITSUMORI.ITEM_BUNRUI = YOSAN.ITEM_BUNRUI
            AND MITSUMORI.ITEM_KBN = YOSAN.ITEM_KBN
            AND MITSUMORI.ITEM_ZOKUSEI1 = YOSAN.ITEM_ZOKUSEI1
            AND MITSUMORI.ITEM_ZOKUSEI2 = YOSAN.ITEM_ZOKUSEI2
            AND MITSUMORI.TATENE_KBN = YOSAN.TATENE_KBN
            AND MITSUMORI.KESSAI_JOKEN = YOSAN.KESSAI_JOKEN
            AND MITSUMORI.URIAGE_TUKA_CD = YOSAN.URIAGE_TUKA_CD
        )

) DENPYO
GROUP BY
    OYA_BMN_CD,
    BMN_CD,
    EIGYO_TANTO_ID,
    TOKUISAKI_SHUKEI_GRP,
    TOKUISAKI_CD,
    SEIZO_KATASIKI,
    HANBAI_KOSHO,
    AREA_CD,
    TOKUISAKI_CTRY_CD,
    SEISAN_KBN,
    YOSAN_TUKA_CD,
    URIAGE_TUKA_CD,
    SIIRE_TUKA_CD,
    KAMOKU_KBN,
    BRAND_KBN,
    -- TODO:îÑè„èWåvãÊï™
    ITEM_BUNRUI,
    ITEM_KBN,
    ITEM_ZOKUSEI1,
    ITEM_ZOKUSEI2,
    JIGYOSHO_EIGYOSHO_CD

  END TRY

  BEGIN CATCH

    ROLLBACK TRANSACTION;
    RAISERROR ('''', 9, 1) WITH SETERROR, LOG;
    return (9);

  END CATCH

  COMMIT TRANSACTION;

' 
END
GO
/****** Object:  StoredProcedure [dbo].[SDIF001_SELECT]    Script Date: 05/23/2013 16:02:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SDIF001_SELECT]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'
--
-- ã@î\ñºèÃ       ÅFêøãÅì`ï[ÉTÉ}ÉäíäèoèàóùÅB
-- ÉvÉçÉVÉWÉÉñºèÃ ÅFSDIFXXXX
-- ã@î\ê‡ñæ       ÅFéwíËÇ≥ÇÍÇΩîNåéÇÃêøãÅì`ï[ÉTÉ}ÉäÇíäèoÇ∑ÇÈÅB
-- à¯êîê‡ñæ       ÅF@ym ëŒè€îNåé
-- ï‘ílê‡ñæ       ÅFíäèoåãâ 
-- çÏê¨é“         ÅF2013.05.15 sakoda
-- çXêVóöó       ÅF
--
CREATE PROCEDURE [dbo].[SDIF001_SELECT]
    @ym char(6)
AS

    SET NOCOUNT ON

    --
    -- ïœêîêÈåæ
    --
    DECLARE @start_year int        -- ëŒè€îN(from)
    DECLARE @start_month int       -- ëŒè€åé(from)
    DECLARE @start_date char(8)    -- ëŒè€îNåéì˙(from)
    DECLARE @end_year int          -- ëŒè€îN(to)
    DECLARE @end_month int         -- ëŒè€åé(to)
    DECLARE @end_date char(8)      -- ëŒè€îNåéì˙(to)

    --
    -- ëŒè€ì˙ïtÇÃéZèo
    --
    SET @start_year = CAST(substring(@ym, 0, 5) as int)
    SET @start_month = CAST(substring(@ym, 5, 7) as int)

    IF @start_month = 12
        BEGIN
            SET @end_year = @start_year
            SET @end_month = 1
        END
    ELSE
        BEGIN
            SET @end_year = @start_year
            SET @end_month = @start_month + 1
        END

    SET @start_date = cast(@start_year as char(4))
    SET @end_date = cast(@end_year as char(4))

    IF @start_month < 10
        BEGIN
            SET @start_date = cast(@start_date as char(4)) + ''0'' + cast(@start_month as char(1))
        END
    ELSE
        BEGIN
            SET @start_date = cast(@start_date as char(4)) + cast(@start_month as char(2))
        END

    IF @end_month < 10
        BEGIN
            SET @end_date = cast(@end_date as char(4)) + ''0'' + cast(@end_month as char(1))
        END
    ELSE
        BEGIN
            SET @end_date = cast(@end_date as char(4)) + cast(@end_month as char(2))
        END

    SET @start_date = cast(@start_date as char(6)) + ''01''
    SET @end_date = cast(@end_date as char(6)) + ''01'';

WITH YUKO_HANYO_MASTER AS (
    -- óLå¯îƒópÉ}ÉXÉ^
    SELECT
      SDHM014.*
    FROM SDHM014
      INNER JOIN (
           SELECT
               KOMOKU_CD,
               SAIMOKU_CD01,
               SAIMOKU_CD02,
               SAIMOKU_CD03,
               SAIMOKU_CD04,
               SAIMOKU_CD05,
               SAIMOKU_CD06,
               SAIMOKU_CD07,
               SAIMOKU_CD08,
               SAIMOKU_CD09,
               SAIMOKU_CD10,
               MAX(YUKO_STA_YMD) YUKO_STA_YMD
           FROM SDHM014
           WHERE
               SDHM014.YUKO_STA_YMD <= @start_date
               AND SDHM014.YUKO_END_YMD > @end_date
           GROUP BY
               KOMOKU_CD,
               SAIMOKU_CD01,
               SAIMOKU_CD02,
               SAIMOKU_CD03,
               SAIMOKU_CD04,
               SAIMOKU_CD05,
               SAIMOKU_CD06,
               SAIMOKU_CD07,
               SAIMOKU_CD08,
               SAIMOKU_CD09,
               SAIMOKU_CD10
         ) SDHM014_MAX
        ON SDHM014.KOMOKU_CD = SDHM014_MAX.KOMOKU_CD
           AND SDHM014.SAIMOKU_CD01 = SDHM014_MAX.SAIMOKU_CD01
           AND SDHM014.SAIMOKU_CD02 = SDHM014_MAX.SAIMOKU_CD02
           AND SDHM014.SAIMOKU_CD03 = SDHM014_MAX.SAIMOKU_CD03
           AND SDHM014.SAIMOKU_CD04 = SDHM014_MAX.SAIMOKU_CD04
           AND SDHM014.SAIMOKU_CD05 = SDHM014_MAX.SAIMOKU_CD05
           AND SDHM014.SAIMOKU_CD06 = SDHM014_MAX.SAIMOKU_CD06
           AND SDHM014.SAIMOKU_CD07 = SDHM014_MAX.SAIMOKU_CD07
           AND SDHM014.SAIMOKU_CD08 = SDHM014_MAX.SAIMOKU_CD08
           AND SDHM014.SAIMOKU_CD09 = SDHM014_MAX.SAIMOKU_CD09
           AND SDHM014.SAIMOKU_CD10 = SDHM014_MAX.SAIMOKU_CD10
           AND SDHM014.YUKO_STA_YMD = SDHM014_MAX.YUKO_STA_YMD
), SEIKYU_DENPYO AS (
    -- êøãÅì`ï[
    SELECT
        *
    FROM
    (
        SELECT
            HEAD.SEIKYU_DENPYO_NO,  -- êøãÅì`ï[î‘çÜ
            MEISAI.SEIKYU_DENPYO_NO_HAN,  -- êøãÅì`ï[î‘çÜî≈
            MEISAI.SEIKYU_DENPYO_GYO_NO,  -- êøãÅì`ï[çsî‘çÜ
            HEAD.SEIKYU_DENPYO_TYPE,  -- êøãÅì`ï[É^ÉCÉv
            HEAD.AKA_KURO_SOUSAI_DENPYO_NO,  -- ê‘çïëäéEì`ï[î‘çÜ
            HEAD.DENPYO_KIJUN_YMD,  -- ì`ï[äÓèÄì˙
            HEAD.URIAGE_KEIJO_YMD,  -- îÑè„åvè„ì˙
            HEAD.SYS_ID,  -- ÉVÉXÉeÉÄID
            RANK () OVER (
                PARTITION BY
                    HEAD.SEIKYU_DENPYO_NO,
                    MEISAI.SEIKYU_DENPYO_NO_HAN,
                    MEISAI.SEIKYU_DENPYO_GYO_NO
                ORDER BY
                    TOKUISAKI.YUKO_STA_YMD DESC
            ) TOKUISAKI_RANK,
            TOKUISAKI.BMN_CD,  -- ïîñÂÉRÅ[Éh
            MEISAI.ITEM_CD, -- ïiñ⁄ÉRÅ[Éh
            MEISAI.ITEM_SANSHO_TOKUISAKI_CD,  -- ïiñ⁄éQè∆ìæà”êÊÉRÅ[Éh
            MEISAI.KAIJYO_HOKEN_URIAGE_EN,  -- äCè„ï€åØóøÅiîÑè„ÅEâ~â›Åj
            MEISAI.URIAGE_SU,  -- îÑè„êîó 
            MEISAI.SIIRE_TANKA,  -- édì¸íPâø
            MEISAI.URIAGE_TANKA,  -- îÑè„íPâø
            MEISAI.URIAGE_GAKU_ENKA URIAGE_GAKU,  -- îÑè„ã‡äz
            MEISAI.URIAGE_GAKU_ZEI,  -- îÑè„ã‡äzÅiè¡îÔê≈Åj
            MEISAI.NEBIKI_GAKU  -- ílà¯äz
        FROM (
            SELECT
                SDCT001.SEIKYU_DENPYO_NO,
                SDCT001.SEIKYU_DENPYO_NO_HAN,
                SDCT001.SEIKYU_DENPYO_TYPE,
                SDCT001.AKA_KURO_SOUSAI_DENPYO_NO,
                SDCT001.DENPYO_KIJUN_YMD,
                SDCT001.TOKUISAKI_CD,
                SDCT001.URIAGE_KEIJO_YMD,
                SDCT001.SYS_ID,
                SDCT001.SEIKYU_DENPYO_ST,
                RANK () OVER (
                    PARTITION BY
                        SDCT001.SEIKYU_DENPYO_NO
                    ORDER BY
                        CAST(SDCT001.SEIKYU_DENPYO_NO_HAN AS int) DESC
                ) HAN_RANK
            FROM SDCT001
        ) HEAD
        INNER JOIN SDCT002 MEISAI
            ON MEISAI.SEIKYU_DENPYO_NO = HEAD.SEIKYU_DENPYO_NO
            AND MEISAI.SEIKYU_DENPYO_NO_HAN = HEAD.SEIKYU_DENPYO_NO_HAN
        INNER JOIN SDHM001 TOKUISAKI
            ON TOKUISAKI.TOKUISAKI_SYUBETU = ''1''  -- ìæà”êÊ
            AND TOKUISAKI.TOKUISAKI_CD = HEAD.TOKUISAKI_CD
            AND TOKUISAKI.YUKO_STA_YMD <= HEAD.DENPYO_KIJUN_YMD
        WHERE
            HEAD.HAN_RANK = 1
            AND HEAD.SEIKYU_DENPYO_ST >= ''A''  -- TODO:êøãÅì`ï[ÉXÉeÅ[É^ÉX(è≥îF)
    ) RET
    WHERE
        TOKUISAKI_RANK = 1
), HOSOKU_DENPYO AS (
    -- ï‚ë´ì`ï[
    SELECT
        HEAD.SANSHO_SEIKYU_DENPYO_NO,  -- éQè∆êøãÅì`ï[î‘çÜ
        MEISAI.SANSHO_SEIKYU_DENPYO_HAN, -- éQè∆êøãÅì`ï[î‘çÜî≈
        MEISAI.SANSHO_SEIKYU_DEN_GYO_NO,  -- éQè∆êøãÅì`ï[ñæç◊î‘çÜ
        HEAD.URIAGE_HOSOKU_DENPYO_TYPE,  -- îÑè„ï‚ë´ì`ï[É^ÉCÉv
        MEISAI.ITEM_CD,  -- ïiñ⁄ÉRÅ[Éh
        SUM(MEISAI.URIAGE_GAKU_ENKA) URIAGE_GAKU,  -- îÑè„ã‡äz
        SUM(MEISAI.URIAGE_GAKU_ZEI) URIAGE_GAKU_ZEI,  -- îÑè„ã‡äz(è¡îÔê≈)
        SUM(MEISAI.NEBIKI_GAKU) NEBIKI_GAKU,  -- ílà¯äz
        SUM(MEISAI.COMMISSION_GAKU_ENKA) COMMISSION_GAKU  -- ÉRÉ~ÉbÉVÉáÉìäz
    FROM (
        SELECT
            SANSHO_SEIKYU_DENPYO_NO,
            SANSHO_SEIKYU_DENPYO_HAN,
            URIAGE_HOSOKU_DENPYO_TYPE,
            URIAGE_HOSOKU_DENPYO_NO,
            URIAGE_HOSOKU_DENPYO_HAN,
            URIAGE_HOSOKU_DENPYO_ST,
            RANK () OVER (
                PARTITION BY
                    SDCT004.URIAGE_HOSOKU_DENPYO_NO
                ORDER BY
                    SDCT004.URIAGE_HOSOKU_DENPYO_HAN DESC
            ) HAN_RANK
        FROM SDCT004
    ) HEAD
    INNER JOIN SDCT005 MEISAI
        ON MEISAI.URIAGE_HOSOKU_DENPYO_NO = HEAD.URIAGE_HOSOKU_DENPYO_NO
        AND MEISAI.URIAGE_HOSOKU_DENPYO_HAN = HEAD.URIAGE_HOSOKU_DENPYO_HAN
    WHERE
        HEAD.HAN_RANK = 1
        AND HEAD.URIAGE_HOSOKU_DENPYO_ST >= ''A''  -- TODO:îÑè„ï‚ë´ì`ï[ÉXÉeÅ[É^ÉX(è≥îF)
    GROUP BY
        HEAD.SANSHO_SEIKYU_DENPYO_NO,
        MEISAI.SANSHO_SEIKYU_DENPYO_HAN,
        MEISAI.SANSHO_SEIKYU_DEN_GYO_NO,
        HEAD.URIAGE_HOSOKU_DENPYO_TYPE,
        MEISAI.ITEM_CD
), TOUGOU_DENPYO AS (
    -- ìùçáì`ï[
    SELECT
        BMN_CD,
        KAMOKU_KBN,
        ITEM_BUNRUI,
        ITEM_KAISO,
        ITEM_NO,
        ITEM_NM,
        URIAGE_SU,
        URIAGE_SU_CNT,
        URIAGE_GAKU,
        URIAGE_MODOSI_SU,
        URIAGE_MODOSHI_SU_CNT,
        URIAGE_MODOSI_GAKU,
        NEBIKI_GAKU,
        WARIMODOSI_GAKU,
        KOUSEN,
        KAIJYO_HOKEN_URIAGE_EN,
        JUN_URIAGE_SU,
        JUN_URIAGE_SU_CNT,
        JUN_URIAGE_GAKU,
        TATEKAE_GAKU,
        URIAGE_GAKU_ZEI,
        TATEKAE_GAKU_ZEI,
        SIIRE_TANKA,
        URIAGE_TANKA,
        GENKA_RITU,
        NEBIKI_RITU
    FROM
    (
        SELECT
            SEIKYU_DENPYO.BMN_CD,  -- ïîñÂÉRÅ[Éh
            YUKO_HINMOKU_MASTER.KAMOKU_KBN,  -- â»ñ⁄ãÊï™
            YUKO_HINMOKU_MASTER.ITEM_BUNRUI,  -- è§ïiãÊï™
            YUKO_HINMOKU_MASTER.ITEM_KAISO,  -- ïiñ⁄äKëw
            CASE YUKO_HINMOKU_MASTER.KAMOKU_KBN
                WHEN ''1'' THEN YUKO_HINMOKU_MASTER.HANBAI_KOSHO
                ELSE YUKO_HINMOKU_MASTER.KOJO_ITEM_NO1
            END ITEM_NO,  -- è§ïiî‘çÜ
            YUKO_HINMOKU_MASTER.ITEM_NM_RYAKU ITEM_NM,  -- è§ïiñº
            SEIKYU_DENPYO.URIAGE_SU,  -- îÑè„êîó 
            CASE YUKO_HINMOKU_MASTER.SU_KAUNTO_KBN
                WHEN ''0'' THEN ''*''
                ELSE ''''
            END URIAGE_SU_CNT,  -- îÑè„êîó ÉJÉEÉìÉg
            SEIKYU_DENPYO.URIAGE_GAKU,  -- îÑè„ã‡äz
            MODOSI_DENPYO.URIAGE_SU URIAGE_MODOSI_SU,  -- îÑè„ñﬂÇµêîó 
            CASE YUKO_HINMOKU_MASTER.SU_KAUNTO_KBN
                WHEN ''0'' THEN ''*''
                ELSE ''''
            END URIAGE_MODOSHI_SU_CNT,  -- îÑè„ñﬂÇµêîó ÉJÉEÉìÉg
            MODOSI_DENPYO.URIAGE_GAKU URIAGE_MODOSI_GAKU,  -- îÑè„ñﬂÇµã‡äz
            NEBIKI_DENPYO.NEBIKI_GAKU NEBIKI_GAKU,    -- ílà¯ã‡äz
            NEWARI_DENPYO.NEBIKI_GAKU WARIMODOSI_GAKU,    -- äÑñﬂã‡äz
            COMMISSION_KURO_DENPYO.COMMISSION_GAKU - COMMISSION_AKA_DENPYO.COMMISSION_GAKU KOUSEN,  -- å˚ëK
            SEIKYU_DENPYO.KAIJYO_HOKEN_URIAGE_EN,  -- ï€åØóø
            -- TODO:ëóóø
            SEIKYU_DENPYO.URIAGE_SU - MODOSI_DENPYO.URIAGE_SU JUN_URIAGE_SU,  -- èÉîÑè„êîó 
            CASE YUKO_HINMOKU_MASTER.SU_KAUNTO_KBN
                WHEN ''0'' THEN ''*''
                ELSE ''''
            END JUN_URIAGE_SU_CNT,  -- èÉîÑè„êîó ÉJÉEÉìÉg
            SEIKYU_DENPYO.URIAGE_GAKU - MODOSI_DENPYO.URIAGE_GAKU JUN_URIAGE_GAKU,  -- èÉîÑè„ã‡äz
            -- TODO:éËêîóøëº
            TATEKAE_KURO.URIAGE_GAKU - TATEKAE_AKA.URIAGE_GAKU TATEKAE_GAKU,  -- óßë÷ã‡äz
            SEIKYU_DENPYO.URIAGE_GAKU_ZEI,    -- è¡îÔê≈
            TATEKAE_KURO.URIAGE_GAKU_ZEI - TATEKAE_AKA.URIAGE_GAKU_ZEI TATEKAE_GAKU_ZEI,  -- óßë÷ã‡äzè¡îÔê≈
            SEIKYU_DENPYO.SIIRE_TANKA,  -- å¥âø
            SEIKYU_DENPYO.URIAGE_TANKA,    -- îÑè„íPâø
            CASE (SEIKYU_DENPYO.URIAGE_GAKU - MODOSI_DENPYO.URIAGE_GAKU)
                WHEN 0 THEN 0
                ELSE SEIKYU_DENPYO.SIIRE_TANKA / (SEIKYU_DENPYO.URIAGE_GAKU - MODOSI_DENPYO.URIAGE_GAKU) * 100
            END GENKA_RITU,  -- å¥âøó¶
            -- TODO:âµó¶
            CASE SEIKYU_DENPYO.URIAGE_GAKU
                WHEN 0 THEN 0
                ELSE SEIKYU_DENPYO.NEBIKI_GAKU / SEIKYU_DENPYO.URIAGE_GAKU * 100
            END NEBIKI_RITU,  -- ílà¯ó¶
            RANK () OVER (
                PARTITION BY
                    SEIKYU_DENPYO.SEIKYU_DENPYO_NO,
                    SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN
                ORDER BY
                    YUKO_HINMOKU_MASTER.YUKO_STA_YMD DESC
            ) HINMOKU_RANK
        FROM
        (
            SELECT * FROM SEIKYU_DENPYO
            WHERE
                SEIKYU_DENPYO.URIAGE_KEIJO_YMD >= @start_date
                AND SEIKYU_DENPYO.URIAGE_KEIJO_YMD < @end_date
                AND SEIKYU_DENPYO.SEIKYU_DENPYO_TYPE = ''Z3F2''
        ) SEIKYU_DENPYO
        LEFT OUTER JOIN SEIKYU_DENPYO MODOSI_DENPYO    -- ñﬂÇµì`ï[
            ON MODOSI_DENPYO.SEIKYU_DENPYO_NO = SEIKYU_DENPYO.AKA_KURO_SOUSAI_DENPYO_NO
            AND MODOSI_DENPYO.ITEM_CD = SEIKYU_DENPYO.ITEM_CD
            AND MODOSI_DENPYO.SEIKYU_DENPYO_TYPE = ''Z3RE''
        LEFT OUTER JOIN HOSOKU_DENPYO TATEKAE_KURO    -- óßë÷(çï)ì`ï[
            ON TATEKAE_KURO.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
            AND TATEKAE_KURO.SANSHO_SEIKYU_DENPYO_HAN = SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN
            AND TATEKAE_KURO.SANSHO_SEIKYU_DEN_GYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_GYO_NO
            AND TATEKAE_KURO.URIAGE_HOSOKU_DENPYO_TYPE = ''5''
        LEFT OUTER JOIN HOSOKU_DENPYO TATEKAE_AKA    -- óßë÷(ê‘)ì`ï[
            ON TATEKAE_AKA.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
            AND TATEKAE_AKA.SANSHO_SEIKYU_DENPYO_HAN = SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN
            AND TATEKAE_AKA.SANSHO_SEIKYU_DEN_GYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_GYO_NO
            AND TATEKAE_AKA.URIAGE_HOSOKU_DENPYO_TYPE = ''6''
        LEFT OUTER JOIN HOSOKU_DENPYO NEBIKI_DENPYO    -- ílà¯ì`ï[
            ON NEBIKI_DENPYO.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
            AND NEBIKI_DENPYO.SANSHO_SEIKYU_DENPYO_HAN = SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN
            AND NEBIKI_DENPYO.SANSHO_SEIKYU_DEN_GYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_GYO_NO
            AND NEBIKI_DENPYO.URIAGE_HOSOKU_DENPYO_TYPE = ''1''
        LEFT OUTER JOIN HOSOKU_DENPYO NEWARI_DENPYO    -- íläÑì`ï[
            ON NEWARI_DENPYO.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
            AND NEWARI_DENPYO.SANSHO_SEIKYU_DENPYO_HAN = SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN
            AND NEWARI_DENPYO.SANSHO_SEIKYU_DEN_GYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_GYO_NO
            AND NEWARI_DENPYO.URIAGE_HOSOKU_DENPYO_TYPE = ''2''
        LEFT OUTER JOIN HOSOKU_DENPYO COMMISSION_KURO_DENPYO    -- ÉRÉ~ÉbÉVÉáÉì(çï)
            ON COMMISSION_KURO_DENPYO.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
            AND COMMISSION_KURO_DENPYO.SANSHO_SEIKYU_DENPYO_HAN = SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN
            AND COMMISSION_KURO_DENPYO.SANSHO_SEIKYU_DEN_GYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_GYO_NO
            AND COMMISSION_KURO_DENPYO.URIAGE_HOSOKU_DENPYO_TYPE = ''3''
        LEFT OUTER JOIN HOSOKU_DENPYO COMMISSION_AKA_DENPYO    -- ÉRÉ~ÉbÉVÉáÉì(ê‘)
            ON COMMISSION_AKA_DENPYO.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
            AND COMMISSION_AKA_DENPYO.SANSHO_SEIKYU_DENPYO_HAN = SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN
            AND COMMISSION_AKA_DENPYO.SANSHO_SEIKYU_DEN_GYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_GYO_NO
            AND COMMISSION_AKA_DENPYO.URIAGE_HOSOKU_DENPYO_TYPE = ''4''
        INNER JOIN SDHM003 YUKO_HINMOKU_MASTER    -- ïiñ⁄É}ÉXÉ^
            ON YUKO_HINMOKU_MASTER.SYS_ID = SEIKYU_DENPYO.SYS_ID
            AND YUKO_HINMOKU_MASTER.TOKUISAKI_CD = SEIKYU_DENPYO.ITEM_SANSHO_TOKUISAKI_CD
            AND YUKO_HINMOKU_MASTER.ITEM_CD = SEIKYU_DENPYO.ITEM_CD
            AND YUKO_HINMOKU_MASTER.YUKO_STA_YMD <= SEIKYU_DENPYO.DENPYO_KIJUN_YMD
    ) RET
    WHERE
        HINMOKU_RANK = 1
)

SELECT
    BMN_MASTER.CHR_KOMOKU03 BMN_NM,
    KAMOKU_KBN_MASTER.CHR_KOMOKU01 KAMOKU_KBN_NM,
    HINMOKU_KAISOU_MASTER.ITEM_KBN_NM,
    SEIKYU_DENPYO_LIST.*
FROM
(
    /** ñæç◊çs **/
    SELECT
        TOUGOU_DENPYO.*,
        ''D'' LIST_GYO_KBN    -- ÉäÉXÉgçsãÊï™
    FROM TOUGOU_DENPYO
    UNION ALL
    (
        /** è§ïiãÊï™çs **/
        SELECT
            BMN_CD,    -- ïîñÂÉRÅ[Éh
            KAMOKU_KBN,    -- â»ñ⁄ãÊï™
            ITEM_BUNRUI,    -- è§ïiãÊï™
            MAX(ITEM_KAISO) ITEM_KAISO,    -- ïiñ⁄äKëw
            '''' ITEM_NO,    -- è§ïiî‘çÜ
            '''' ITEM_NM,    -- è§ïiñº
            SUM(CASE WHEN URIAGE_SU_CNT = ''''
                THEN URIAGE_SU
                ELSE 0 END
            ) URIAGE_SU,    -- îÑè„êîó 
            '''' URIAGE_SU_CNT,    -- îÑè„êîó ÉJÉEÉìÉg
            SUM(URIAGE_GAKU) URIAGE_GAKU,    -- îÑè„ã‡äz
            SUM(CASE WHEN URIAGE_MODOSHI_SU_CNT = ''''
                THEN URIAGE_MODOSI_SU
                ELSE 0 END
            ) URIAGE_MODOSI_SU,    -- îÑè„ñﬂÇµêîó 
            '''' URIAGE_MODOSHI_SU_CNT,    -- îÑè„ñﬂÇµêîó ÉJÉEÉìÉg
            SUM(URIAGE_MODOSI_GAKU) URIAGE_MODOSI_GAKU,    -- îÑè„ñﬂÇµã‡äz
            SUM(NEBIKI_GAKU) NEBIKI_GAKU,    -- ílà¯ã‡äz
            SUM(WARIMODOSI_GAKU) WARIMODOSI_GAKU,    -- äÑñﬂã‡äz
            SUM(KOUSEN) KOUSEN,    -- å˚ëK
            SUM(KAIJYO_HOKEN_URIAGE_EN) KAIJYO_HOKEN_URIAGE_EN,    -- ï€åØóø
            -- TODO:ëóóø
            SUM(CASE WHEN JUN_URIAGE_SU_CNT = ''''
                THEN JUN_URIAGE_SU
                ELSE 0 END
            ) JUN_URIAGE_SU,    -- èÉîÑè„êîó 
            '''' JUN_URIAGE_SU_CNT,    -- èÉîÑè„êîó ÉJÉEÉìÉg
            SUM(JUN_URIAGE_GAKU) JUN_URIAGE_GAKU,    -- èÉîÑè„ã‡äz
            -- TODO:éËêîóøëº
            SUM(TATEKAE_GAKU) TATEKAE_GAKU,    -- óßë÷ã‡äz
            SUM(URIAGE_GAKU_ZEI) URIAGE_GAKU_ZEI,    -- è¡îÔê≈
            SUM(TATEKAE_GAKU_ZEI) TATEKAE_GAKU_ZEI,    -- óßë÷ã‡äzè¡îÔê≈
            SUM(SIIRE_TANKA) SIIRE_TANKA,    -- å¥âø
            SUM(URIAGE_TANKA) URIAGE_TANKA,    -- îÑè„íPâø
            AVG(GENKA_RITU) GENKA_RITU,    -- å¥âøó¶
            -- TODO:âµó¶
            AVG(NEBIKI_RITU) NEBIKI_RITU,    -- ílà¯ó¶
            ''S1'' LIST_GYO_KBN    -- ÉäÉXÉgçsãÊï™
        FROM TOUGOU_DENPYO
        GROUP BY
            BMN_CD,
            KAMOKU_KBN,
            ITEM_BUNRUI
    )
    UNION ALL
    (
        /** â»ñ⁄ãÊï™çs **/
        SELECT
            BMN_CD,    -- ïîñÂÉRÅ[Éh
            KAMOKU_KBN,    -- â»ñ⁄ãÊï™
            '''' ITEM_BUNRUI,    -- è§ïiãÊï™
            '''' ITEM_KAISO,    -- ïiñ⁄äKëw
            '''' ITEM_NO,    -- è§ïiî‘çÜ
            '''' ITEM_NM,    -- è§ïiñº
            SUM(CASE WHEN URIAGE_SU_CNT = ''''
                THEN URIAGE_SU
                ELSE 0 END
            ) URIAGE_SU,    -- îÑè„êîó 
            '''' URIAGE_SU_CNT,    -- îÑè„êîó ÉJÉEÉìÉg
            SUM(URIAGE_GAKU) URIAGE_GAKU,    -- îÑè„ã‡äz
            SUM(CASE WHEN URIAGE_MODOSHI_SU_CNT = ''''
                THEN URIAGE_MODOSI_SU
                ELSE 0 END
            ) URIAGE_MODOSI_SU,    -- îÑè„ñﬂÇµêîó 
            '''' URIAGE_MODOSHI_SU_CNT,    -- îÑè„ñﬂÇµêîó ÉJÉEÉìÉg
            SUM(URIAGE_MODOSI_GAKU) URIAGE_MODOSI_GAKU,    -- îÑè„ñﬂÇµã‡äz
            SUM(NEBIKI_GAKU) NEBIKI_GAKU,    -- ílà¯ã‡äz
            SUM(WARIMODOSI_GAKU) WARIMODOSI_GAKU,    -- äÑñﬂã‡äz
            SUM(KOUSEN) KOUSEN,    -- å˚ëK
            SUM(KAIJYO_HOKEN_URIAGE_EN) KAIJYO_HOKEN_URIAGE_EN,    -- ï€åØóø
            -- TODO:ëóóø
            SUM(CASE WHEN JUN_URIAGE_SU_CNT = ''''
                THEN JUN_URIAGE_SU
                ELSE 0 END
            ) JUN_URIAGE_SU,    -- èÉîÑè„êîó 
            '''' JUN_URIAGE_SU_CNT,    -- èÉîÑè„êîó ÉJÉEÉìÉg
            SUM(JUN_URIAGE_GAKU) JUN_URIAGE_GAKU,    -- èÉîÑè„ã‡äz
            -- TODO:éËêîóøëº
            SUM(TATEKAE_GAKU) TATEKAE_GAKU,    -- óßë÷ã‡äz
            SUM(URIAGE_GAKU_ZEI) URIAGE_GAKU_ZEI,    -- è¡îÔê≈
            SUM(TATEKAE_GAKU_ZEI) TATEKAE_GAKU_ZEI,    -- óßë÷ã‡äzè¡îÔê≈
            SUM(SIIRE_TANKA) SIIRE_TANKA,    -- å¥âø
            SUM(URIAGE_TANKA) URIAGE_TANKA,    -- îÑè„íPâø
            AVG(GENKA_RITU) GENKA_RITU,    -- å¥âøó¶
            -- TODO:âµó¶
            AVG(NEBIKI_RITU) NEBIKI_RITU,    -- ílà¯ó¶
            ''S2'' LIST_GYO_KBN    -- ÉäÉXÉgçsãÊï™
        FROM TOUGOU_DENPYO
        GROUP BY
            BMN_CD,
            KAMOKU_KBN
    )
    UNION ALL
    (
        /** çáåvçs **/
        SELECT
            BMN_CD,    -- ïîñÂÉRÅ[Éh
            '''' KAMOKU_KBN,    -- â»ñ⁄ãÊï™
            '''' ITEM_BUNRUI,    -- è§ïiãÊï™
            '''' ITEM_KAISO,    -- ïiñ⁄äKëw
            '''' ITEM_NO,    -- è§ïiî‘çÜ
            '''' ITEM_NM,    -- è§ïiñº
            SUM(CASE WHEN URIAGE_SU_CNT = ''''
                THEN URIAGE_SU
                ELSE 0 END
            ) URIAGE_SU,    -- îÑè„êîó 
            '''' URIAGE_SU_CNT,    -- îÑè„êîó ÉJÉEÉìÉg
            SUM(URIAGE_GAKU) URIAGE_GAKU,    -- îÑè„ã‡äz
            SUM(CASE WHEN URIAGE_MODOSHI_SU_CNT = ''''
                THEN URIAGE_MODOSI_SU
                ELSE 0 END
            ) URIAGE_MODOSI_SU,    -- îÑè„ñﬂÇµêîó 
            '''' URIAGE_MODOSHI_SU_CNT,    -- îÑè„ñﬂÇµêîó ÉJÉEÉìÉg
            SUM(URIAGE_MODOSI_GAKU) URIAGE_MODOSI_GAKU,    -- îÑè„ñﬂÇµã‡äz
            SUM(NEBIKI_GAKU) NEBIKI_GAKU,    -- ílà¯ã‡äz
            SUM(WARIMODOSI_GAKU) WARIMODOSI_GAKU,    -- äÑñﬂã‡äz
            SUM(KOUSEN) KOUSEN,    -- å˚ëK
            SUM(KAIJYO_HOKEN_URIAGE_EN) KAIJYO_HOKEN_URIAGE_EN,    -- ï€åØóø
            -- TODO:ëóóø
            SUM(CASE WHEN JUN_URIAGE_SU_CNT = ''''
                THEN JUN_URIAGE_SU
                ELSE 0 END
            ) JUN_URIAGE_SU,    -- èÉîÑè„êîó 
            '''' JUN_URIAGE_SU_CNT,    -- èÉîÑè„êîó ÉJÉEÉìÉg
            SUM(JUN_URIAGE_GAKU) JUN_URIAGE_GAKU,    -- èÉîÑè„ã‡äz
            -- TODO:éËêîóøëº
            SUM(TATEKAE_GAKU) TATEKAE_GAKU,    -- óßë÷ã‡äz
            SUM(URIAGE_GAKU_ZEI) URIAGE_GAKU_ZEI,    -- è¡îÔê≈
            SUM(TATEKAE_GAKU_ZEI) TATEKAE_GAKU_ZEI,    -- óßë÷ã‡äzè¡îÔê≈
            SUM(SIIRE_TANKA) SIIRE_TANKA,    -- å¥âø
            SUM(URIAGE_TANKA) URIAGE_TANKA,    -- îÑè„íPâø
            AVG(GENKA_RITU) GENKA_RITU,    -- å¥âøó¶
            -- TODO:âµó¶
            AVG(NEBIKI_RITU) NEBIKI_RITU,    -- ílà¯ó¶
            ''T'' LIST_GYO_KBN    -- ÉäÉXÉgçsãÊï™
        FROM TOUGOU_DENPYO
        GROUP BY
            BMN_CD
    )
) SEIKYU_DENPYO_LIST
INNER JOIN YUKO_HANYO_MASTER BMN_MASTER    -- ïîñÂÉ}ÉXÉ^
    ON BMN_MASTER.KOMOKU_CD = ''SDZ024''
    AND BMN_MASTER.SAIMOKU_CD01 = ''10''
    AND BMN_MASTER.SAIMOKU_CD02 = SEIKYU_DENPYO_LIST.BMN_CD
LEFT OUTER JOIN YUKO_HANYO_MASTER KAMOKU_KBN_MASTER    -- â»ñ⁄ãÊï™É}ÉXÉ^
    ON KAMOKU_KBN_MASTER.KOMOKU_CD = ''SDHG0059''
    AND KAMOKU_KBN_MASTER.SAIMOKU_CD01 = SEIKYU_DENPYO_LIST.KAMOKU_KBN
LEFT OUTER JOIN SDHM026 HINMOKU_KAISOU_MASTER    -- ïiñ⁄äKëwÉ}ÉXÉ^
    ON HINMOKU_KAISOU_MASTER.ITEM_KAISO = SEIKYU_DENPYO_LIST.ITEM_KAISO
ORDER BY
    SEIKYU_DENPYO_LIST.BMN_CD,
    COALESCE(SEIKYU_DENPYO_LIST.KAMOKU_KBN, ''Z''),
    COALESCE(SEIKYU_DENPYO_LIST.ITEM_BUNRUI, ''ZZ''),
    COALESCE(SEIKYU_DENPYO_LIST.ITEM_NO, ''ZZZZZZZZZZZZZZZ'')
' 
END
GO
/****** Object:  UserDefinedFunction [dbo].[SDIF001_SDHM014]    Script Date: 05/23/2013 16:02:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SDIF001_SDHM014]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
BEGIN
execute dbo.sp_executesql @statement = N'
CREATE FUNCTION [dbo].[SDIF001_SDHM014] (
  @komokuCd as varchar(20),
  @toYMD as varchar(8)
) RETURNS TABLE AS RETURN
  	SELECT * 
		FROM INTRA_MART.dbo.SDHM014 A
		WHERE KOMOKU_CD = @komokuCd
		  AND YUKO_STA_YMD <= @toYMD
		  AND A.YUKO_STA_YMD = (
			SELECT MAX(B.YUKO_STA_YMD) 
			FROM INTRA_MART.dbo.SDHM014 B
			WHERE B.YUKO_STA_YMD <= @toYMD
			  AND A.KOMOKU_CD = B.KOMOKU_CD
			  AND A.SAIMOKU_CD01 = B.SAIMOKU_CD01
			  AND A.SAIMOKU_CD02 = B.SAIMOKU_CD02
			  AND A.SAIMOKU_CD03 = B.SAIMOKU_CD03
			  AND A.SAIMOKU_CD04 = B.SAIMOKU_CD04
			  AND A.SAIMOKU_CD05 = B.SAIMOKU_CD05
			  AND A.SAIMOKU_CD06 = B.SAIMOKU_CD06
			  AND A.SAIMOKU_CD07 = B.SAIMOKU_CD07
			  AND A.SAIMOKU_CD08 = B.SAIMOKU_CD08
			  AND A.SAIMOKU_CD09 = B.SAIMOKU_CD09
			  AND A.SAIMOKU_CD10 = B.SAIMOKU_CD10
		  )

;
' 
END
GO
/****** Object:  UserDefinedFunction [dbo].[SDIF001_SDHM003]    Script Date: 05/23/2013 16:02:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SDIF001_SDHM003]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
BEGIN
execute dbo.sp_executesql @statement = N'
CREATE FUNCTION [dbo].[SDIF001_SDHM003] (
  @toYMD as varchar(8)
) RETURNS TABLE AS RETURN
  	SELECT * 
		FROM INTRA_MART.dbo.SDHM003 A
		WHERE YUKO_STA_YMD <= @toYMD
		  AND A.YUKO_STA_YMD = (
			SELECT MAX(B.YUKO_STA_YMD) 
			FROM INTRA_MART.dbo.SDHM003 B
			WHERE B.YUKO_STA_YMD <= @toYMD
			  AND A.SYS_ID = B.SYS_ID
			  AND A.ITEM_CD = B.ITEM_CD
			  AND A.TOKUISAKI_CD = B.TOKUISAKI_CD
		  )

;
' 
END
GO
/****** Object:  StoredProcedure [dbo].[SDIF001_Query]    Script Date: 05/23/2013 16:02:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SDIF001_Query]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'
CREATE PROCEDURE [dbo].[SDIF001_Query]
  @ym char(6)
AS

--  DECLARE @ym CHAR(6) = ''201305''
  DECLARE @start_year int
  DECLARE @start_month int
  DECLARE @start_date char(8)
  DECLARE @end_year int
  DECLARE @end_month int
  DECLARE @end_date char(8)

  SET @start_year = CAST(substring(@ym, 0, 5) as int)
  SET @start_month = CAST(substring(@ym, 5, 7) as int)

  IF @start_month = 3
      BEGIN
          SET @end_year = @start_year + 1
          SET @end_month = @start_month + 1
      END
  ELSE IF @start_month = 12
      BEGIN
          SET @end_year = @start_year
          SET @end_month = 1
      END
  ELSE
      BEGIN
          SET @end_year = @start_year
          SET @end_month = @start_month + 1
      END

  SET @start_date = cast(@start_year as char(4))
  SET @end_date = cast(@end_year as char(4))

  IF @start_month < 10
      BEGIN
          SET @start_date = cast(@start_date as char(4)) + ''0'' + cast(@start_month as char(1))
      END
  ELSE
      BEGIN
          SET @start_date = cast(@start_date as char(4)) + cast(@start_month as char(2))
      END

  IF @end_month < 10
      BEGIN
          SET @end_date = cast(@end_date as char(4)) + ''0'' + cast(@end_month as char(1))
      END
  ELSE
      BEGIN
          SET @end_date = cast(@end_date as char(4)) + cast(@end_month as char(2))
      END

  SET @start_date = cast(@start_date as char(6)) + ''01''
  SET @end_date = cast(@end_date as char(6)) + ''01'';

WITH YUKO_HANYO_MASTER AS (
    SELECT
      SDHM014.*
    FROM SDHM014
      INNER JOIN (
           SELECT
               KOMOKU_CD,
               SAIMOKU_CD01,
               SAIMOKU_CD02,
               SAIMOKU_CD03,
               SAIMOKU_CD04,
               SAIMOKU_CD05,
               SAIMOKU_CD06,
               SAIMOKU_CD07,
               SAIMOKU_CD08,
               SAIMOKU_CD09,
               SAIMOKU_CD10,
               MAX(YUKO_STA_YMD) YUKO_STA_YMD
           FROM SDHM014
           WHERE
               SDHM014.YUKO_STA_YMD <= @start_date
               AND SDHM014.YUKO_END_YMD > @end_date
           GROUP BY
               KOMOKU_CD,
               SAIMOKU_CD01,
               SAIMOKU_CD02,
               SAIMOKU_CD03,
               SAIMOKU_CD04,
               SAIMOKU_CD05,
               SAIMOKU_CD06,
               SAIMOKU_CD07,
               SAIMOKU_CD08,
               SAIMOKU_CD09,
               SAIMOKU_CD10
         ) SDHM014_MAX
        ON SDHM014.KOMOKU_CD = SDHM014_MAX.KOMOKU_CD
           AND SDHM014.SAIMOKU_CD01 = SDHM014_MAX.SAIMOKU_CD01
           AND SDHM014.SAIMOKU_CD02 = SDHM014_MAX.SAIMOKU_CD02
           AND SDHM014.SAIMOKU_CD03 = SDHM014_MAX.SAIMOKU_CD03
           AND SDHM014.SAIMOKU_CD04 = SDHM014_MAX.SAIMOKU_CD04
           AND SDHM014.SAIMOKU_CD05 = SDHM014_MAX.SAIMOKU_CD05
           AND SDHM014.SAIMOKU_CD06 = SDHM014_MAX.SAIMOKU_CD06
           AND SDHM014.SAIMOKU_CD07 = SDHM014_MAX.SAIMOKU_CD07
           AND SDHM014.SAIMOKU_CD08 = SDHM014_MAX.SAIMOKU_CD08
           AND SDHM014.SAIMOKU_CD09 = SDHM014_MAX.SAIMOKU_CD09
           AND SDHM014.SAIMOKU_CD10 = SDHM014_MAX.SAIMOKU_CD10
           AND SDHM014.YUKO_STA_YMD = SDHM014_MAX.YUKO_STA_YMD
), SEIKYU_DENPYO AS (
    SELECT
        *
    FROM
    (
        SELECT
            HEAD.SEIKYU_DENPYO_NO,  -- êøãÅì`ï[î‘çÜ
            MEISAI.SEIKYU_DENPYO_NO_HAN,  -- êøãÅì`ï[î‘çÜî≈
            MEISAI.SEIKYU_DENPYO_GYO_NO,  -- êøãÅì`ï[çsî‘çÜ
            HEAD.SEIKYU_DENPYO_TYPE,  -- êøãÅì`ï[É^ÉCÉv
            HEAD.AKA_KURO_SOUSAI_DENPYO_NO,  -- ê‘çïëäéEì`ï[î‘çÜ
            HEAD.DENPYO_KIJUN_YMD,  -- ì`ï[äÓèÄì˙
            HEAD.URIAGE_KEIJO_YMD,  -- îÑè„åvè„ì˙
            HEAD.SYS_ID,  -- ÉVÉXÉeÉÄID
            RANK () OVER (
                PARTITION BY
                    HEAD.SEIKYU_DENPYO_NO,
                    MEISAI.SEIKYU_DENPYO_NO_HAN,
                    MEISAI.SEIKYU_DENPYO_GYO_NO
                ORDER BY
                    TOKUISAKI.YUKO_STA_YMD DESC
            ) TOKUISAKI_RANK,
            TOKUISAKI.BMN_CD,  -- ïîñÂÉRÅ[Éh
            MEISAI.ITEM_CD, -- ïiñ⁄ÉRÅ[Éh
            MEISAI.ITEM_SANSHO_TOKUISAKI_CD,  -- ïiñ⁄éQè∆ìæà”êÊÉRÅ[Éh
            MEISAI.KAIJYO_HOKEN_RYO_URIAGE_ENKA,  -- äCè„ï€åØóøÅiîÑè„ÅEâ~â›Åj
            MEISAI.URIAGE_SU,  -- îÑè„êîó 
            MEISAI.URIAGE_TANKA,  -- îÑè„íPâø
            MEISAI.URIAGE_GAKU_ENKA URIAGE_GAKU,  -- îÑè„ã‡äz
            MEISAI.URIAGE_GAKU_ZEI,  -- îÑè„ã‡äzÅiè¡îÔê≈Åj
            MEISAI.NEBIKI_GAKU  -- ílà¯äz
        FROM (
            SELECT
                SDCT001.SEIKYU_DENPYO_NO,
                SDCT001.SEIKYU_DENPYO_NO_HAN,
                SDCT001.SEIKYU_DENPYO_TYPE,
                SDCT001.AKA_KURO_SOUSAI_DENPYO_NO,
                SDCT001.DENPYO_KIJUN_YMD,
                SDCT001.TOKUISAKI_CD,
                SDCT001.URIAGE_KEIJO_YMD,
                SDCT001.SYS_ID,
                RANK () OVER (
                    PARTITION BY
                        SDCT001.SEIKYU_DENPYO_NO
                    ORDER BY
                        SDCT001.SEIKYU_DENPYO_NO_HAN DESC
                ) HAN_RANK
            FROM SDCT001
        ) HEAD
        INNER JOIN SDCT002 MEISAI
            ON MEISAI.SEIKYU_DENPYO_NO = HEAD.SEIKYU_DENPYO_NO
            AND MEISAI.SEIKYU_DENPYO_NO_HAN = HEAD.SEIKYU_DENPYO_NO_HAN
        INNER JOIN SDHM001 TOKUISAKI
            ON TOKUISAKI.TOKUISAKI_SYUBETU = ''1''  -- ìæà”êÊ
            AND TOKUISAKI.TOKUISAKI_CD = HEAD.TOKUISAKI_CD
            AND TOKUISAKI.YUKO_STA_YMD <= HEAD.DENPYO_KIJUN_YMD
        WHERE
            HEAD.HAN_RANK = 1
    ) RET
    WHERE
        TOKUISAKI_RANK = 1
), HOSOKU_DENPYO AS (
    SELECT
        HEAD.SANSHO_SEIKYU_DENPYO_NO,  -- éQè∆êøãÅì`ï[î‘çÜ
        MEISAI.SANSHO_SEIKYU_DENPYO_HAN, -- éQè∆êøãÅì`ï[î‘çÜî≈
        MEISAI.SANSHO_SEIKYU_DEN_GYO_NO,  -- éQè∆êøãÅì`ï[ñæç◊î‘çÜ
        HEAD.URIAGE_HOSOKU_DENPYO_TYPE,  -- îÑè„ï‚ë´ì`ï[É^ÉCÉv
        MEISAI.ITEM_CD,  -- ïiñ⁄ÉRÅ[Éh
        SUM(MEISAI.URIAGE_GAKU_ENKA) URIAGE_GAKU,  -- îÑè„ã‡äz
        SUM(MEISAI.URIAGE_GAKU_ZEI) URIAGE_GAKU_ZEI,  -- îÑè„ã‡äz(è¡îÔê≈)
        SUM(MEISAI.NEBIKI_GAKU) NEBIKI_GAKU,  -- ílà¯äz
        SUM(MEISAI.COMMISSION_GAKU_ENKA) COMMISSION_GAKU  -- ÉRÉ~ÉbÉVÉáÉìäz
    FROM (
        SELECT
            SANSHO_SEIKYU_DENPYO_NO,
            SANSHO_SEIKYU_DENPYO_HAN,
            URIAGE_HOSOKU_DENPYO_TYPE,
            URIAGE_HOSOKU_DENPYO_NO,
            URIAGE_HOSOKU_DENPYO_HAN,
            RANK () OVER (
                PARTITION BY
                    SDCT004.URIAGE_HOSOKU_DENPYO_NO
                ORDER BY
                    SDCT004.URIAGE_HOSOKU_DENPYO_HAN DESC
            ) HAN_RANK
        FROM SDCT004
    ) HEAD
    INNER JOIN SDCT005 MEISAI
        ON MEISAI.URIAGE_HOSOKU_DENPYO_NO = HEAD.URIAGE_HOSOKU_DENPYO_NO
        AND MEISAI.URIAGE_HOSOKU_DENPYO_HAN = HEAD.URIAGE_HOSOKU_DENPYO_HAN
    WHERE
        HEAD.HAN_RANK = 1
    GROUP BY
        HEAD.SANSHO_SEIKYU_DENPYO_NO,
        MEISAI.SANSHO_SEIKYU_DENPYO_HAN,
        MEISAI.SANSHO_SEIKYU_DEN_GYO_NO,
        HEAD.URIAGE_HOSOKU_DENPYO_TYPE,
        MEISAI.ITEM_CD
), TOUGOU_DENPYO AS (
    SELECT
        BMN_CD,
        KAMOKU_KBN,
        ITEM_BUNRUI,
        ITEM_KAISO,
        ITEM_NO,
        ITEM_NM,
        URIAGE_SU,
        URIAGE_SU_CNT,
        URIAGE_GAKU,
        URIAGE_MODOSI_SU,
        URIAGE_MODOSHI_SU_CNT,
        URIAGE_MODOSI_GAKU,
        NEBIKI_GAKU,
        WARIMODOSI_GAKU,
        KOUSEN,
        KAIJYO_HOKEN_RYO_URIAGE_ENKA,
        JUN_URIAGE_SU,
        JUN_URIAGE_SU_CNT,
        JUN_URIAGE_GAKU,
        TATEKAE_GAKU,
        URIAGE_GAKU_ZEI,
        TATEKAE_GAKU_ZEI,
        TEIKA_TANKA,
        URIAGE_TANKA,
        GENKA_RITU,
        NEBIKI_RITU
    FROM
    (
        SELECT
            SEIKYU_DENPYO.BMN_CD,  -- ïîñÂÉRÅ[Éh
            YUKO_HINMOKU_MASTER.KAMOKU_KBN,  -- â»ñ⁄ãÊï™
            YUKO_HINMOKU_MASTER.ITEM_BUNRUI,  -- è§ïiãÊï™
            YUKO_HINMOKU_MASTER.ITEM_KAISO,  -- ïiñ⁄äKëw
            CASE YUKO_HINMOKU_MASTER.KAMOKU_KBN
                WHEN ''1'' THEN YUKO_HINMOKU_MASTER.HANBAI_KOSHO
                ELSE YUKO_HINMOKU_MASTER.KOJO_ITEM_NO1
            END ITEM_NO,  -- è§ïiî‘çÜ
            YUKO_HINMOKU_MASTER.ITEM_NM_RYAKU ITEM_NM,  -- è§ïiñº
            SEIKYU_DENPYO.URIAGE_SU,  -- îÑè„êîó 
            CASE YUKO_HINMOKU_MASTER.SU_KAUNTO_KBN
                WHEN ''0'' THEN ''*''
                ELSE ''''
            END URIAGE_SU_CNT,  -- îÑè„êîó ÉJÉEÉìÉg
            SEIKYU_DENPYO.URIAGE_GAKU,  -- îÑè„ã‡äz
            MODOSI_DENPYO.URIAGE_SU URIAGE_MODOSI_SU,  -- îÑè„ñﬂÇµêîó 
            CASE YUKO_HINMOKU_MASTER.SU_KAUNTO_KBN
                WHEN ''0'' THEN ''*''
                ELSE ''''
            END URIAGE_MODOSHI_SU_CNT,  -- îÑè„ñﬂÇµêîó ÉJÉEÉìÉg
            MODOSI_DENPYO.URIAGE_GAKU URIAGE_MODOSI_GAKU,  -- îÑè„ñﬂÇµã‡äz
            NEBIKI_DENPYO.NEBIKI_GAKU NEBIKI_GAKU,    -- ílà¯ã‡äz
            NEWARI_DENPYO.NEBIKI_GAKU WARIMODOSI_GAKU,    -- äÑñﬂã‡äz
            COMMISSION_KURO_DENPYO.COMMISSION_GAKU - COMMISSION_AKA_DENPYO.COMMISSION_GAKU KOUSEN,  -- å˚ëK
            SEIKYU_DENPYO.KAIJYO_HOKEN_RYO_URIAGE_ENKA,  -- ï€åØóø
            -- TODO:ëóóø
            SEIKYU_DENPYO.URIAGE_SU - MODOSI_DENPYO.URIAGE_SU JUN_URIAGE_SU,  -- èÉîÑè„êîó 
            CASE YUKO_HINMOKU_MASTER.SU_KAUNTO_KBN
                WHEN ''0'' THEN ''*''
                ELSE ''''
            END JUN_URIAGE_SU_CNT,  -- èÉîÑè„êîó ÉJÉEÉìÉg
            SEIKYU_DENPYO.URIAGE_GAKU - MODOSI_DENPYO.URIAGE_GAKU JUN_URIAGE_GAKU,  -- èÉîÑè„ã‡äz
            -- TODO:éËêîóøëº
            TATEKAE_KURO.URIAGE_GAKU - TATEKAE_AKA.URIAGE_GAKU TATEKAE_GAKU,  -- óßë÷ã‡äz
            SEIKYU_DENPYO.URIAGE_GAKU_ZEI,    -- è¡îÔê≈
            TATEKAE_KURO.URIAGE_GAKU_ZEI - TATEKAE_AKA.URIAGE_GAKU_ZEI TATEKAE_GAKU_ZEI,  -- óßë÷ã‡äzè¡îÔê≈
            YUKO_HINMOKU_MASTER.TEIKA_TANKA,  -- å¥âø
            SEIKYU_DENPYO.URIAGE_TANKA,    -- îÑè„íPâø
            CASE (SEIKYU_DENPYO.URIAGE_GAKU - MODOSI_DENPYO.URIAGE_GAKU)
                WHEN 0 THEN 0
                ELSE YUKO_HINMOKU_MASTER.TEIKA_TANKA / (SEIKYU_DENPYO.URIAGE_GAKU - MODOSI_DENPYO.URIAGE_GAKU) * 100
            END GENKA_RITU,  -- å¥âøó¶
            -- TODO:âµó¶
            CASE SEIKYU_DENPYO.URIAGE_GAKU
                WHEN 0 THEN 0
                ELSE SEIKYU_DENPYO.NEBIKI_GAKU / SEIKYU_DENPYO.URIAGE_GAKU * 100
            END NEBIKI_RITU,  -- ílà¯ó¶
            RANK () OVER (
                PARTITION BY
                    SEIKYU_DENPYO.SEIKYU_DENPYO_NO,
                    SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN
                ORDER BY
                    YUKO_HINMOKU_MASTER.YUKO_STA_YMD DESC
            ) HINMOKU_RANK
        FROM
        (
            SELECT * FROM SEIKYU_DENPYO
            WHERE
                SEIKYU_DENPYO.URIAGE_KEIJO_YMD >= @start_date
                AND SEIKYU_DENPYO.URIAGE_KEIJO_YMD < @end_date
                AND SEIKYU_DENPYO.SEIKYU_DENPYO_TYPE = ''Z3F2''
        ) SEIKYU_DENPYO
        LEFT OUTER JOIN SEIKYU_DENPYO MODOSI_DENPYO    -- ñﬂÇµì`ï[
            ON MODOSI_DENPYO.SEIKYU_DENPYO_NO = SEIKYU_DENPYO.AKA_KURO_SOUSAI_DENPYO_NO
            AND MODOSI_DENPYO.ITEM_CD = SEIKYU_DENPYO.ITEM_CD
            AND MODOSI_DENPYO.SEIKYU_DENPYO_TYPE = ''Z3RE''
        LEFT OUTER JOIN HOSOKU_DENPYO TATEKAE_KURO    -- óßë÷(çï)ì`ï[
            ON TATEKAE_KURO.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
            AND TATEKAE_KURO.SANSHO_SEIKYU_DENPYO_HAN = SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN
            AND TATEKAE_KURO.SANSHO_SEIKYU_DEN_GYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_GYO_NO
            AND TATEKAE_KURO.URIAGE_HOSOKU_DENPYO_TYPE = ''5''
        LEFT OUTER JOIN HOSOKU_DENPYO TATEKAE_AKA    -- óßë÷(ê‘)ì`ï[
            ON TATEKAE_AKA.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
            AND TATEKAE_AKA.SANSHO_SEIKYU_DENPYO_HAN = SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN
            AND TATEKAE_AKA.SANSHO_SEIKYU_DEN_GYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_GYO_NO
            AND TATEKAE_AKA.URIAGE_HOSOKU_DENPYO_TYPE = ''6''
        LEFT OUTER JOIN HOSOKU_DENPYO NEBIKI_DENPYO    -- ílà¯ì`ï[
            ON NEBIKI_DENPYO.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
            AND NEBIKI_DENPYO.SANSHO_SEIKYU_DENPYO_HAN = SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN
            AND NEBIKI_DENPYO.SANSHO_SEIKYU_DEN_GYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_GYO_NO
            AND NEBIKI_DENPYO.URIAGE_HOSOKU_DENPYO_TYPE = ''1''
        LEFT OUTER JOIN HOSOKU_DENPYO NEWARI_DENPYO    -- íläÑì`ï[
            ON NEWARI_DENPYO.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
            AND NEWARI_DENPYO.SANSHO_SEIKYU_DENPYO_HAN = SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN
            AND NEWARI_DENPYO.SANSHO_SEIKYU_DEN_GYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_GYO_NO
            AND NEWARI_DENPYO.URIAGE_HOSOKU_DENPYO_TYPE = ''2''
        LEFT OUTER JOIN HOSOKU_DENPYO COMMISSION_KURO_DENPYO    -- ÉRÉ~ÉbÉVÉáÉì(çï)
            ON COMMISSION_KURO_DENPYO.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
            AND COMMISSION_KURO_DENPYO.SANSHO_SEIKYU_DENPYO_HAN = SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN
            AND COMMISSION_KURO_DENPYO.SANSHO_SEIKYU_DEN_GYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_GYO_NO
            AND COMMISSION_KURO_DENPYO.URIAGE_HOSOKU_DENPYO_TYPE = ''3''
        LEFT OUTER JOIN HOSOKU_DENPYO COMMISSION_AKA_DENPYO    -- ÉRÉ~ÉbÉVÉáÉì(ê‘)
            ON COMMISSION_AKA_DENPYO.SANSHO_SEIKYU_DENPYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_NO
            AND COMMISSION_AKA_DENPYO.SANSHO_SEIKYU_DENPYO_HAN = SEIKYU_DENPYO.SEIKYU_DENPYO_NO_HAN
            AND COMMISSION_AKA_DENPYO.SANSHO_SEIKYU_DEN_GYO_NO = SEIKYU_DENPYO.SEIKYU_DENPYO_GYO_NO
            AND COMMISSION_AKA_DENPYO.URIAGE_HOSOKU_DENPYO_TYPE = ''4''
        INNER JOIN SDHM003 YUKO_HINMOKU_MASTER    -- ïiñ⁄É}ÉXÉ^
            ON YUKO_HINMOKU_MASTER.SYS_ID = SEIKYU_DENPYO.SYS_ID
            AND YUKO_HINMOKU_MASTER.TOKUISAKI_CD = SEIKYU_DENPYO.ITEM_SANSHO_TOKUISAKI_CD
            AND YUKO_HINMOKU_MASTER.ITEM_CD = SEIKYU_DENPYO.ITEM_CD
            AND YUKO_HINMOKU_MASTER.YUKO_STA_YMD <= SEIKYU_DENPYO.DENPYO_KIJUN_YMD
    ) RET
    WHERE
        HINMOKU_RANK = 1
)

SELECT
    BMN_MASTER.CHR_KOMOKU03 BMN_NM,
    KAMOKU_KBN_MASTER.CHR_KOMOKU01 KAMOKU_KBN_NM,
    HINMOKU_KAISOU_MASTER.ITEM_KBN_NM,
    SEIKYU_DENPYO_LIST.*
FROM
(
    /** ñæç◊çs **/
    SELECT
        TOUGOU_DENPYO.*,
        ''D'' LIST_GYO_KBN    -- ÉäÉXÉgçsãÊï™
    FROM TOUGOU_DENPYO
    UNION ALL
    (
        /** è§ïiãÊï™çs **/
        SELECT
            BMN_CD,    -- ïîñÂÉRÅ[Éh
            KAMOKU_KBN,    -- â»ñ⁄ãÊï™
            ITEM_BUNRUI,    -- è§ïiãÊï™
            MAX(ITEM_KAISO) ITEM_KAISO,    -- ïiñ⁄äKëw
            '''' ITEM_NO,    -- è§ïiî‘çÜ
            '''' ITEM_NM,    -- è§ïiñº
            SUM(CASE WHEN URIAGE_SU_CNT = ''''
                THEN URIAGE_SU
                ELSE 0 END
            ) URIAGE_SU,    -- îÑè„êîó 
            '''' URIAGE_SU_CNT,    -- îÑè„êîó ÉJÉEÉìÉg
            SUM(URIAGE_GAKU) URIAGE_GAKU,    -- îÑè„ã‡äz
            SUM(CASE WHEN URIAGE_MODOSHI_SU_CNT = ''''
                THEN URIAGE_MODOSI_SU
                ELSE 0 END
            ) URIAGE_MODOSI_SU,    -- îÑè„ñﬂÇµêîó 
            '''' URIAGE_MODOSHI_SU_CNT,    -- îÑè„ñﬂÇµêîó ÉJÉEÉìÉg
            SUM(URIAGE_MODOSI_GAKU) URIAGE_MODOSI_GAKU,    -- îÑè„ñﬂÇµã‡äz
            SUM(NEBIKI_GAKU) NEBIKI_GAKU,    -- ílà¯ã‡äz
            SUM(WARIMODOSI_GAKU) WARIMODOSI_GAKU,    -- äÑñﬂã‡äz
            SUM(KOUSEN) KOUSEN,    -- å˚ëK
            SUM(KAIJYO_HOKEN_RYO_URIAGE_ENKA) KAIJYO_HOKEN_RYO_URIAGE_ENKA,    -- ï€åØóø
            -- TODO:ëóóø
            SUM(CASE WHEN JUN_URIAGE_SU_CNT = ''''
                THEN JUN_URIAGE_SU
                ELSE 0 END
            ) JUN_URIAGE_SU,    -- èÉîÑè„êîó 
            '''' JUN_URIAGE_SU_CNT,    -- èÉîÑè„êîó ÉJÉEÉìÉg
            SUM(JUN_URIAGE_GAKU) JUN_URIAGE_GAKU,    -- èÉîÑè„ã‡äz
            -- TODO:éËêîóøëº
            SUM(TATEKAE_GAKU) TATEKAE_GAKU,    -- óßë÷ã‡äz
            SUM(URIAGE_GAKU_ZEI) URIAGE_GAKU_ZEI,    -- è¡îÔê≈
            SUM(TATEKAE_GAKU_ZEI) TATEKAE_GAKU_ZEI,    -- óßë÷ã‡äzè¡îÔê≈
            SUM(TEIKA_TANKA) TEIKA_TANKA,    -- å¥âø
            SUM(URIAGE_TANKA) URIAGE_TANKA,    -- îÑè„íPâø
            AVG(GENKA_RITU) GENKA_RITU,    -- å¥âøó¶
            -- TODO:âµó¶
            AVG(NEBIKI_RITU) NEBIKI_RITU,    -- ílà¯ó¶
            ''S1'' LIST_GYO_KBN    -- ÉäÉXÉgçsãÊï™
        FROM TOUGOU_DENPYO
        GROUP BY
            BMN_CD,
            KAMOKU_KBN,
            ITEM_BUNRUI
    )
    UNION ALL
    (
        /** â»ñ⁄ãÊï™çs **/
        SELECT
            BMN_CD,    -- ïîñÂÉRÅ[Éh
            KAMOKU_KBN,    -- â»ñ⁄ãÊï™
            '''' ITEM_BUNRUI,    -- è§ïiãÊï™
            '''' ITEM_KAISO,    -- ïiñ⁄äKëw
            '''' ITEM_NO,    -- è§ïiî‘çÜ
            '''' ITEM_NM,    -- è§ïiñº
            SUM(CASE WHEN URIAGE_SU_CNT = ''''
                THEN URIAGE_SU
                ELSE 0 END
            ) URIAGE_SU,    -- îÑè„êîó 
            '''' URIAGE_SU_CNT,    -- îÑè„êîó ÉJÉEÉìÉg
            SUM(URIAGE_GAKU) URIAGE_GAKU,    -- îÑè„ã‡äz
            SUM(CASE WHEN URIAGE_MODOSHI_SU_CNT = ''''
                THEN URIAGE_MODOSI_SU
                ELSE 0 END
            ) URIAGE_MODOSI_SU,    -- îÑè„ñﬂÇµêîó 
            '''' URIAGE_MODOSHI_SU_CNT,    -- îÑè„ñﬂÇµêîó ÉJÉEÉìÉg
            SUM(URIAGE_MODOSI_GAKU) URIAGE_MODOSI_GAKU,    -- îÑè„ñﬂÇµã‡äz
            SUM(NEBIKI_GAKU) NEBIKI_GAKU,    -- ílà¯ã‡äz
            SUM(WARIMODOSI_GAKU) WARIMODOSI_GAKU,    -- äÑñﬂã‡äz
            SUM(KOUSEN) KOUSEN,    -- å˚ëK
            SUM(KAIJYO_HOKEN_RYO_URIAGE_ENKA) KAIJYO_HOKEN_RYO_URIAGE_ENKA,    -- ï€åØóø
            -- TODO:ëóóø
            SUM(CASE WHEN JUN_URIAGE_SU_CNT = ''''
                THEN JUN_URIAGE_SU
                ELSE 0 END
            ) JUN_URIAGE_SU,    -- èÉîÑè„êîó 
            '''' JUN_URIAGE_SU_CNT,    -- èÉîÑè„êîó ÉJÉEÉìÉg
            SUM(JUN_URIAGE_GAKU) JUN_URIAGE_GAKU,    -- èÉîÑè„ã‡äz
            -- TODO:éËêîóøëº
            SUM(TATEKAE_GAKU) TATEKAE_GAKU,    -- óßë÷ã‡äz
            SUM(URIAGE_GAKU_ZEI) URIAGE_GAKU_ZEI,    -- è¡îÔê≈
            SUM(TATEKAE_GAKU_ZEI) TATEKAE_GAKU_ZEI,    -- óßë÷ã‡äzè¡îÔê≈
            SUM(TEIKA_TANKA) TEIKA_TANKA,    -- å¥âø
            SUM(URIAGE_TANKA) URIAGE_TANKA,    -- îÑè„íPâø
            AVG(GENKA_RITU) GENKA_RITU,    -- å¥âøó¶
            -- TODO:âµó¶
            AVG(NEBIKI_RITU) NEBIKI_RITU,    -- ílà¯ó¶
            ''S2'' LIST_GYO_KBN    -- ÉäÉXÉgçsãÊï™
        FROM TOUGOU_DENPYO
        GROUP BY
            BMN_CD,
            KAMOKU_KBN
    )
    UNION ALL
    (
        /** çáåvçs **/
        SELECT
            BMN_CD,    -- ïîñÂÉRÅ[Éh
            '''' KAMOKU_KBN,    -- â»ñ⁄ãÊï™
            '''' ITEM_BUNRUI,    -- è§ïiãÊï™
            '''' ITEM_KAISO,    -- ïiñ⁄äKëw
            '''' ITEM_NO,    -- è§ïiî‘çÜ
            '''' ITEM_NM,    -- è§ïiñº
            SUM(CASE WHEN URIAGE_SU_CNT = ''''
                THEN URIAGE_SU
                ELSE 0 END
            ) URIAGE_SU,    -- îÑè„êîó 
            '''' URIAGE_SU_CNT,    -- îÑè„êîó ÉJÉEÉìÉg
            SUM(URIAGE_GAKU) URIAGE_GAKU,    -- îÑè„ã‡äz
            SUM(CASE WHEN URIAGE_MODOSHI_SU_CNT = ''''
                THEN URIAGE_MODOSI_SU
                ELSE 0 END
            ) URIAGE_MODOSI_SU,    -- îÑè„ñﬂÇµêîó 
            '''' URIAGE_MODOSHI_SU_CNT,    -- îÑè„ñﬂÇµêîó ÉJÉEÉìÉg
            SUM(URIAGE_MODOSI_GAKU) URIAGE_MODOSI_GAKU,    -- îÑè„ñﬂÇµã‡äz
            SUM(NEBIKI_GAKU) NEBIKI_GAKU,    -- ílà¯ã‡äz
            SUM(WARIMODOSI_GAKU) WARIMODOSI_GAKU,    -- äÑñﬂã‡äz
            SUM(KOUSEN) KOUSEN,    -- å˚ëK
            SUM(KAIJYO_HOKEN_RYO_URIAGE_ENKA) KAIJYO_HOKEN_RYO_URIAGE_ENKA,    -- ï€åØóø
            -- TODO:ëóóø
            SUM(CASE WHEN JUN_URIAGE_SU_CNT = ''''
                THEN JUN_URIAGE_SU
                ELSE 0 END
            ) JUN_URIAGE_SU,    -- èÉîÑè„êîó 
            '''' JUN_URIAGE_SU_CNT,    -- èÉîÑè„êîó ÉJÉEÉìÉg
            SUM(JUN_URIAGE_GAKU) JUN_URIAGE_GAKU,    -- èÉîÑè„ã‡äz
            -- TODO:éËêîóøëº
            SUM(TATEKAE_GAKU) TATEKAE_GAKU,    -- óßë÷ã‡äz
            SUM(URIAGE_GAKU_ZEI) URIAGE_GAKU_ZEI,    -- è¡îÔê≈
            SUM(TATEKAE_GAKU_ZEI) TATEKAE_GAKU_ZEI,    -- óßë÷ã‡äzè¡îÔê≈
            SUM(TEIKA_TANKA) TEIKA_TANKA,    -- å¥âø
            SUM(URIAGE_TANKA) URIAGE_TANKA,    -- îÑè„íPâø
            AVG(GENKA_RITU) GENKA_RITU,    -- å¥âøó¶
            -- TODO:âµó¶
            AVG(NEBIKI_RITU) NEBIKI_RITU,    -- ílà¯ó¶
            ''T'' LIST_GYO_KBN    -- ÉäÉXÉgçsãÊï™
        FROM TOUGOU_DENPYO
        GROUP BY
            BMN_CD
    )
) SEIKYU_DENPYO_LIST
INNER JOIN YUKO_HANYO_MASTER BMN_MASTER    -- ïîñÂÉ}ÉXÉ^
    ON BMN_MASTER.KOMOKU_CD = ''SDZ024''
    AND BMN_MASTER.SAIMOKU_CD01 = ''10''
    AND BMN_MASTER.SAIMOKU_CD02 = SEIKYU_DENPYO_LIST.BMN_CD
LEFT OUTER JOIN YUKO_HANYO_MASTER KAMOKU_KBN_MASTER    -- â»ñ⁄ãÊï™É}ÉXÉ^
    ON KAMOKU_KBN_MASTER.KOMOKU_CD = ''SDHG0059''
    AND KAMOKU_KBN_MASTER.SAIMOKU_CD01 = SEIKYU_DENPYO_LIST.KAMOKU_KBN
LEFT OUTER JOIN SDHM026 HINMOKU_KAISOU_MASTER    -- ïiñ⁄äKëwÉ}ÉXÉ^
    ON HINMOKU_KAISOU_MASTER.ITEM_KAISO = SEIKYU_DENPYO_LIST.ITEM_KAISO
ORDER BY
    SEIKYU_DENPYO_LIST.BMN_CD,
    COALESCE(SEIKYU_DENPYO_LIST.KAMOKU_KBN, ''Z''),
    COALESCE(SEIKYU_DENPYO_LIST.ITEM_BUNRUI, ''ZZ''),
    COALESCE(SEIKYU_DENPYO_LIST.ITEM_NO, ''ZZZZZZZZZZZZZZZ'')
' 
END
GO
/****** Object:  StoredProcedure [dbo].[SDIF003_2_SELECT]    Script Date: 05/23/2013 16:02:41 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SDIF003_2_SELECT]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'
--
-- ã@î\ñºèÃ       ÅF
-- ÉvÉçÉVÉWÉÉñºèÃ ÅFSDIFXXXX
-- ã@î\ê‡ñæ       ÅF
-- à¯êîê‡ñæ       ÅF@ym ëŒè€îNåé
-- ï‘ílê‡ñæ       ÅFíäèoåãâ 
-- çÏê¨é“         ÅF2013.05.15 sakoda
-- çXêVóöó       ÅF
--
CREATE PROCEDURE [dbo].[SDIF003_2_SELECT]
    @ym char(6)
AS

-- TODO:ì˙ïtÉpÉâÉÅÅ[É^çÏê¨èàóù

    --
    -- ïœêîêÈåæ
    --
    DECLARE @year int        -- ëŒè€îN
    DECLARE @month int       -- ëŒè€åé
    DECLARE @date char(8)    -- ëŒè€îNåéì˙
    DECLARE @date2 char(10)    -- ëŒè€îNåéì˙(ÉnÉCÉtÉìãÊêÿÇË)
    DECLARE @next_year int        -- óÇîNåéÇÃîN
    DECLARE @next_month int       -- óÇîNåéÇÃåé
    DECLARE @next_date char(8)    -- óÇîNåéÇÃîNåéì˙

    --
    -- ëŒè€ì˙ïtÇÃéZèo
    --
    SET @year = CAST(substring(@ym, 0, 5) as int)
    SET @month = CAST(substring(@ym, 5, 7) as int)

    IF @month = 12
        BEGIN
            SET @next_year = @year
            SET @next_month = 1
        END
    ELSE
        BEGIN
            SET @next_year = @year
            SET @next_month = @month + 1
        END

    SET @date = cast(@year as char(4))
    SET @date2 = cast(@year as char(4))
    SET @next_date = cast(@year as char(4))

    IF @month < 10
        BEGIN
            SET @date = cast(@date as char(4)) + ''0'' + cast(@month as char(1))
            SET @date2 = cast(@date2 as char(4)) + ''-0'' + cast(@month as char(1))
        END
    ELSE
        BEGIN
            SET @date = cast(@date as char(4)) + cast(@month as char(2))
            SET @date2 = cast(@date2 as char(4)) + ''-'' + cast(@month as char(2))
        END

    IF @next_month < 10
        BEGIN
            SET @next_date = cast(@next_date as char(4)) + ''0'' + cast(@next_month as char(1))
        END
    ELSE
        BEGIN
            SET @next_date = cast(@next_date as char(4)) + cast(@next_month as char(2))
        END

    SET @date = cast(@date as char(6)) + ''01''
    SET @date2 = cast(@date2 as char(7)) + ''-01''
    SET @next_date = cast(@next_date as char(6)) + ''01'';

SET NOCOUNT ON;



WITH YUKO_HANYO_MASTER AS (
    -- óLå¯îƒópÉ}ÉXÉ^
    SELECT
      SDHM014.*
    FROM SDHM014
      INNER JOIN (
           SELECT
               KOMOKU_CD,
               SAIMOKU_CD01,
               SAIMOKU_CD02,
               SAIMOKU_CD03,
               SAIMOKU_CD04,
               SAIMOKU_CD05,
               SAIMOKU_CD06,
               SAIMOKU_CD07,
               SAIMOKU_CD08,
               SAIMOKU_CD09,
               SAIMOKU_CD10,
               MAX(YUKO_STA_YMD) YUKO_STA_YMD
           FROM SDHM014
           WHERE
               SDHM014.YUKO_STA_YMD <= ''19000101''
               AND SDHM014.YUKO_END_YMD > @next_date
           GROUP BY
               KOMOKU_CD,
               SAIMOKU_CD01,
               SAIMOKU_CD02,
               SAIMOKU_CD03,
               SAIMOKU_CD04,
               SAIMOKU_CD05,
               SAIMOKU_CD06,
               SAIMOKU_CD07,
               SAIMOKU_CD08,
               SAIMOKU_CD09,
               SAIMOKU_CD10
         ) SDHM014_MAX
        ON SDHM014.KOMOKU_CD = SDHM014_MAX.KOMOKU_CD
           AND SDHM014.SAIMOKU_CD01 = SDHM014_MAX.SAIMOKU_CD01
           AND SDHM014.SAIMOKU_CD02 = SDHM014_MAX.SAIMOKU_CD02
           AND SDHM014.SAIMOKU_CD03 = SDHM014_MAX.SAIMOKU_CD03
           AND SDHM014.SAIMOKU_CD04 = SDHM014_MAX.SAIMOKU_CD04
           AND SDHM014.SAIMOKU_CD05 = SDHM014_MAX.SAIMOKU_CD05
           AND SDHM014.SAIMOKU_CD06 = SDHM014_MAX.SAIMOKU_CD06
           AND SDHM014.SAIMOKU_CD07 = SDHM014_MAX.SAIMOKU_CD07
           AND SDHM014.SAIMOKU_CD08 = SDHM014_MAX.SAIMOKU_CD08
           AND SDHM014.SAIMOKU_CD09 = SDHM014_MAX.SAIMOKU_CD09
           AND SDHM014.SAIMOKU_CD10 = SDHM014_MAX.SAIMOKU_CD10
           AND SDHM014.YUKO_STA_YMD = SDHM014_MAX.YUKO_STA_YMD
), YUKO_TOKUISAKI AS (
    SELECT
        SDHM001.*
    FROM SDHM001
    INNER JOIN (
        SELECT
            TOKUISAKI_CD,
            MAX(YUKO_STA_YMD) YUKO_STA_YMD
        FROM SDHM001
        WHERE
            YUKO_STA_YMD <= ''19000101''
            AND YUKO_END_YMD > @next_date
        GROUP BY
            TOKUISAKI_CD
    ) LATEST
        ON LATEST.TOKUISAKI_CD = SDHM001.TOKUISAKI_CD
        AND LATEST.YUKO_STA_YMD = SDHM001.YUKO_STA_YMD
)

SELECT
    *
FROM (
    SELECT
        MEISAI.BMN_CD,    -- ïîñÂÉRÅ[Éh
        MEISAI.TOKUISAKI_CD,    -- ìæà”êÊÉRÅ[Éh
        COALESCE(MEISAI.JUCHU_NO, KURIKOSI_TIEN.JUCHU_NO) JUCHU_NO,    -- éÛíçî‘çÜ
        MEISAI.URIAGE_DD,    -- îÑè„îNåéì˙
        MEISAI.NYUKIN_YMD,    -- ì¸ã‡îNåéì˙
        MEISAI.SITE,    -- ÉTÉCÉg
        KURIKOSI_TIEN.KURIKOSI_GAKU,    -- ëOåéåJâzã‡äz
        MEISAI.URIAGE_GAKU,    -- ìñåéîÑè„ã‡äz
        MEISAI.NYUKIN,    -- ìñåéì¸ã‡äz
        MEISAI.URIAGE_GAKU - MEISAI.NYUKIN + KURIKOSI_TIEN.KURIKOSI_GAKU ZANDAKA_GAKU,    -- écçÇã‡äz
        KURIKOSI_TIEN.TIEN_GAKU,    -- íxâÑã‡äz
        ''D'' LIST_KBN    -- ÉäÉXÉgãÊï™
    FROM SDIT004 MEISAI
    FULL JOIN (
        SELECT
            JUCHU_NO,
            SUM(URIAGE_GAKU - NYUKIN) KURIKOSI_GAKU,    -- åJâzã‡äz
            SUM(
                CASE WHEN NYUKIN_YOTEI_YMD < @date2
                    THEN URIAGE_GAKU - NYUKIN
                    ELSE 0
                END
            ) TIEN_GAKU    -- íxâÑã‡äz
        FROM SDIT004
        WHERE
            SHUKEI_YM < @date2
            AND KOKUNAI_KAIGAI_KBN = ''1''
            AND KANSAI_FLG = ''0''
        GROUP BY
            JUCHU_NO
    ) KURIKOSI_TIEN
        ON KURIKOSI_TIEN.JUCHU_NO = MEISAI.JUCHU_NO
    WHERE
        MEISAI.KOKUNAI_KAIGAI_KBN = ''1''
        AND MEISAI.SHUKEI_YM = @date2

    UNION ALL
    /*** ìæà”êÊï çáåv ***/

    SELECT
        COALESCE(TOKUISAKI_TOTAL.BMN_CD, KURIKOSI_TIEN.BMN_CD) BMN_CD,    -- ïîñÂÉRÅ[Éh
        COALESCE(TOKUISAKI_TOTAL.TOKUISAKI_CD, KURIKOSI_TIEN.TOKUISAKI_CD) TOKUISAKI_CD,    -- ìæà”êÊÉRÅ[Éh
        '''' JUCHU_NO,    -- éÛíçî‘çÜ
        '''' URIAGE_DD,    -- îÑè„îNåéì˙
        '''' NYUKIN_YMD,    -- ì¸ã‡îNåéì˙
        '''' SITE,    -- ÉTÉCÉg
        SUM(KURIKOSI_TIEN.KURIKOSI_GAKU) KURIKOSI_GAKU,    -- ëOåéåJâzã‡äz
        SUM(TOKUISAKI_TOTAL.URIAGE_GAKU) URIAGE_GAKU,    -- ìñåéîÑè„ã‡äz
        SUM(TOKUISAKI_TOTAL.NYUKIN) NYUKIN,    -- ìñåéì¸ã‡äz
        SUM(TOKUISAKI_TOTAL.URIAGE_GAKU - TOKUISAKI_TOTAL.NYUKIN + KURIKOSI_TIEN.KURIKOSI_GAKU) ZANDAKA_GAKU,    -- écçÇã‡äz
        SUM(KURIKOSI_TIEN.TIEN_GAKU) TIEN_GAKU,    -- íxâÑã‡äz
        ''S1'' LIST_KBN    -- ÉäÉXÉgãÊï™
    FROM SDIT004 TOKUISAKI_TOTAL
    FULL JOIN (
        SELECT
            BMN_CD,
            TOKUISAKI_CD,
            SUM(URIAGE_GAKU - NYUKIN) KURIKOSI_GAKU,    -- åJâzã‡äz
            SUM(
                CASE WHEN NYUKIN_YOTEI_YMD < @date2
                    THEN URIAGE_GAKU - NYUKIN
                    ELSE 0
                END
            ) TIEN_GAKU    -- íxâÑã‡äz
        FROM SDIT004
        WHERE
            SHUKEI_YM < @date2
            AND KOKUNAI_KAIGAI_KBN = ''1''
            AND KANSAI_FLG = ''0''
        GROUP BY
            BMN_CD,
            TOKUISAKI_CD
    ) KURIKOSI_TIEN
        ON KURIKOSI_TIEN.BMN_CD = TOKUISAKI_TOTAL.BMN_CD
        AND KURIKOSI_TIEN.TOKUISAKI_CD = TOKUISAKI_TOTAL.TOKUISAKI_CD
    WHERE
        TOKUISAKI_TOTAL.KOKUNAI_KAIGAI_KBN = ''1''
        AND TOKUISAKI_TOTAL.SHUKEI_YM = @date2
    GROUP BY
        COALESCE(TOKUISAKI_TOTAL.BMN_CD, KURIKOSI_TIEN.BMN_CD),
        COALESCE(TOKUISAKI_TOTAL.TOKUISAKI_CD, KURIKOSI_TIEN.TOKUISAKI_CD)

    UNION ALL
    /** ëççáåv **/

    SELECT
        COALESCE(ALL_TOTAL.BMN_CD, KURIKOSI_TIEN.BMN_CD) BMN_CD,    -- ïîñÂÉRÅ[Éh
        '''' TOKUISAKI_CD,    -- ìæà”êÊÉRÅ[Éh
        '''' JUCHU_NO,    -- éÛíçî‘çÜ
        '''' URIAGE_DD,    -- îÑè„îNåéì˙
        '''' NYUKIN_YMD,    -- ì¸ã‡îNåéì˙
        '''' SITE,    -- ÉTÉCÉg
        SUM(KURIKOSI_TIEN.KURIKOSI_GAKU) KURIKOSI_GAKU,    -- ëOåéåJâzã‡äz
        SUM(ALL_TOTAL.URIAGE_GAKU) URIAGE_GAKU,    -- ìñåéîÑè„ã‡äz
        SUM(ALL_TOTAL.NYUKIN) NYUKIN,    -- ìñåéì¸ã‡äz
        SUM(ALL_TOTAL.URIAGE_GAKU - ALL_TOTAL.NYUKIN + KURIKOSI_TIEN.KURIKOSI_GAKU) ZANDAKA_GAKU,    -- écçÇã‡äz
        SUM(KURIKOSI_TIEN.TIEN_GAKU) TIEN_GAKU,    -- íxâÑã‡äz
        ''T'' LIST_KBN    -- ÉäÉXÉgãÊï™
    FROM SDIT004 ALL_TOTAL
    FULL JOIN (
        SELECT
            BMN_CD,
            SUM(URIAGE_GAKU - NYUKIN) KURIKOSI_GAKU,    -- åJâzã‡äz
            SUM(
                CASE WHEN NYUKIN_YOTEI_YMD < @date2
                    THEN URIAGE_GAKU - NYUKIN
                    ELSE 0
                END
            ) TIEN_GAKU    -- íxâÑã‡äz
        FROM SDIT004
        WHERE
            SHUKEI_YM < @date2
            AND KOKUNAI_KAIGAI_KBN = ''1''
            AND KANSAI_FLG = ''0''
        GROUP BY
            BMN_CD
    ) KURIKOSI_TIEN
        ON KURIKOSI_TIEN.BMN_CD = ALL_TOTAL.BMN_CD
    WHERE
        ALL_TOTAL.KOKUNAI_KAIGAI_KBN = ''1''
        AND ALL_TOTAL.SHUKEI_YM = @date2
    GROUP BY
        COALESCE(ALL_TOTAL.BMN_CD, KURIKOSI_TIEN.BMN_CD)
) DAICHO
LEFT OUTER JOIN YUKO_HANYO_MASTER BMN_MASTER
    ON BMN_MASTER.KOMOKU_CD = ''SDZ024''
    AND BMN_MASTER.SAIMOKU_CD01 = ''10''
    AND BMN_MASTER.SAIMOKU_CD02 = DAICHO.BMN_CD
LEFT OUTER JOIN YUKO_TOKUISAKI TOKUISAKI_MASTER
    ON TOKUISAKI_MASTER.TOKUISAKI_CD = DAICHO.TOKUISAKI_CD
ORDER BY
    DAICHO.BMN_CD,
    COALESCE(DAICHO.TOKUISAKI_CD, ''ZZZZZZZZZZ''),
    COALESCE(DAICHO.JUCHU_NO, ''ZZZZZZZZZZZZZZZ'')

' 
END
GO
/****** Object:  UserDefinedFunction [dbo].[SDFF007_SDHM014SDZ024]    Script Date: 05/23/2013 16:02:41 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SDFF007_SDHM014SDZ024]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
BEGIN
execute dbo.sp_executesql @statement = N'/**
 * ó\éZä«óù
 * 
 * óLå¯É}ÉXÉ^ÉâÉbÉpÉtÉ@ÉìÉNÉVÉáÉì
 * ëŒè€ÉeÅ[ÉuÉãÅFSDHM014 SDZ024 ïîñÂÉ}ÉXÉ^
 */
CREATE FUNCTION [dbo].[SDFF007_SDHM014SDZ024] (
	@toYMD as varchar(8)
)
RETURNS TABLE AS RETURN
	--DECLARE @toYMD as varchar(8) = ''20200101''
	SELECT * 
	FROM SDHM014 A
	WHERE KOMOKU_CD = ''SDZ024''
	  AND YUKO_STA_YMD <= @toYMD
	  AND A.YUKO_STA_YMD = (
		SELECT MAX(B.YUKO_STA_YMD) 
		FROM SDHM014 B
		WHERE B.YUKO_STA_YMD <= @toYMD
		  AND A.KOMOKU_CD = B.KOMOKU_CD
		  AND A.SAIMOKU_CD01 = B.SAIMOKU_CD01
		  AND A.SAIMOKU_CD02 = B.SAIMOKU_CD02
	  )
;
' 
END
GO
/****** Object:  UserDefinedFunction [dbo].[SDFF006_ORGANIZATIONS]    Script Date: 05/23/2013 16:02:41 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SDFF006_ORGANIZATIONS]') AND type in (N'FN', N'IF', N'TF', N'FS', N'FT'))
BEGIN
execute dbo.sp_executesql @statement = N'/**
 * ó\éZä«óù
 * 
 * ó\éZëgêDÉrÉÖÅ[
 * ëŒè€ÉeÅ[ÉuÉãÅFïîñÂÉ}ÉXÉ^ÅAâÔé–É}ÉXÉ^ÇåãçáÇµÇƒëgêDä÷òAÇÃèÓïÒÇï‘Ç∑ÉrÉÖÅ[
 */
CREATE FUNCTION [dbo].[SDFF006_ORGANIZATIONS] (
	@toYMD as varchar(8)
)
RETURNS TABLE AS RETURN

	--for test
	--DECLARE @toYMD as varchar(8) = ''20000101'';
	--

	WITH LIST(KAISHA_CD, GROUP_CD, GROUP_NAME, OYA_CD, LV, KBN)
	AS (
		SELECT 
			 SAIMOKU_CD01 AS âÔé–ÉRÅ[Éh
			,SAIMOKU_CD02 AS ïîñÂÉRÅ[Éh
			,CHR_KOMOKU03 AS ó™èÃ
			,CHR_KOMOKU05 AS êe
			,CHR_KOMOKU04 AS ïîñÂäKëwãÊï™
			,CHR_KOMOKU04 AS ïîñÂãÊï™
		FROM SDFF007_SDHM014SDZ024(@toYMD)
		WHERE SAIMOKU_CD01 = ''10''
	)
	SELECT 

		 C.SAIMOKU_CD01 AS KAISHA_CD
		,C.CHR_KOMOKU02	AS KAISHA_NAME
		,G.KAISHA_CD	AS BUMON_KAISHA_CD
		,E.GROUP_CD		AS EIGYOSHO_CD
		,E.GROUP_NAME	AS EIGYOSHO_NAME
		,B.GROUP_CD		AS BUMON_CD
		,B.GROUP_NAME	AS BUMON_NAME
		,G.GROUP_CD		AS GROUP_CD
		,G.GROUP_NAME	AS GROUP_NAME
		,B.KBN
	FROM SDHM014 C
	LEFT JOIN LIST E ON C.SAIMOKU_CD01 = E.KAISHA_CD AND E.LV = 2
	LEFT JOIN LIST B ON E.GROUP_CD = B.OYA_CD
	LEFT JOIN LIST G ON B.GROUP_CD = G.OYA_CD
	WHERE KOMOKU_CD = ''SDZ026''
	;
' 
END
GO
/****** Object:  Table [dbo].[IMJOB_QRTZ_CRON_TRIGGERS]    Script Date: 05/23/2013 16:02:43 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[IMJOB_QRTZ_CRON_TRIGGERS]') AND type in (N'U'))
BEGIN
CREATE TABLE [dbo].[IMJOB_QRTZ_CRON_TRIGGERS](
	[SCHED_NAME] [varchar](120) NOT NULL,
	[TRIGGER_NAME] [varchar](200) NOT NULL,
	[TRIGGER_GROUP] [varchar](200) NOT NULL,
	[CRON_EXPRESSION] [varchar](120) NOT NULL,
	[TIME_ZONE_ID] [varchar](80) NULL,
 CONSTRAINT [PK_IMJOB_QRTZ_CRON_TRIGGERS] PRIMARY KEY CLUSTERED 
(
	[SCHED_NAME] ASC,
	[TRIGGER_NAME] ASC,
	[TRIGGER_GROUP] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]
END
GO
SET ANSI_PADDING OFF
GO
/****** Object:  View [dbo].[sdfg015j]    Script Date: 05/23/2013 16:02:44 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[sdfg015j]'))
EXEC dbo.sp_executesql @statement = N'CREATE VIEW [dbo].[sdfg015j]
AS 
	--ó\éZä«óùÅFîNä‘êîó äTéZî≠çsàÍóóéÊìæ
	WITH LIST(
		 HINMOKU_KBN
		,TOKUISAKI_NAME
		,SEIZO_KATASIKI
		,HANBAI_KOSHO
		,HAN_NO
		,Q1
		,Q2
		,Q3
		,Q4
	)
	AS (
		SELECT
			 H.CHR_KOMOKU14			--ïiñ⁄ëÆê´3Åuïiñ⁄ãÊï™Åv
			,K.TOKUISAKI_NM_RYAKU	--ìæà”êÊó™èÃ
			,T.SEIZO_KATASIKI		--êªë¢å^éÆ
			,H.HANBAI_KOSHO			--îÃîÑåƒèÃ
			,T.HAN_NO
			,COALESCE(SUM(GAKU_SU_APR),0) + COALESCE(SUM(GAKU_SU_MAY),0) + COALESCE(SUM(GAKU_SU_JUN),0)  AS Q1
			,COALESCE(SUM(GAKU_SU_JUL),0) + COALESCE(SUM(GAKU_SU_AUG),0) + COALESCE(SUM(GAKU_SU_SEP),0)  AS Q2
			,COALESCE(SUM(GAKU_SU_OCT),0)	+ COALESCE(SUM(GAKU_SU_NOV),0) + COALESCE(SUM(GAKU_SU_DEC),0)  AS Q3
			,COALESCE(SUM(GAKU_SU_JAN),0) + COALESCE(SUM(GAKU_SU_FEB),0) + COALESCE(SUM(GAKU_SU_MAR),0) AS Q4
		FROM SDFT002 T --îÑè„ó\éZT
		INNER JOIN SDFF005_HINMOKU(''20120401'') H	--ïiñ⁄
		ON  T.KAISHA_CD = H.KAISHA_CD
		AND T.GRP_CD = H.BMN_CD
		AND T.SEIZO_KATASIKI = H.SHOHIN_NO

		INNER JOIN SDFF003_SDHM001(''20120401'') K	--ìæà”êÊM
		ON T.KAISHA_CD = K.KAISHA_CD
		AND T.TOKUISAKI_CD = K.TOKUISAKI_CD

		WHERE T.GAKU_SU_KBN = ''3''	--3:îÑè„êîó 
		  AND T.NENDO = ''2013''
		  AND T.YOSAN_KBN = ''1''
		  AND (T.HAN_NO = 0 OR T.HAN_NO = 1)
		  AND T.KAISHA_CD = ''10''
		  --AND T.GRP_CD IN /*groupList*/() 
		GROUP BY 
			 H.CHR_KOMOKU14			--ïiñ⁄ëÆê´3Åuïiñ⁄ãÊï™Åv
			,K.TOKUISAKI_NM_RYAKU	--ìæà”êÊó™èÃ
			,T.SEIZO_KATASIKI		--êªë¢å^éÆ
			,H.HANBAI_KOSHO			--îÃîÑåƒèÃ
			,T.HAN_NO
	)
	SELECT 
		 COALESCE(A.HINMOKU_KBN, B.HINMOKU_KBN) AS HINMOKU_KBN
		,COALESCE(A.TOKUISAKI_NAME, B.TOKUISAKI_NAME) AS TOKUISAKI_NAME
		,COALESCE(A.SEIZO_KATASIKI, B.SEIZO_KATASIKI) AS SEIZO_KATASIKI
		,COALESCE(A.HANBAI_KOSHO, B.HANBAI_KOSHO) AS HANBAI_KOSHO
		,A.Q1
		,A.Q2
		,A.Q3
		,A.Q4
		,B.Q1 AS HIKAKUQ1
		,B.Q2 AS HIKAKUQ2
		,B.Q3 AS HIKAKUQ3
		,B.Q4 AS HIKAKUQ4
	FROM (SELECT * FROM LIST WHERE HAN_NO = 1) A
	FULL OUTER JOIN (SELECT * FROM LIST WHERE HAN_NO = 0) B
	ON A.HINMOKU_KBN = B.HINMOKU_KBN
	AND A.TOKUISAKI_NAME = B.TOKUISAKI_NAME
	AND A.SEIZO_KATASIKI = B.SEIZO_KATASIKI
	AND A.HANBAI_KOSHO = B.HANBAI_KOSHO
'
GO